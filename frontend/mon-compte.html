<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mon compte fid√©lit√©</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header class="container center">
    <img src="./assets/logo.png" alt="Chez Tonton Moh" class="logo" />
    <h1>Mon compte fid√©lit√©</h1>
  </header>

  <main class="container">
    <section class="card" id="card">
      <div id="content">
        <p class="muted">Chargement‚Ä¶</p>
      </div>
    </section>
  </main>

  <!-- qrcodejs pour g√©n√©rer le QR brut -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    const API = 'https://tontonmoh-api.azizekarma.workers.dev';

    const elContent = document.getElementById('content');
    const p = new URLSearchParams(location.search);
    const codeFromUrl = (p.get('code') || '').trim().toUpperCase();

    function euros(cents){ return (Number(cents||0)/100).toFixed(2) + ' ‚Ç¨'; }
    function showError(msg){ elContent.innerHTML = `<p class="error">${msg}</p>`; }

    function txRow(tx){
      const sign = tx.status === 'OK' ? '+' : '¬±';
      const dt = new Date(tx.created_at || tx.createdAt || tx.ts || Date.now());
      const date = dt.toLocaleString();
      return `
        <tr>
          <td style="white-space:nowrap">${date}</td>
          <td>${tx.status}</td>
          <td style="text-align:right">${sign} ${euros(tx.amount_cents)}</td>
          <td class="muted">${tx.note ? tx.note : ''}</td>
        </tr>`;
    }

    async function main(){
      if (!codeFromUrl){
        showError('Aucun code fourni. Ouvrez cette page via ‚ÄúAcc√©der √† mon compte‚Äù.');
        return;
      }

      try{
        // 1) Client + solde
        const rCli = await fetch(`${API}/api/clients/by-code/${encodeURIComponent(codeFromUrl)}`);
        if (!rCli.ok) throw new Error('Client introuvable');
        const cli = await rCli.json();

        // 2) Transactions (derni√®res 20)
        const rTx = await fetch(`${API}/api/transactions?client_id=${encodeURIComponent(cli.id)}&limit=20`);
        const txs = rTx.ok ? await rTx.json() : [];

        const fullName = `${cli.first_name || ''} ${cli.last_name || ''}`.trim() || 'Client';

        // 3) HTML de la page (avec image finale + div cach√©e pour le QR brut)
        elContent.innerHTML = `
          <div class="grid">
            <div>
              <h2 style="margin-top:0">${fullName}</h2>
              <p class="muted kv">Code : <b id="codePublic">${cli.code_public}</b></p>
              <p class="kv">Cumul : <b>${euros(cli.balance)}</b></p>
              <p class="kv">Cadeaux obtenus : <b>${cli.gifts_count}</b></p>
            </div>

            <div>
              <h3 style="margin-top:0">Mon QR</h3>
              <div class="qr-wrapper">
                <!-- image finale styl√©e -->
                <img id="qrFinal" alt="QR fid√©lit√© TontonMoh" />
                <!-- zone cach√©e pour le QR brut -->
                <div id="qrRaw" style="display:none"></div>
              </div>
              <p id="codeText">Code : <b>${cli.code_public}</b></p>
              <p><a id="dlQR" class="btn" href="#" download="${cli.code_public}.png" style="display:none">T√©l√©charger le QR</a></p>
            </div>
          </div>

          <hr class="muted">

          <h3>Mes derniers passages</h3>
          ${
            (txs && txs.length)
            ? `<div style="overflow:auto">
                 <table style="width:100%; border-collapse:collapse">
                   <thead>
                     <tr>
                       <th style="text-align:left">Date</th>
                       <th style="text-align:left">Statut</th>
                       <th style="text-align:right">Montant</th>
                       <th style="text-align:left">Note</th>
                     </tr>
                   </thead>
                   <tbody>
                     ${txs.map(txRow).join('')}
                   </tbody>
                 </table>
               </div>`
            : `<p class="muted">Aucune transaction pour le moment.</p>`
          }

          <p class="muted" style="margin-top:12px">
            Conseil : gardez votre QR, chaque achat vous rapproche d‚Äôun cadeau üéÅ
          </p>
        `;

        // 4) G√©n√©rer la m√™me carte styl√©e que sur merci.html
        const qrFinal = document.getElementById('qrFinal');
        const qrRaw   = document.getElementById('qrRaw');
        const dlQR    = document.getElementById('dlQR');
        const codePublic = cli.code_public;

        generateStyledQr(codePublic, qrRaw)
          .then((dataUrl)=>{
            qrFinal.src = dataUrl;
            dlQR.href   = dataUrl;
            dlQR.style.display = 'inline-block';
          })
          .catch((e)=>{
            console.error(e);
            qrRaw.innerHTML = '<p class="error">Impossible de g√©n√©rer le QR.</p>';
          });

      }catch(err){
        console.error(err);
        showError('Erreur : ' + err.message);
      }
    }

    // --------- m√™me fonction que dans merci.html ---------
    function generateStyledQr(code, qrRawEl) {
      return new Promise((resolve, reject) => {
        qrRawEl.innerHTML = '';

        // QR brut
        const qr = new QRCode(qrRawEl, {
          text: code,
          width: 480,
          height: 480,
          correctLevel: QRCode.CorrectLevel.H,
        });

        setTimeout(() => {
          const qrImg = qrRawEl.querySelector('img') || qrRawEl.querySelector('canvas');
          if (!qrImg) {
            reject(new Error('QR brut introuvable'));
            return;
          }

          const CARD_W = 1200;
          const CARD_H = 1700;
          const canvas = document.createElement('canvas');
          canvas.width  = CARD_W;
          canvas.height = CARD_H;
          const ctx = canvas.getContext('2d');

          // Fond noir
          ctx.fillStyle = '#000000';
          ctx.fillRect(0, 0, CARD_W, CARD_H);

          // Bloc blanc en haut (QR uniquement)
          const marginX = 70;
          const marginY = 80;
          const whiteHeight = 980;

          ctx.fillStyle = '#ffffff';
          roundedRect(ctx, marginX, marginY, CARD_W - 2 * marginX, whiteHeight, 72);
          ctx.fill();

          // QR centr√©
          const qrSize = whiteHeight - 220;
          const qrX = (CARD_W - qrSize) / 2;
          const qrY = marginY + (whiteHeight - qrSize) / 2;

          const qrCanvas = document.createElement('canvas');
          qrCanvas.width = qrSize;
          qrCanvas.height = qrSize;
          const qrCtx = qrCanvas.getContext('2d');

          const imgObj = new Image();
          imgObj.onload = () => {
            qrCtx.drawImage(imgObj, 0, 0, qrSize, qrSize);
            ctx.drawImage(qrCanvas, qrX, qrY);

            // Logo au centre 
            const logo = new Image();
            logo.src = './assets/logo.png';
            logo.onload = () => {
              const logoSize = qrSize * 0.27;
              const logoX = CARD_W / 2 - logoSize / 2;
              const logoY = qrY + qrSize / 2 - logoSize / 2;

              ctx.save();
              ctx.beginPath();
              ctx.arc(CARD_W / 2, qrY + qrSize / 2, logoSize / 2 + 10, 0, Math.PI * 2);
              ctx.closePath();
              ctx.fillStyle = '#ffffff';
              ctx.fill();
              ctx.drawImage(logo, logoX, logoY, logoSize, logoSize);
              ctx.restore();

              // Ic√¥ne + texte dans la bande noire
              const whiteBottom = marginY + whiteHeight;
              const bandTop = whiteBottom + 60;

              const iconSize = 220;
              const iconX = CARD_W / 2 - 260;
              const iconY = bandTop + 40;

              const icon = new Image();
              icon.src = './assets/icon.png';
              icon.onload = () => {
                ctx.drawImage(icon, iconX, iconY, iconSize, iconSize);

                ctx.fillStyle = '#ffffff';
                ctx.textAlign = 'left';
                ctx.font = '64px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
                const textY = iconY + iconSize / 2 + 22;
                ctx.fillText('Tontonmoh', iconX + iconSize + 40, textY);

                const dataUrl = canvas.toDataURL('image/png');
                resolve(dataUrl);
              };
              icon.onerror = () => reject(new Error('icon.png introuvable'));
            };
            logo.onerror = () => reject(new Error('logo.png introuvable'));
          };
          imgObj.onerror = () => reject(new Error('Image QR brute introuvable'));

          imgObj.src = qrImg.src || (qrImg.toDataURL && qrImg.toDataURL());
        }, 60);
      });
    }

    function roundedRect(ctx, x, y, w, h, r) {
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.lineTo(x + w - r, y);
      ctx.quadraticCurveTo(x + w, y, x + w, y + r);
      ctx.lineTo(x + w, y + h - r);
      ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
      ctx.lineTo(x + r, y + h);
      ctx.quadraticCurveTo(x, y + h, x, y + h - r);
      ctx.lineTo(x, y + r);
      ctx.quadraticCurveTo(x, y, x + r, y);
      ctx.closePath();
    }

    main();
  </script>
</body>
</html>
