<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mon compte fid√©lit√©</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header class="container center">
    <img src="./assets/logo.png" alt="Chez Tonton Moh" class="logo" />
    <h1>Mon compte fid√©lit√©</h1>
  </header>

  <main class="container">
    <section class="card" id="card">
      <div id="content">
        <p class="muted">Chargement‚Ä¶</p>
      </div>
    </section>

    <!-- Popin d'informations compte fid√©lit√© -->
    <div id="infoModal" class="info-modal">
      <div class="info-modal-content card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px">
          <h3 style="margin:0">Infos sur votre compte fid√©lit√©</h3>
          <button id="infoClose" type="button" class="icon-btn close-circle" aria-label="Fermer">
            ‚úï
          </button>

        </div>
    
        <p>
          <strong>Date de cr√©ation du compte :</strong>
          <span id="infoCreated">‚Äî</span>
        </p>
    
        <hr class="muted" />
    
        <h4>Comment √ßa fonctionne ?</h4>
        <ul class="info-list">
          <li>√Ä chaque passage en caisse, votre <strong>QR code</strong> est scann√© ou votre <strong>code √† 6 caract√®res</strong> est saisi.</li>
          <li>Vous pouvez aussi utiliser un <strong>badge RFID</strong> au lieu du QR code.</li>
          <li>Chaque achat cr√©dite un <strong>pourcentage en cagnotte</strong> (solde fid√©lit√©) calcul√© sur le montant pay√©.</li>
          <li>Votre <strong>cumul d‚Äôachats</strong> est la somme de tous vos passages en caisse.</li>
          <li>Vous pouvez utiliser votre <strong>solde cagnotte</strong> pour diminuer √† tout moment le montant √† payer.</li>
          <li>Le caissier peut soit scanner le QR, soit taper le code √† 6 caract√®res, soit badger votre carte RFID.</li>
        </ul>
      </div>
    </div>


  </main>

  <!-- qrcodejs pour g√©n√©rer le QR brut -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    const API = 'https://tontonmoh-api.azizekarma.workers.dev';
    const LS_LAST_RECEIPT = 'tm_last_receipt'; // dernier ticket m√©moris√© par la caisse


    const elContent = document.getElementById('content');
    const infoModal     = document.getElementById('infoModal');
    const infoClose     = document.getElementById('infoClose');
    const infoCreatedEl = document.getElementById('infoCreated');
    const infoLastTxEl  = document.getElementById('infoLastTx');

    const p = new URLSearchParams(location.search);
    const codeFromUrl = (p.get('code') || '').trim().toUpperCase();

    function euros(cents){
      return (Number(cents || 0) / 100)
        .toFixed(2)           // 12.50
        .replace('.', ',')    // 12,50
        + ' ‚Ç¨';
    }

    function showError(msg){ elContent.innerHTML = `<p class="error">${msg}</p>`; }

    function formatDateTime(dt) {
      if (!dt) return '‚Äî';
      const d = new Date(dt);
      const pad = (n) => String(n).padStart(2, '0');
      const date = `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
      const time = `${pad(d.getHours())}:${pad(d.getMinutes())}`;
      return `${date} √† ${time}`;
    }

    // --- Helpers pour affichage historique en 2 lignes ---
    
    // QR / RFID / ADMIN en fonction de la note
    function txMode(tx) {
      const note = (tx.note || '').toLowerCase();
      if (note.includes('rfid'))   return 'RFID';
      if (note.includes('[admin')) return 'ADMIN';
      return 'QR';
    }
    
    // Cagnotte gagn√©e sur ce passage (10% par exemple)
    const BONUS_RATE = 0.10;
    function bonusForTx(amount_cents) {
      return Math.round(Number(amount_cents || 0) * BONUS_RATE);
    }
    
    function txRow(tx){
      const sign = tx.status === 'OK' ? '+' : '¬±';
      const dt   = new Date(tx.created_at || tx.createdAt || tx.ts || Date.now());
      const pad  = n => String(n).padStart(2, '0');
    
      const date = `${pad(dt.getDate())}/${pad(dt.getMonth()+1)}/${dt.getFullYear()}`;
      const time = `${pad(dt.getHours())}:${pad(dt.getMinutes())}:${pad(dt.getSeconds())}`;
    
      const mode      = txMode(tx);                       // QR / RFID / ADMIN
      const amountStr = `${sign} ${euros(tx.amount_cents)}`;
      const bonusStr  = euros(bonusForTx(tx.amount_cents));
      const note      = tx.note ? ` ‚Äî ${tx.note}` : '';
    
      return `
        <tr class="tx-row">
          <td colspan="3">
            <div class="tx-box">
              <div class="tx-grid">
                <div class="tx-date">${date}</div>
                <div class="tx-mode">${mode}</div>
                <div class="tx-amount">${amountStr} / ${bonusStr}</div>
                <div class="tx-subline">${time}${note}</div>
              </div>
            </div>
          </td>
        </tr>`;
    }


    function renderInfoLastTx(txs) {
      if (!infoLastTxEl) return;
      if (!txs || !txs.length) {
        infoLastTxEl.innerHTML = '<p class="muted">Pas encore de passage enregistr√©.</p>';
        return;
      }
      const pad = (n) => String(n).padStart(2, '0');
      const html = `
        <ul class="info-list">
          ${txs.slice(0,5).map(tx => {
            const d = new Date(tx.created_at || tx.createdAt || tx.ts || Date.now());
            const date = `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
            const time = `${pad(d.getHours())}:${pad(d.getMinutes())}`;
            const mode = txMode(tx);
            const amount = euros(tx.amount_cents);
            const bonus = euros(bonusForTx(tx.amount_cents));
            return `<li><strong>${date} ${time}</strong> ‚Äî ${mode} ‚Äî ${amount} / ${bonus}</li>`;
          }).join('')}
        </ul>`;
      infoLastTxEl.innerHTML = html;
    }
    
    

    async function main(){
      if (!codeFromUrl){
        showError('Aucun code fourni. Ouvrez cette page via ‚ÄúAcc√©der √† mon compte‚Äù.');
        return;
      }

      try{
        // 1) Client + solde
        const rCli = await fetch(`${API}/api/clients/by-code/${encodeURIComponent(codeFromUrl)}`);
        if (!rCli.ok) throw new Error('Client introuvable');
        const cli = await rCli.json();

        // 2) Transactions (derni√®res 20)
        const rTx = await fetch(`${API}/api/transactions?client_id=${encodeURIComponent(cli.id)}&limit=20`);
        const txs = rTx.ok ? await rTx.json() : [];

        const fullName = `${cli.first_name || ''} ${cli.last_name || ''}`.trim() || 'Client';

        // === calcul ancien / nouveau solde cagnotte ===
        const totalCents = Number(cli.total_spent_cents || 0);
        
        // par d√©faut : les deux √©gaux au solde actuel
        let newBonusCents = Number(cli.bonus_cents || 0);
        let oldBonusCents = newBonusCents;
        
        // si on a au moins une transaction, on regarde la derni√®re
        if (txs && txs.length) {
          const last = txs[0]; // la requ√™te est ORDER BY rowid DESC
        
          if (last && last.status === 'OK') {
            if (typeof last.previous_bonus_cents === 'number') {
              oldBonusCents = Number(last.previous_bonus_cents || 0);
            }
            if (typeof last.new_bonus_cents === 'number') {
              newBonusCents = Number(last.new_bonus_cents || newBonusCents);
            }
          }
        }

        // remplir la popin : date de cr√©ation + derniers passages
        if (infoCreatedEl) {
          const created = cli.created_at || cli.createdAt || cli.created || null;
          infoCreatedEl.textContent = created ? formatDateTime(created) : 'Non disponible';
        }

        renderInfoLastTx(txs);


        // 3) HTML de la page (avec image finale + div cach√©e pour le QR brut)
        elContent.innerHTML = `
          <div class="grid">
            <div>
              <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
                <h2 style="margin-top:0">${fullName}</h2>
                <!-- bouton infos -->
                <button id="infoBtn" class="icon-btn info-circle" type="button" aria-label="Infos sur le compte fid√©lit√©">
                  i
                </button>

              </div>
              <p class="muted kv">Code : <b id="codePublic">${cli.code_public}</b></p>
              <p class="kv">Cumul achats : <b>${euros(totalCents)}</b></p>
              <p class="kv">Ancien solde cagnotte : <b>${euros(oldBonusCents)}</b></p>
              <p class="kv">Nouveau solde cagnotte : <b>${euros(newBonusCents)}</b></p>
            </div>

            <div class="center">
              <h3 style="margin-top:0">Mon QR</h3>
              <div class="qr-wrapper">
                <!-- image finale styl√©e -->
                <img id="qrFinal" alt="QR fid√©lit√© TontonMoh" />
                <!-- zone cach√©e pour le QR brut -->
                <div id="qrRaw" style="display:none"></div>
              </div>
              <p id="codeText" style="display:none">Code : <b>${cli.code_public}</b></p>
              <p><a id="dlQR" class="btn" href="#" download="${cli.code_public}.png" style="display:none">T√©l√©charger le QR</a></p>
            </div>
          </div>

          <hr class="muted">

          <h3>Mes derniers passages</h3>
          ${
            (txs && txs.length)
            ? `<div style="overflow:auto">
                 <table class="history">
                   <thead>
                     <tr>
                       <th>Date</th>
                       <th>Source</th>
                       <th>Montant / Cagnotte</th>
                     </tr>
                   </thead>
                   <tbody>
                     ${txs.map(txRow).join('')}
                   </tbody>
                 </table>
               </div>`
            : `<p class="muted">Aucune transaction pour le moment.</p>`
          }

          <p class="muted" style="margin-top:12px">
            Conseil : gardez votre QR, chaque achat augmente votre cagnotte üí∂
          </p>
        `;

        // bouton "i" pour ouvrir la popin + petit √©crasement
        const infoBtn = document.getElementById('infoBtn');
        if (infoBtn && infoModal) {
          infoBtn.addEventListener('click', () => {
            // on force l'√©tat √©cras√©
            infoBtn.classList.add('pressed');
        
            // on laisse 80 ms pour voir l'effet puis on ouvre la popin
            setTimeout(() => {
              infoBtn.classList.remove('pressed');
              infoModal.classList.add('show');
            }, 100);
          });
        }



        // 4) G√©n√©rer la m√™me carte styl√©e que sur merci.html
        const qrFinal = document.getElementById('qrFinal');
        const qrRaw   = document.getElementById('qrRaw');
        const dlQR    = document.getElementById('dlQR');
        const codePublic = cli.code_public;

        generateStyledQr(codePublic, qrRaw)
          .then((dataUrl)=>{
            qrFinal.src = dataUrl;
            dlQR.href   = dataUrl;
            dlQR.style.display = 'inline-block';
          })
          .catch((e)=>{
            console.error(e);
            qrRaw.innerHTML = '<p class="error">Impossible de g√©n√©rer le QR.</p>';
          });

      }catch(err){
        console.error(err);
        showError('Erreur : ' + err.message);
      }
    }

    // --------- copie du style "carte" de merci.html ---------
    function generateStyledQr(code, qrRawEl) {
      return new Promise((resolve, reject) => {
        qrRawEl.innerHTML = '';
    
        // 1) QR brut
        new QRCode(qrRawEl, {
          text: code,
          width: 480,
          height: 480,
          correctLevel: QRCode.CorrectLevel.H,
        });
    
        let tries = 0;
        const MAX_TRIES = 25; // 25 * 100 ms = 2,5 s max
    
        function waitForQr() {
          const qrImg = qrRawEl.querySelector('img, canvas');
    
          // pas encore g√©n√©r√© ‚Üí on attend
          if (!qrImg) {
            if (tries++ > MAX_TRIES) {
              reject(new Error('QR brut introuvable'));
              return;
            }
            setTimeout(waitForQr, 100);
            return;
          }
    
          // R√©cup√©rer la source du QR (img ou canvas)
          let src = '';
          if (qrImg.tagName === 'IMG') {
            src = qrImg.src || '';
          } else if (qrImg.tagName === 'CANVAS') {
            try {
              src = qrImg.toDataURL('image/png');
            } catch (e) {
              console.error('toDataURL error', e);
            }
          }
    
          if (!src) {
            if (tries++ > MAX_TRIES) {
              reject(new Error('Source QR invalide'));
              return;
            }
            setTimeout(waitForQr, 100);
            return;
          }
    
          // Quand on a la source, on continue avec le dessin de la carte
          const imgObj = new Image();
          imgObj.onload  = () => drawWalletCard(imgObj, code, resolve, reject);
          imgObj.onerror = () => reject(new Error('Image QR brute introuvable'));
          imgObj.src = src;
        }
    
        waitForQr();
      });
    }
    
    // Dessine la carte "fa√ßon Apple Wallet" (m√™me que merci.html)
    function drawWalletCard(qrImage, code, resolve, reject) {
      const CARD_W = 1200;
      const CARD_H = 1700;
      const canvas = document.createElement('canvas');
      canvas.width  = CARD_W;
      canvas.height = CARD_H;
      const ctx = canvas.getContext('2d');
    
      // Fond noir
      ctx.fillStyle = '#000000';
      ctx.fillRect(0, 0, CARD_W, CARD_H);
    
      // Bloc blanc en haut (pour le QR seulement)
      const marginX = 55;
      const marginY = 60;
      const whiteHeight = 1100; // hauteur du bloc blanc
    
      ctx.fillStyle = '#ffffff';
      roundedRect(ctx, marginX, marginY, CARD_W - 2 * marginX, whiteHeight, 72);
      ctx.fill();
    
      // QR centr√© dans le bloc blanc
      const qrSize = whiteHeight - 220;
      const qrX = (CARD_W - qrSize) / 2;
      const qrY = marginY + (whiteHeight - qrSize) / 2;
    
      ctx.drawImage(qrImage, qrX, qrY, qrSize, qrSize);
    
      // 3) Logo au centre du QR, sur un carr√© blanc
      const logo = new Image();
      logo.src = './assets/logo.png';
      logo.onload = () => {
        const logoSize = qrSize * 0.27;          // taille r√©elle du logo
        const padding  = 20;                     // marge blanche autour du logo
        const bgSize   = logoSize + padding * 2; // taille du carr√© blanc
      
        // Position du carr√© blanc (centr√© dans le QR)
        const bgX = CARD_W / 2 - bgSize / 2;
        const bgY = qrY + qrSize / 2 - bgSize / 2;
      
        // Position du logo (centr√© dans le carr√©)
        const logoX = CARD_W / 2 - logoSize / 2;
        const logoY = qrY + qrSize / 2 - logoSize / 2;
      
        // Fond carr√© blanc (coins l√©g√®rement arrondis)
        ctx.fillStyle = '#ffffff';
        roundedRect(ctx, bgX, bgY, bgSize, bgSize, 24); // 24 = rayon des coins
        ctx.fill();
      
        // Logo par-dessus
        ctx.drawImage(logo, logoX, logoY, logoSize, logoSize);
    
        // 4) Code au milieu puis ic√¥ne t√©l√©phone + texte Tontonmoh dans la bande noire
        const whiteBottom = marginY + whiteHeight;
        
        // --- TEXTE "Code : XXXXX" entre le QR et l'ic√¥ne ---
        ctx.fillStyle = '#ffffff';
        ctx.textAlign = 'center';
        ctx.font = '64px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
        
        const codeY = whiteBottom + 80;
        ctx.fillText('Code : ' + code, CARD_W / 2, codeY);
        
        // --- Ic√¥ne + "Tontonmoh" plus bas ---
        const bandTop = codeY + 80; // d√©cale l'ic√¥ne sous le code
        
        const iconSize = 200;
        const iconX = CARD_W / 2 - 550;
        const iconY = bandTop + 30;
    
        const icon = new Image();
        icon.src = './assets/icon.png';
        icon.onload = () => {
          ctx.drawImage(icon, iconX, iconY, iconSize, iconSize);
    
          ctx.fillStyle = '#ffffff';
          ctx.textAlign = 'left';
          ctx.font = '150px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
    
          const textY = iconY + iconSize / 2 + 40;
          ctx.fillText('Tontonmoh', iconX + iconSize + 50, textY);
    
          const dataUrl = canvas.toDataURL('image/png');
          resolve(dataUrl);
        };
        icon.onerror = () => reject(new Error('icon.png introuvable'));
      };
      logo.onerror = () => reject(new Error('logo.png introuvable'));
    }


    function roundedRect(ctx, x, y, w, h, r) {
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.lineTo(x + w - r, y);
      ctx.quadraticCurveTo(x + w, y, x + w, y + r);
      ctx.lineTo(x + w, y + h - r);
      ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
      ctx.lineTo(x + r, y + h);
      ctx.quadraticCurveTo(x, y + h, x, y + h - r);
      ctx.lineTo(x, y + r);
      ctx.quadraticCurveTo(x, y, x + r, y);
      ctx.closePath();
    }

    if (infoClose && infoModal) {
      // bouton "Fermer"
      infoClose.addEventListener('click', () => {
        // on force l'√©tat √©cras√©
        infoClose.classList.add('pressed');
    
        // on laisse 80 ms pour voir l'effet, puis on ferme la popin
        setTimeout(() => {
          infoModal.classList.remove('show');
          infoClose.classList.remove('pressed');
        }, 80);
      });
    
      // clic sur le fond gris autour de la box
      infoModal.addEventListener('click', (e) => {
        if (e.target === infoModal) {
          infoModal.classList.remove('show');
        }
      });
    }


    main();
  </script>
</body>
</html>
