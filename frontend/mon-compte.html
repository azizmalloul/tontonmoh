<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mon compte fid√©lit√©</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header class="container center">
    <img src="./assets/logo.png" alt="Chez Tonton Moh" class="logo" />
    <h1>Mon compte fid√©lit√©</h1>
  </header>

  <main class="container">
    <section class="card" id="card">
      <div id="content">
        <p class="muted">Chargement‚Ä¶</p>
      </div>
    </section>
  </main>

  <!-- qrcodejs pour g√©n√©rer le QR si l'image statique n'existe pas -->
  
  <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>

  <script>
    const API = 'https://tontonmoh-api.azizekarma.workers.dev';

    const elContent = document.getElementById('content');
    const p = new URLSearchParams(location.search);
    const code = (p.get('code') || '').trim().toUpperCase();

    function euros(cents){ return (Number(cents||0)/100).toFixed(2) + ' ‚Ç¨'; }
    function showError(msg){ elContent.innerHTML = `<p class="error">${msg}</p>`; }
    function txRow(tx){
      const sign = tx.status === 'OK' ? '+' : '¬±';
      const dt = new Date(tx.created_at || tx.createdAt || tx.ts || Date.now());
      const date = dt.toLocaleString();
      return `
        <tr>
          <td style="white-space:nowrap">${date}</td>
          <td>${tx.status}</td>
          <td style="text-align:right">${sign} ${euros(tx.amount_cents)}</td>
          <td class="muted">${tx.note ? tx.note : ''}</td>
        </tr>`;
    }

    async function main(){
      if (!code){ showError('Aucun code fourni. Ouvrez cette page via ‚ÄúAcc√©der √† mon compte‚Äù.'); return; }

      try{
        // 1) Client + solde
        const rCli = await fetch(`${API}/api/clients/by-code/${encodeURIComponent(code)}`);
        if (!rCli.ok) throw new Error('Client introuvable');
        const cli = await rCli.json();

        // 2) Transactions (derni√®res 20)
        const rTx = await fetch(`${API}/api/transactions?client_id=${encodeURIComponent(cli.id)}&limit=20`);
        const txs = rTx.ok ? await rTx.json() : [];

        // 3) Affichage (grille 2 colonnes sur desktop)
        const full = `${cli.first_name || ''} ${cli.last_name || ''}`.trim() || 'Client';
        elContent.innerHTML = `
          <div class="grid">
            <div>
              <h2 style="margin-top:0">${full}</h2>
              <p class="muted kv">Code : <b id="codePublic">${cli.code_public}</b></p>
              <p class="kv">Cumul : <b>${euros(cli.balance)}</b></p>
              <p class="kv">Cadeaux obtenus : <b>${cli.gifts_count}</b></p>
            </div>

            <div>
              <h3 style="margin-top:0">Mon QR</h3>
              <div class="qr-wrapper">
                <img id="qrImg" alt="QR fid√©lit√©" style="display:none" />
                <div id="qrBox"></div>
              </div>
              <p id="codeText">Code : <b>${cli.code_public}</b></p>
              <p><a id="dlQR" class="btn" href="#" download="${cli.code_public}.png" style="display:none">T√©l√©charger le QR</a></p>
            </div>
          </div>

          <hr class="muted">

          <h3>Mes derniers passages</h3>
          ${
            (txs && txs.length)
            ? `<div style="overflow:auto">
                 <table style="width:100%; border-collapse:collapse">
                   <thead>
                     <tr>
                       <th style="text-align:left">Date</th>
                       <th style="text-align:left">Statut</th>
                       <th style="text-align:right">Montant</th>
                       <th style="text-align:left">Note</th>
                     </tr>
                   </thead>
                   <tbody>
                     ${txs.map(txRow).join('')}
                   </tbody>
                 </table>
               </div>`
            : `<p class="muted">Aucune transaction pour le moment.</p>`
          }

          <p class="muted" style="margin-top:12px">
            Conseil : gardez votre QR, chaque achat vous rapproche d‚Äôun cadeau üéÅ
          </p>
        `;

        // 4) QR "pro" avec logo au centre (style classique, lisible)
        const box        = document.getElementById('qrBox');
        const dl         = document.getElementById('dlQR');
        const codePublic = cli.code_public;

        const qr = new QRCodeStyling({
          width: 420,
          height: 420,
          type: "svg",
          data: codePublic,
          qrOptions: {
            errorCorrectionLevel: "H",
            margin: 8
          },
          image: "./assets/logo.png",
          dotsOptions: {
            color: "#000000",
            type: "square"
          },
          cornersSquareOptions: {
            type: "square",
            color: "#000000"
          },
          cornersDotOptions: {
            type: "square",
            color: "#000000"
          },
          backgroundOptions: {
            color: "#ffffff"
          },
          imageOptions: {
            crossOrigin: "anonymous",
            margin: 10,
            imageSize: 0.28
          }
        });

        // Afficher le QR
        qr.append(box);

        // Pr√©parer le bouton "T√©l√©charger le QR"
        qr.getRawData("png").then(blob => {
          const url = URL.createObjectURL(blob);
          dl.href = url;
          dl.style.display = "inline-block";
        }).catch(e => {
          console.error(e);
        });



      }catch(err){
        console.error(err);
        showError('Erreur : ' + err.message);
      }
    }

    main();
  </script>
</body>
</html>
