<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Merci ‚Äî Carte fid√©lit√©</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header class="container center">
    <img src="./assets/logo.png" alt="Chez Tonton Moh" class="logo" />
    <h1>Votre carte fid√©lit√© est pr√™te üéâ</h1>
  </header>

  <main class="container card center">
    <p class="banner">Version V2 ‚Äî Enregistrez l'image du QR (nouveau design).</p>

    <div class="qr-wrapper">
      <!-- image finale styl√©e -->
      <img id="qrFinal" alt="QR fid√©lit√© TontonMoh" />

      <!-- zone cach√©e pour g√©n√©rer le QR brut -->
      <div id="qrRaw" style="display:none"></div>
    </div>

    <p id="codeText" class="muted"></p>

    <h2>Comment √ßa marche ?</h2>
    <ol class="container" style="text-align:left">
      <li>√Ä chaque achat, le vendeur saisit le montant et scanne votre QR.</li>
      <li>Votre cumul progresse vers <b>80 ‚Ç¨</b>. Chaque palier atteint = <b>1 cadeau</b>.</li>
      <li>‚ÄúMon compte‚Äù permet de voir le cumul et l‚Äôhistorique.</li>
    </ol>
    <p><a id="accountLink" class="btn" href="#">Acc√©der √† mon compte</a></p>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    const p = new URLSearchParams(location.search);
    const code = (p.get('code') || '').toUpperCase();

    const main        = document.querySelector('main');
    const qrFinal     = document.getElementById('qrFinal');
    const qrRaw       = document.getElementById('qrRaw');
    const codeText    = document.getElementById('codeText');
    const accountLink = document.getElementById('accountLink');

    if (!code) {
      main.innerHTML = '<p class="error">Code introuvable.</p>';
    } else {
      // Texte + lien "Mon compte"
      codeText.textContent = 'Code : ' + code;
      const account = new URL('/mon-compte.html', location.origin);
      account.searchParams.set('code', code);
      accountLink.href = account.toString();

      // G√©n√©ration du QR styl√©
      generateStyledQr(code)
        .then((dataUrl) => {
          qrFinal.src = dataUrl;

          // bouton "T√©l√©charger le QR"
          const a = document.createElement('a');
          a.className = 'btn';
          a.textContent = 'T√©l√©charger le QR';
          a.download = code + '.png';
          a.href = dataUrl;
          main.appendChild(a);
        })
        .catch((e) => {
          console.error(e);
          main.insertAdjacentHTML('beforeend', '<p class="error">Impossible de g√©n√©rer le QR.</p>');
        });
    }

    // --------- FONCTION QUI DESSINE LE STYLE "TONTONMOH" ----------
    function generateStyledQr(code) {
      return new Promise((resolve, reject) => {
        const qrRawEl = qrRaw;          // zone cach√©e
        qrRawEl.innerHTML = '';

        // 1) QR brut
        const qr = new QRCode(qrRawEl, {
          text: code,
          width: 480,
          height: 480,
          correctLevel: QRCode.CorrectLevel.H,
        });

        setTimeout(() => {
          const qrImg = qrRawEl.querySelector('img') || qrRawEl.querySelector('canvas');
          if (!qrImg) {
            reject(new Error('QR brut introuvable'));
            return;
          }

          // 2) Canvas final style Wallet
          const CARD_W = 1200;
          const CARD_H = 1700;
          const canvas = document.createElement('canvas');
          canvas.width  = CARD_W;
          canvas.height = CARD_H;
          const ctx = canvas.getContext('2d');

          // Fond noir
          ctx.fillStyle = '#000000';
          ctx.fillRect(0, 0, CARD_W, CARD_H);

          // Bloc blanc en haut (pour le QR seulement)
          const marginX = 70;
          const marginY = 80;
          const whiteHeight = 980; // laisse une grosse bande noire en bas

          ctx.fillStyle = '#ffffff';
          roundedRect(ctx, marginX, marginY, CARD_W - 2 * marginX, whiteHeight, 72);
          ctx.fill();

          // QR centr√© dans le bloc blanc
          const qrSize = whiteHeight - 220;
          const qrX = (CARD_W - qrSize) / 2;
          const qrY = marginY + (whiteHeight - qrSize) / 2;

          const qrCanvas = document.createElement('canvas');
          qrCanvas.width = qrSize;
          qrCanvas.height = qrSize;
          const qrCtx = qrCanvas.getContext('2d');

          const imgObj = new Image();
          imgObj.onload = () => {
            qrCtx.drawImage(imgObj, 0, 0, qrSize, qrSize);
            ctx.drawImage(qrCanvas, qrX, qrY);

            // 3) Logo au centre du QR
            const logo = new Image();
            logo.src = './assets/logo.png';
            logo.onload = () => {
              const logoSize = qrSize * 0.27;
              const logoX = CARD_W / 2 - logoSize / 2;
              const logoY = qrY + qrSize / 2 - logoSize / 2;

              ctx.save();
              ctx.beginPath();
              ctx.arc(CARD_W / 2, qrY + qrSize / 2, logoSize / 2 + 10, 0, Math.PI * 2);
              ctx.closePath();
              ctx.fillStyle = '#ffffff';
              ctx.fill();

              ctx.drawImage(logo, logoX, logoY, logoSize, logoSize);
              ctx.restore();

              // 4) Ic√¥ne t√©l√©phone + texte Tontonmoh dans la bande noire
              const whiteBottom = marginY + whiteHeight;
              const bandTop = whiteBottom + 60;

              const iconSize = 220;              // taille de icon.png
              const iconX = CARD_W / 2 - 260;    // l√©g√®rement √† gauche du centre
              const iconY = bandTop + 40;

              const icon = new Image();
              icon.src = './assets/icon.png';
              icon.onload = () => {
                // dessiner l'ic√¥ne (elle contient d√©j√† son cercle)
                ctx.drawImage(icon, iconX, iconY, iconSize, iconSize);

                // Texte "Tontonmoh" align√© verticalement au milieu de l‚Äôic√¥ne
                ctx.fillStyle = '#ffffff';
                ctx.textAlign = 'left';
                ctx.font = '64px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
                const textY = iconY + iconSize / 2 + 22;
                ctx.fillText('Tontonmoh', iconX + iconSize + 40, textY);

                // 5) Export PNG
                const dataUrl = canvas.toDataURL('image/png');
                resolve(dataUrl);
              };
              icon.onerror = () => reject(new Error('icon.png introuvable'));
            };
            logo.onerror = () => reject(new Error('logo.png introuvable'));
          };
          imgObj.onerror = () => reject(new Error('Image QR brute introuvable'));

          imgObj.src = qrImg.src || (qrImg.toDataURL && qrImg.toDataURL());
        }, 60);
      });
    }

    // helper: dessiner un rectangle arrondi
    function roundedRect(ctx, x, y, w, h, r) {
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.lineTo(x + w - r, y);
      ctx.quadraticCurveTo(x + w, y, x + w, y + r);
      ctx.lineTo(x + w, y + h - r);
      ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
      ctx.lineTo(x + r, y + h);
      ctx.quadraticCurveTo(x, y + h, x, y + h - r);
      ctx.lineTo(x, y + r);
      ctx.quadraticCurveTo(x, y, x + r, y);
      ctx.closePath();
    }
  </script>
</body>
</html>
