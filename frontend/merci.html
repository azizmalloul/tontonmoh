<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Merci ‚Äî Carte fid√©lit√©</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header class="container center">
    <img src="./assets/logo.png" alt="Chez Tonton Moh" class="logo" />
    <h1>Votre carte fid√©lit√© est pr√™te üéâ</h1>
  </header>
  <main class="container card center">
    <p class="banner">Enregistrez l'image du QR. Vous la recevrez aussi par e-mail.</p>
    <div class="qr-wrapper">
      <!-- image finale styl√©e -->
      <img id="qrFinal" alt="QR fid√©lit√© TontonMoh" />
    
      <!-- zone cach√©e pour g√©n√©rer le QR brut -->
      <div id="qrRaw" style="display:none"></div>
    </div>

    <p id="codeText" class="muted"></p>
    <h2>Comment √ßa marche ?</h2>
    <ol class="container" style="text-align:left">
      <li>√Ä chaque achat, le vendeur saisit le montant et scanne votre QR.</li>
      <li>Votre cumul progresse vers <b>80 ‚Ç¨</b>. Chaque palier atteint = <b>1 cadeau</b>.</li>
      <li>‚ÄúMon compte‚Äù permet de voir le cumul et l‚Äôhistorique.</li>
    </ol>
    <p><a id="accountLink" class="btn" href="#">Acc√©der √† mon compte</a></p>
  </main>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
  const p = new URLSearchParams(location.search);
  const code = (p.get('code') || '').toUpperCase();

  const main        = document.querySelector('main');
  const qrFinal     = document.getElementById('qrFinal');
  const qrRaw       = document.getElementById('qrRaw');
  const codeText    = document.getElementById('codeText');
  const accountLink = document.getElementById('accountLink');

  if (!code) {
    main.innerHTML = '<p class="error">Code introuvable.</p>';
  } else {
    // texte + lien "Mon compte"
    codeText.textContent = 'Code : ' + code;
    const account = new URL('/mon-compte.html', location.origin);
    account.searchParams.set('code', code);
    accountLink.href = account.toString();

    // g√©n√©ration du QR styl√©
    generateStyledQr(code)
      .then((dataUrl) => {
        qrFinal.src = dataUrl;

        // bouton "T√©l√©charger le QR"
        const a = document.createElement('a');
        a.className = 'btn';
        a.textContent = 'T√©l√©charger le QR';
        a.download = code + '.png';
        a.href = dataUrl;
        main.appendChild(a);
      })
      .catch((e) => {
        console.error(e);
        qrRaw.innerHTML = '<p class="error">Impossible de g√©n√©rer le QR.</p>';
      });
  }

  // --------- FONCTION QUI DESSINE LE STYLE "TONTONMOH" ----------
  function generateStyledQr(code) {
    return new Promise((resolve, reject) => {
      // 1) G√©n√©rer le QR brut dans un div cach√©
      qrRaw.innerHTML = '';
      const qr = new QRCode(qrRaw, {
        text: code,
        width: 480,
        height: 480,
        correctLevel: QRCode.CorrectLevel.H,  // plus de robustesse pour le logo
      });

      // qrcodejs rend une <img> ou un <canvas> ‚Üí on attend un peu
      setTimeout(() => {
        const qrImg = qrRaw.querySelector('img') || qrRaw.querySelector('canvas');
        if (!qrImg) {
          reject(new Error('QR brut introuvable'));
          return;
        }

        // 2) Pr√©parer le canvas final (carte noire + blanche)
        const CARD_W = 800;
        const CARD_H = 1000;
        const canvas = document.createElement('canvas');
        canvas.width  = CARD_W;
        canvas.height = CARD_H;
        const ctx = canvas.getContext('2d');

        // fond noir (bord ext√©rieur)
        ctx.fillStyle = '#000000';
        ctx.fillRect(0, 0, CARD_W, CARD_H);

        // carte blanche arrondie (comme ton exemple)
        const margin = 40;
        const radius = 80;
        roundedRect(ctx, margin, margin, CARD_W - 2*margin, CARD_H - 2*margin, radius);
        ctx.fillStyle = '#ffffff';
        ctx.fill();

        // 3) dessiner le QR en grand au centre de la carte
        const qrSize = 520;
        const qrX = (CARD_W - qrSize) / 2;
        const qrY = margin + 80; // laisse un peu de marge en haut

        // on dessine l'image du QR dans le canvas
        const qrCanvas = document.createElement('canvas');
        qrCanvas.width = qrSize;
        qrCanvas.height = qrSize;
        const qrCtx = qrCanvas.getContext('2d');

        const imgObj = new Image();
        imgObj.onload = () => {
          // QR
          qrCtx.drawImage(imgObj, 0, 0, qrSize, qrSize);
          ctx.drawImage(qrCanvas, qrX, qrY);

          // 4) logo au centre du QR (avec un fond blanc rond)
          const logo = new Image();
          logo.src = './assets/logo.png';
          logo.onload = () => {
            const logoSize = qrSize * 0.28; // ~28% du QR
            const logoX = CARD_W/2 - logoSize/2;
            const logoY = qrY + qrSize/2 - logoSize/2;

            // cercle blanc derri√®re le logo pour lisibilit√©
            ctx.save();
            ctx.beginPath();
            ctx.arc(CARD_W/2, qrY + qrSize/2, logoSize/2 + 10, 0, Math.PI * 2);
            ctx.closePath();
            ctx.fillStyle = '#ffffff';
            ctx.fill();

            // logo lui-m√™me
            ctx.drawImage(logo, logoX, logoY, logoSize, logoSize);
            ctx.restore();

            // 5) partie basse : ic√¥ne smartphone + texte "Tontonmoh"
            const bottomY = qrY + qrSize + 120;

            ctx.fillStyle = '#000000';
            ctx.textAlign = 'center';

            // ic√¥ne t√©l√©phone en gros (emoji)
            ctx.font = '64px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
            ctx.fillText('üì±', CARD_W / 2, bottomY);

            // label "Tontonmoh"
            ctx.font = '40px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
            ctx.fillText('Tontonmoh', CARD_W / 2, bottomY + 60);

            // 6) on renvoie le dataURL final
            const dataUrl = canvas.toDataURL('image/png');
            resolve(dataUrl);
          };

          logo.onerror = () => reject(new Error('Logo introuvable'));
        };

        imgObj.onerror = () => reject(new Error('Image QR brute introuvable'));
        imgObj.src = qrImg.src || qrImg.toDataURL && qrImg.toDataURL();
      }, 50);
    });
  }

  // helper: dessiner un rectangle arrondi
  function roundedRect(ctx, x, y, w, h, r) {
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.lineTo(x + w - r, y);
    ctx.quadraticCurveTo(x + w, y, x + w, y + r);
    ctx.lineTo(x + w, y + h - r);
    ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
    ctx.lineTo(x + r, y + h);
    ctx.quadraticCurveTo(x, y + h, x, y + h - r);
    ctx.lineTo(x, y + r);
    ctx.quadraticCurveTo(x, y, x + r, y);
    ctx.closePath();
  }
</script>

</body>
</html>
