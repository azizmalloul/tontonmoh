<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Merci ‚Äî Carte fid√©lit√©</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header class="container center">
    <img src="./assets/logo.png" alt="Chez Tonton Moh" class="logo" />
    <h1>Votre carte fid√©lit√© est pr√™te üéâ</h1>
  </header>

  <main class="container card center">
    <p class="banner">
      Enregistrez l'image du QR dans votre t√©l√©phone pour la pr√©senter en caisse.
    </p>

    <div class="qr-wrapper">
      <!-- image finale styl√©e -->
      <img id="qrFinal" alt="QR fid√©lit√© TontonMoh" />

      <!-- zone cach√©e pour g√©n√©rer le QR brut -->
      <div id="qrRaw" style="display:none"></div>
    </div>

    <p id="codeText" class="muted"></p>

    <h2>Comment √ßa marche ?</h2>
    <ol class="container" style="text-align:left">
      <li>√Ä chaque achat, le vendeur saisit le montant et scanne votre QR.</li>
      <li>Une partie de chaque achat est convertie en <b>bonus en euros</b> sur votre compte.</li>
      <li>La page ‚ÄúMon compte‚Äù permet de voir vos achats, votre bonus disponible et l‚Äôhistorique.</li>
    </ol>

    <p><a id="accountLink" class="btn" href="#">Acc√©der √† mon compte</a></p>
  </main>

  <!-- Librairie QRCodeJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    const p = new URLSearchParams(location.search);
    const code = (p.get('code') || '').toUpperCase();

    const main        = document.querySelector('main');
    const qrFinal     = document.getElementById('qrFinal');
    const qrRaw       = document.getElementById('qrRaw');
    const codeText    = document.getElementById('codeText');
    const accountLink = document.getElementById('accountLink');

    if (!code) {
      main.innerHTML = '<p class="error">Code introuvable.</p>';
    } else {
      // Texte + lien "Mon compte"
      codeText.textContent = 'Code : ' + code;
      // on cache ce texte HTML (le code sera dessin√© dans la carte)
      codeText.style.display = 'none';
      
      const account = new URL('/mon-compte.html', location.origin);
      account.searchParams.set('code', code);
      accountLink.href = account.toString();


      // G√©n√©ration du QR styl√©
      generateStyledQr(code)
        .then((dataUrl) => {
          qrFinal.src = dataUrl;

          // bouton "T√©l√©charger le QR"
          const a = document.createElement('a');
          a.className = 'btn';
          a.textContent = 'T√©l√©charger le QR';
          a.download = code + '.png';
          a.href = dataUrl;
          main.appendChild(a);
        })
        .catch((e) => {
          console.error(e);
          main.insertAdjacentHTML('beforeend', '<p class="error">Impossible de g√©n√©rer le QR.</p>');
        });
    }

    // --------- FONCTION QUI DESSINE LE STYLE "TONTONMOH" ----------
    function generateStyledQr(code) {
      return new Promise((resolve, reject) => {
        const qrRawEl = qrRaw;          // zone cach√©e
        qrRawEl.innerHTML = '';

        // 1) QR brut
        new QRCode(qrRawEl, {
          text: code,
          width: 480,
          height: 480,
          correctLevel: QRCode.CorrectLevel.H,
        });

        let tries = 0;
        const MAX_TRIES = 25; // 25 * 100 ms = 2,5 s max

        function waitForQr() {
          const qrImg = qrRawEl.querySelector('img, canvas');

          // pas encore g√©n√©r√© ‚Üí on attend
          if (!qrImg) {
            if (tries++ > MAX_TRIES) {
              reject(new Error('QR brut introuvable'));
              return;
            }
            setTimeout(waitForQr, 100);
            return;
          }

          // R√©cup√©rer la source du QR (img ou canvas)
          let src = '';
          if (qrImg.tagName === 'IMG') {
            src = qrImg.src || '';
          } else if (qrImg.tagName === 'CANVAS') {
            try {
              src = qrImg.toDataURL('image/png');
            } catch (e) {
              console.error('toDataURL error', e);
            }
          }

          if (!src) {
            if (tries++ > MAX_TRIES) {
              reject(new Error('Source QR invalide'));
              return;
            }
            setTimeout(waitForQr, 100);
            return;
          }

          // Quand on a la source, on continue avec le dessin de la carte
          const imgObj = new Image();
          imgObj.onload = () => drawWalletCard(imgObj, resolve, reject);
          imgObj.onerror = () => reject(new Error('Image QR brute introuvable'));
          imgObj.src = src;
        }

        waitForQr();
      });
    }

    // Dessine la carte "fa√ßon Apple Wallet"
    function drawWalletCard(qrImage, resolve, reject) {
      const CARD_W = 1200;
      const CARD_H = 1700;
      const canvas = document.createElement('canvas');
      canvas.width  = CARD_W;
      canvas.height = CARD_H;
      const ctx = canvas.getContext('2d');

      // Fond noir
      ctx.fillStyle = '#000000';
      ctx.fillRect(0, 0, CARD_W, CARD_H);

      // Bloc blanc en haut (pour le QR seulement)
      const marginX = 55;
      const marginY = 60;
      const whiteHeight = 1100; // hauteur du bloc blanc

      ctx.fillStyle = '#ffffff';
      roundedRect(ctx, marginX, marginY, CARD_W - 2 * marginX, whiteHeight, 72);
      ctx.fill();

      // QR centr√© dans le bloc blanc
      const qrSize = whiteHeight - 220;
      const qrX = (CARD_W - qrSize) / 2;
      const qrY = marginY + (whiteHeight - qrSize) / 2;

      ctx.drawImage(qrImage, qrX, qrY, qrSize, qrSize);

      // 3) Logo au centre du QR, sur un carr√© blanc
      const logo = new Image();
      logo.src = './assets/logo.png';
      logo.onload = () => {
        const logoSize = qrSize * 0.27;          // taille r√©elle du logo
        const padding  = 20;                     // marge blanche autour du logo
        const bgSize   = logoSize + padding * 2; // taille du carr√© blanc
      
        // Position du carr√© blanc (centr√© dans le QR)
        const bgX = CARD_W / 2 - bgSize / 2;
        const bgY = qrY + qrSize / 2 - bgSize / 2;
      
        // Position du logo (centr√© dans le carr√©)
        const logoX = CARD_W / 2 - logoSize / 2;
        const logoY = qrY + qrSize / 2 - logoSize / 2;
      
        // Fond carr√© blanc (coins l√©g√®rement arrondis)
        ctx.fillStyle = '#ffffff';
        roundedRect(ctx, bgX, bgY, bgSize, bgSize, 24); // 24 = rayon des coins
        ctx.fill();
      
        // Logo par-dessus
        ctx.drawImage(logo, logoX, logoY, logoSize, logoSize);


        // 4) Code au milieu puis ic√¥ne t√©l√©phone + texte Tontonmoh dans la bande noire
        const whiteBottom = marginY + whiteHeight;
        
        // --- TEXTE "Code : XXXXX" entre le QR et l'ic√¥ne ---
        ctx.fillStyle = '#ffffff';
        ctx.textAlign = 'center';
        // taille du texte du code (64px ‚Üí plus grand / plus petit)
        ctx.font = '64px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
        
        // position verticale du code : augmente 80 ‚Üí descend, diminue 80 ‚Üí monte
        const codeY = whiteBottom + 80;
        ctx.fillText('Code : ' + code, CARD_W / 2, codeY);
        
        // --- Ic√¥ne + "Tontonmoh" plus bas ---
        const bandTop = codeY + 80; // d√©cale l'ic√¥ne sous le code
        
        const iconSize = 250;           // taille de icon.png dessin√©
        const iconX = CARD_W / 2 - 550; // d√©cale l'ic√¥ne vers la gauche / droite
        const iconY = bandTop + 30;


        const icon = new Image();
        icon.src = './assets/icon.png';
        icon.onload = () => {
          ctx.drawImage(icon, iconX, iconY, iconSize, iconSize);

          ctx.fillStyle = '#ffffff';
          ctx.textAlign = 'left';

          // >>> TAILLE DU TEXTE "Tontonmoh" <<<
          //   - augmente 140 ‚Üí texte plus gros
          //   - diminue 140 ‚Üí texte plus petit
          ctx.font = '150px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';

          // >>> POSITION HORIZONTALE DU TEXTE <<<
          //   - change "+ 40" : plus grand ‚Üí texte PLUS √Ä DROITE
          //                       plus petit ‚Üí texte PLUS √Ä GAUCHE
          const textY = iconY + iconSize / 2 + 40;
          ctx.fillText('Tontonmoh', iconX + iconSize + 50, textY);

          const dataUrl = canvas.toDataURL('image/png');
          resolve(dataUrl);
        };
        icon.onerror = () => reject(new Error('icon.png introuvable'));
      };
      logo.onerror = () => reject(new Error('logo.png introuvable'));
    }

    // helper: dessiner un rectangle arrondi 
    function roundedRect(ctx, x, y, w, h, r) {
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.lineTo(x + w - r, y);
      ctx.quadraticCurveTo(x + w, y, x + w, y + r);
      ctx.lineTo(x + w, y + h - r);
      ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
      ctx.lineTo(x + r, y + h);
      ctx.quadraticCurveTo(x, y + h, x, y + h - r);
      ctx.lineTo(x, y + r);
      ctx.quadraticCurveTo(x, y, x + r, y);
      ctx.closePath();
    }
  </script>
</body>
</html>
