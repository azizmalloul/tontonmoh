<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Liste des clients</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
<header class="container center">
  <img src="./assets/logo.png" alt="Chez Tonton Moh" class="logo" />
  <h1>Liste des clients</h1>
  <p class="muted" id="countLine">Chargement‚Ä¶</p>
</header>

<main class="container">
  <section class="card">
    <div class="row" style="gap:.5rem; align-items:center; flex-wrap:wrap">
      <input id="q" type="search" placeholder="Rechercher (nom, pr√©nom, email, t√©l√©phone, code, RFID)‚Ä¶" style="flex:1; min-width:220px" />
      <button id="searchBtn" class="btn outline" type="button">Rechercher</button>
      <button id="resetBtn" class="btn outline" type="button">R√©initialiser</button>
      <button id="refreshBtn" class="btn" type="button">Actualiser</button>
    </div>
  </section>

  <section class="card">
    <h2 style="margin-top:0">Clients</h2>
    <p class="tip">
      Format : <i>index) pr√©nom nom email t√©l√©phone code [RFID]</i>.<br/>
      Cliquez sur <b>Compte</b> pour voir le solde + l‚Äôhistorique et ajuster le cumul / cadeaux.<br/>
      Cliquez sur üóëÔ∏è pour supprimer un client.
    </p>
    <div id="list" class="kv"></div>
    <p id="msg" class="muted"></p>
  </section>

  <!-- ===== panneau "Compte client" ===== -->
  <section class="card hidden" id="accountPanel">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0">Compte client</h2>
      <button id="accountClose" class="btn outline" type="button">Fermer</button>
    </div>

    <div id="accountInfo" class="kv">
      <p><b id="accName">‚Äî</b></p>
      <p class="muted">Code : <b id="accCode">‚Äî</b></p>
    </div>

    <hr class="muted"/>

    <h3>Ajuster cumul / cadeaux</h3>
    <form id="accountForm" class="grid">
      <div>
        <label for="accBalance">Cumul (en ‚Ç¨)</label>
        <input id="accBalance" type="number" step="0.01" min="0" />
      </div>
      <div>
        <label for="accGifts">Cadeaux (compteur)</label>
        <input id="accGifts" type="number" min="0" />
      </div>
      <div style="grid-column:1/-1" class="row">
        <input id="accReason" type="text" placeholder="Motif de l'ajustement (ex: cadeau remis / correction saisie)" style="flex:1"/>
        <button id="accSave" class="btn" type="submit">Enregistrer l‚Äôajustement</button>
      </div>
      <p id="accMsg" class="muted"></p>
    </form>

    <hr class="muted"/>

    <h3>Derni√®res op√©rations</h3>
    <div id="accTxList" class="kv"></div>
  </section>
</main>

<script>
const API = 'https://tontonmoh-api.azizekarma.workers.dev';
const ADMIN_KEY_LS = 'aziz';
const CASHIER_ID   = 'cash_admin';

// --------- Utilitaires
function telNice(s){
  if(!s) return '‚Äî';
  const p = s.replace(/[^\d+]/g,'');
  return p;
}
function el(tag, attrs={}, children=[]){
  const e = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k === 'class') e.className = v;
    else if(k === 'html') e.innerHTML = v;
    else e.setAttribute(k, v);
  });
  (Array.isArray(children)?children:[children]).filter(Boolean).forEach(c=>{
    e.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
  });
  return e;
}
function normalizePhone(s){
  return String(s||'').replace(/[^\d+]/g,'');
}
function buildHaystack(c){
  const phone = c.phone_e164 || '';
  return [
    c.first_name   || '',
    c.last_name    || '',
    c.email        || '',
    phone,
    normalizePhone(phone),
    c.code_public  || '',
    c.rfid_uid     || '',
    c.rfid_token   || ''
  ].join(' ').toLowerCase();
}
function filterClients(query, rows){
  const q = String(query || '').trim().toLowerCase();
  if(!q) return rows;

  const tokens  = q.split(/\s+/).filter(Boolean);
  const phoneQ  = normalizePhone(q);
  const usePhone = phoneQ.length >= 3;

  return rows.filter(c => {
    const h = buildHaystack(c);
    const textOk  = tokens.every(t => h.includes(t));
    const phoneOk = usePhone ? normalizePhone(c.phone_e164).includes(phoneQ) : true;
    return textOk && phoneOk;
  });
}
function euros(cents){ return (Number(cents||0)/100).toFixed(2) + ' ‚Ç¨'; }

// --------- API "liste"
async function fetchAllClients(){
  const limit = 200;
  let offset = 0;
  let all = [];
  while(true){
    const url = new URL(API + '/api/clients');
    url.searchParams.set('limit', limit);
    url.searchParams.set('offset', offset);
    const r = await fetch(url);
    if(!r.ok) throw new Error('Erreur chargement clients');
    const page = await r.json();
    all = all.concat(page || []);
    if(!page || page.length < limit) break;
    offset += limit;
  }
  return all;
}
async function deleteClient(id){
  const r = await fetch(`${API}/api/clients/${encodeURIComponent(id)}`, { method:'DELETE' });
  if(!r.ok) throw new Error('Suppression refus√©e');
  return true;
}

// --------- API "compte client"
async function fetchClientFull(clientId){
  const r = await fetch(`${API}/api/clients/${encodeURIComponent(clientId)}/full`);
  if(!r.ok) throw new Error('Impossible de charger le compte client');
  return await r.json();
}
async function adminAdjustBalance(clientId, newBalanceCents, newGiftsCount, reason){
  let adminKey = localStorage.getItem(ADMIN_KEY_LS) || '';
  if(!adminKey){
    adminKey = prompt('Cl√© Admin ?');
    if(!adminKey) throw new Error('Cl√© admin manquante');
    localStorage.setItem(ADMIN_KEY_LS, adminKey);
  }

  const r = await fetch(`${API}/api/admin/balances/adjust`, {
    method: 'POST',
    headers: {
      'Content-Type':'application/json',
      'X-Admin-Key': adminKey
    },
    body: JSON.stringify({
      client_id: clientId,
      set_balance_cents: newBalanceCents,
      set_gifts_count: newGiftsCount,
      reason: reason || '',
      cashier_id: CASHIER_ID
    })
  });
  const j = await r.json().catch(()=>({}));
  if(!r.ok || !j.ok){
    throw new Error(j.error ? `Erreur admin: ${j.error}` : 'Ajustement refus√©');
  }
  return j;
}

// --------- UI liste
const listBox    = document.getElementById('list');
const msg        = document.getElementById('msg');
const countLine  = document.getElementById('countLine');
const qInput     = document.getElementById('q');
const searchBtn  = document.getElementById('searchBtn');
const resetBtn   = document.getElementById('resetBtn');
const refreshBtn = document.getElementById('refreshBtn');

let currentData = [];

function renderList(data){
  listBox.innerHTML = '';
  if(!data.length){
    listBox.appendChild(el('p', { class:'muted' }, 'Aucun client.'));
    return;
  }

  data.forEach((c, i)=>{
    const idx = (i+1) + ') ';
    const rfidLabel = c.rfid_token ? ` [RFID: ${c.rfid_token}]` : ' [RFID: ‚Äî]';

    const line = el('div', {
      class:'row',
      style:'justify-content:space-between; align-items:center; gap:.75rem; padding:.4rem 0; border-bottom:1px dashed var(--muted,#eee);'
    }, [
      el('div', {}, [
        el('b', {}, idx),
        document.createTextNode(`${(c.first_name||'').trim()} ${(c.last_name||'').trim()}  `),
        el('span', { class:'muted' },
          ` ${c.email || '‚Äî'}  ${telNice(c.phone_e164)}  ${c.code_public || ''}${rfidLabel}`
        )
      ]),
      el('div', { class:'row', style:'gap:.4rem' }, [
        el('button', {
          class:'btn outline',
          'data-role':'account',
          title:'Voir le compte (solde, cadeaux, historique)'
        }, 'Compte'),
        el('button', {
          class:'btn outline',
          'data-role':'delete',
          title:'Supprimer ce client',
          style:'--btn-bg:transparent;'
        }, 'üóëÔ∏è')
      ])
    ]);

    const accountBtn = line.querySelector('button[data-role="account"]');
    const delBtn     = line.querySelector('button[data-role="delete"]');

    accountBtn.addEventListener('click', () => openAccount(c));

    delBtn.addEventListener('click', async ()=>{
      const name = `${c.first_name||''} ${c.last_name||''}`.trim() || 'Ce client';
      const ok = confirm(`Supprimer le compte "${name}" ?\n\nCette action supprime aussi son solde et ses transactions (ON DELETE CASCADE).`);
      if(!ok) return;
      try{
        delBtn.disabled = true;
        await deleteClient(c.id);
        currentData = currentData.filter(x=>x.id !== c.id);
        renderList(currentData);
        countLine.textContent = `${currentData.length} client(s) affich√©(s).`;
        msg.textContent = 'Compte supprim√© ‚úîÔ∏è';
        msg.className = 'success';
      }catch(e){
        delBtn.disabled = false;
        msg.textContent = 'Erreur suppression: ' + e.message;
        msg.className = 'error';
      }
    });

    listBox.appendChild(line);
  });
}

async function load(query=''){
  try{
    msg.textContent = 'Chargement‚Ä¶'; msg.className='muted';

    const all  = await fetchAllClients();
    const data = filterClients(query, all);

    data.sort((a,b)=>
      (a.last_name  ||'').localeCompare(b.last_name  ||'', 'fr', {sensitivity:'base'}) ||
      (a.first_name ||'').localeCompare(b.first_name ||'', 'fr', {sensitivity:'base'})
    );

    currentData = data;
    countLine.textContent = `${data.length} client(s) au total${query ? ' (filtr√©)' : ''}.`;
    renderList(data);
    msg.textContent = '';
  }catch(e){
    console.error(e);
    msg.textContent = e.message || 'Erreur de chargement.';
    msg.className = 'error';
  }
}

// --------- UI "Compte client"
const accountPanel  = document.getElementById('accountPanel');
const accountClose  = document.getElementById('accountClose');
const accName       = document.getElementById('accName');
const accCode       = document.getElementById('accCode');
const accBalance    = document.getElementById('accBalance');
const accGifts      = document.getElementById('accGifts');
const accReason     = document.getElementById('accReason');
const accMsg        = document.getElementById('accMsg');
const accTxList     = document.getElementById('accTxList');
const accountForm   = document.getElementById('accountForm');

let currentAccountClient = null;

async function openAccount(client){
  try{
    currentAccountClient = client;
    accMsg.textContent = 'Chargement‚Ä¶';
    accountPanel.classList.remove('hidden');

    const full = await fetchClientFull(client.id);

    const name = `${full.client.first_name||''} ${full.client.last_name||''}`.trim();
    accName.textContent = name || 'Client';
    accCode.textContent = full.client.code_public || '';

    const balCents = Number(full.balance?.euro_cents_accumulated || 0);
    const gifts    = Number(full.balance?.gifts_count || 0);
    accBalance.value = (balCents/100).toFixed(2);
    accGifts.value   = gifts;

    accTxList.innerHTML = (full.transactions||[]).map(t=>{
      const dt  = (t.created_at||'').replace('T',' ').replace('Z','');
      const amt = euros(t.amount_cents);
      return `<p class="muted"><b>${dt}</b> ‚Äî ${t.status} ‚Äî ${amt} ‚Äî <i>${t.note||''}</i></p>`;
    }).join('') || '<p class="muted">Aucune op√©ration r√©cente.</p>';

    accMsg.textContent = '';
  }catch(e){
    console.error(e);
    accMsg.textContent = 'Erreur: ' + e.message;
  }
}

accountClose.addEventListener('click', ()=>{
  accountPanel.classList.add('hidden');
});

accountForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  try{
    if(!currentAccountClient) return;
    accMsg.textContent = 'Enregistrement‚Ä¶';

    const eurosStr = String(accBalance.value || '0').replace(',','.');
    const cents    = Math.max(0, Math.round(parseFloat(eurosStr||'0')*100));
    const gifts    = Math.max(0, parseInt(accGifts.value||'0', 10));
    const reason   = accReason.value || '';

    const res = await adminAdjustBalance(currentAccountClient.id, cents, gifts, reason);
    accMsg.textContent   = 'Ajustement enregistr√© ‚úîÔ∏è';
    accBalance.value     = (res.balance_cents/100).toFixed(2);
    accGifts.value       = res.gifts_count;
  }catch(err){
    console.error(err);
    accMsg.textContent = 'Erreur: ' + err.message;
  }
});

// --------- Events liste
searchBtn .addEventListener('click', ()=> load(qInput.value));
resetBtn  .addEventListener('click', ()=> { qInput.value=''; load(''); });
refreshBtn.addEventListener('click', ()=> load(qInput.value));
qInput    .addEventListener('keydown', (e)=>{ if(e.key==='Enter') load(qInput.value); });

// premier chargement
load();
</script>
</body>
</html>
