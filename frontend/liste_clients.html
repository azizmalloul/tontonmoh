<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Liste des clients</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
<header class="container center">
  <img src="./assets/logo.png" alt="Chez Tonton Moh" class="logo" />
  <h1>Liste des clients</h1>
  <p class="muted" id="countLine">Chargement‚Ä¶</p>
</header>

<main class="container">
  <section class="card">
    <div class="row" style="gap:.5rem; align-items:center; flex-wrap:wrap">
      <input id="q" type="search" placeholder="Rechercher (nom, pr√©nom, email, t√©l√©phone, code, RFID)‚Ä¶" style="flex:1; min-width:220px" />
      <button id="searchBtn" class="btn outline" type="button">Rechercher</button>
      <button id="resetBtn" class="btn outline" type="button">R√©initialiser</button>
      <button id="refreshBtn" class="btn" type="button">Actualiser</button>
    </div>
  </section>

  <section class="card" id="clientsSection">
    <h2 style="margin-top:0">Clients</h2>

    <p class="tip">
      Cliquez sur <b>Compte</b> pour voir le cumul d‚Äôachats, le bonus et l‚Äôhistorique.<br/>
      Cliquez sur üóëÔ∏è pour supprimer un client.
    </p>

    <div id="list" class="kv"></div>
    <p id="msg" class="muted"></p>
  </section>

  <!-- ===== panneau "Compte client" ===== -->
  <section class="card hidden" id="accountPanel">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0">Compte client</h2>
      <button id="accountClose" class="btn outline" type="button">Fermer</button>
    </div>

    <div id="accountInfo" class="kv">
      <p><b id="accName">‚Äî</b></p>
      <p class="muted">Code : <b id="accCode">‚Äî</b></p>
    </div>

    <hr class="muted"/>

    <h3>Ajuster cumul / bonus</h3>

    <form id="accountForm" class="grid">
      <div>
        <label for="accBalance">Cumul achats (en ‚Ç¨)</label>
        <input id="accBalance" type="number" step="0.01" min="0" />
      </div>
      <div>
        <label for="accBonus">Bonus (en ‚Ç¨)</label>
        <input id="accBonus" type="number" step="0.01" min="0" />
      </div>

        <div style="grid-column:1/-1" class="row">
          <button id="accSave" class="btn" type="submit" style="width:100%">
            Enregistrer l‚Äôajustement
          </button>
        </div>

      <p id="accMsg" class="muted"></p>
    </form>

    <hr class="muted"/>

    <h3>Derni√®res op√©rations</h3>
    <div id="accTxList" class="kv"></div>
  </section>
</main>

<script>
const API = 'https://tontonmoh-api.azizekarma.workers.dev';
const ADMIN_KEY_LS = 'aziz';
const CASHIER_ID   = 'cash_admin';

// --------- Utilitaires
function telNice(s){
  if(!s) return '‚Äî';
  const p = s.replace(/[^\d+]/g,'');
  return p;
}
function el(tag, attrs={}, children=[]){
  const e = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k === 'class') e.className = v;
    else if(k === 'html') e.innerHTML = v;
    else e.setAttribute(k, v);
  });
  (Array.isArray(children)?children:[children]).filter(Boolean).forEach(c=>{
    e.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
  });
  return e;
}
function normalizePhone(s){
  return String(s||'').replace(/[^\d+]/g,'');
}
function buildHaystack(c){
  const phone = c.phone_e164 || '';
  return [
    c.first_name   || '',
    c.last_name    || '',
    c.email        || '',
    phone,
    normalizePhone(phone),
    c.code_public  || '',
    c.rfid_uid     || '',
    c.rfid_token   || ''
  ].join(' ').toLowerCase();
}
function filterClients(query, rows){
  const q = String(query || '').trim().toLowerCase();
  if(!q) return rows;

  const tokens  = q.split(/\s+/).filter(Boolean);
  const phoneQ  = normalizePhone(q);
  const usePhone = phoneQ.length >= 3;

  return rows.filter(c => {
    const h = buildHaystack(c);
    const textOk  = tokens.every(t => h.includes(t));
    const phoneOk = usePhone ? normalizePhone(c.phone_e164).includes(phoneQ) : true;
    return textOk && phoneOk;
  });
}
function euros(cents){ return (Number(cents||0)/100).toFixed(2) + ' ‚Ç¨'; }

// --- Helpers pour affichage historique fa√ßon "Mon compte" ---

function txMode(tx) {
  const note = (tx.note || '').toLowerCase();
  if (note.includes('rfid'))   return 'RFID';
  if (note.includes('[admin')) return 'ADMIN';
  return 'QR';
}

const BONUS_RATE = 0.10;
function bonusForTx(amount_cents) {
  return Math.round(Number(amount_cents || 0) * BONUS_RATE);
}

function txRow(tx){
  const sign = tx.status === 'OK' ? '+' : '¬±';
  const dt   = new Date(tx.created_at || tx.createdAt || tx.ts || Date.now());
  const pad  = n => String(n).padStart(2, '0');

  const date = `${pad(dt.getDate())}/${pad(dt.getMonth()+1)}/${dt.getFullYear()}`;
  const time = `${pad(dt.getHours())}:${pad(dt.getMinutes())}:${pad(dt.getSeconds())}`;

  const mode      = txMode(tx);
  const amountStr = `${sign} ${euros(tx.amount_cents)}`;
  const bonusStr  = euros(bonusForTx(tx.amount_cents));
  const note      = tx.note ? ` ‚Äî ${tx.note}` : '';

  return `
    <tr class="tx-row">
      <td colspan="3">
        <div class="tx-box">
          <div class="tx-grid">
            <div class="tx-date">${date}</div>
            <div class="tx-mode">${mode}</div>
            <div class="tx-amount">${amountStr} / ${bonusStr}</div>
            <div class="tx-subline">${time}${note}</div>
          </div>
        </div>
      </td>
    </tr>`;
}


// Petit helper pour l'effet "√©crasement" sur les boutons .btn
function addButtonPressFlash(el) {
  if (!el) return;
  el.addEventListener('click', () => {
    el.classList.add('pressed');
    setTimeout(() => {
      el.classList.remove('pressed');
    }, 100); // ~0.1s
  });
}


// --------- API "liste"
async function fetchAllClients(){
  const limit = 200;
  let offset = 0;
  let all = [];
  while(true){
    const url = new URL(API + '/api/clients');
    url.searchParams.set('limit', limit);
    url.searchParams.set('offset', offset);
    const r = await fetch(url);
    if(!r.ok) throw new Error('Erreur chargement clients');
    const page = await r.json();
    all = all.concat(page || []);
    if(!page || page.length < limit) break;
    offset += limit;
  }
  return all;
}
async function deleteClient(id){
  const r = await fetch(`${API}/api/clients/${encodeURIComponent(id)}`, { method:'DELETE' });
  if(!r.ok) throw new Error('Suppression refus√©e');
  return true;
}

// --------- API "compte client"
async function fetchClientFull(clientId){
  const r = await fetch(`${API}/api/clients/${encodeURIComponent(clientId)}/full`);
  if(!r.ok) throw new Error('Impossible de charger le compte client');
  return await r.json();
}
async function adminAdjustBalance(clientId, newTotalSpentCents, newBonusCents, reason){
  let adminKey = localStorage.getItem(ADMIN_KEY_LS) || '';
  if(!adminKey){
    adminKey = prompt('Cl√© Admin ?');
    if(!adminKey) throw new Error('Cl√© admin manquante');
    localStorage.setItem(ADMIN_KEY_LS, adminKey);
  }

  const r = await fetch(`${API}/api/admin/balances/adjust`, {
    method: 'POST',
    headers: {
      'Content-Type':'application/json',
      'X-Admin-Key': adminKey
    },
    body: JSON.stringify({
      client_id: clientId,
      set_total_spent_cents: newTotalSpentCents,
      set_bonus_cents: newBonusCents,
      reason: reason || '',
      cashier_id: CASHIER_ID
    })
  });
  const j = await r.json().catch(()=>({}));
  if(!r.ok || !j.ok){
    throw new Error(j.error ? `Erreur admin: ${j.error}` : 'Ajustement refus√©');
  }
  // Worker renvoie: { ok, bonus_cents, bonus_progress_cents, total_spent_cents }
  return j;
}


// --------- UI liste
const listBox    = document.getElementById('list');
const msg        = document.getElementById('msg');
const countLine  = document.getElementById('countLine');
const qInput     = document.getElementById('q');
const searchBtn  = document.getElementById('searchBtn');
const resetBtn   = document.getElementById('resetBtn');
const refreshBtn = document.getElementById('refreshBtn');
const clientsSection = document.getElementById('clientsSection');

let currentData = [];

function renderList(data){
  listBox.innerHTML = '';
  if(!data.length){
    listBox.appendChild(el('p', { class:'muted' }, 'Aucun client.'));
    return;
  }

  data.forEach((c, i)=>{
    const idx = (i+1) + ') ';
    const rfidLabel = c.rfid_token ? ` [RFID: ${c.rfid_token}]` : ' [RFID: ‚Äî]';

    const line = el('div', {
      class:'row',
      style:'justify-content:space-between; align-items:center; gap:.75rem; padding:.4rem 0; border-bottom:1px dashed var(--muted,#eee);'
    }, [
      el('div', {}, [
        el('b', {}, idx),
        document.createTextNode(`${(c.first_name||'').trim()} ${(c.last_name||'').trim()}  `),
        el('span', { class:'muted' },
          ` ${c.email || '‚Äî'}  ${telNice(c.phone_e164)}  ${c.code_public || ''}${rfidLabel}`
        )
      ]),
      el('div', { class:'row', style:'gap:.4rem' }, [
        el('button', {
          class:'btn outline',
          'data-role':'account',
          title:'Voir le compte (cumul, bonus, historique)'
        }, 'Compte'),

        el('button', {
          class:'btn outline',
          'data-role':'delete',
          title:'Supprimer ce client',
          style:'--btn-bg:transparent;'
        }, 'üóëÔ∏è')
      ])
    ]);

    const accountBtn = line.querySelector('button[data-role="account"]');
    const delBtn     = line.querySelector('button[data-role="delete"]');
    // effet visuel sur les boutons Compte / poubelle
    addButtonPressFlash(accountBtn);
    addButtonPressFlash(delBtn);
    

    accountBtn.addEventListener('click', () => openAccount(c));

    delBtn.addEventListener('click', async ()=>{
      const name = `${c.first_name||''} ${c.last_name||''}`.trim() || 'Ce client';
      const ok = confirm(`Supprimer le compte "${name}" ?\n\nCette action supprime aussi son solde et ses transactions (ON DELETE CASCADE).`);
      if(!ok) return;
      try{
        delBtn.disabled = true;
        await deleteClient(c.id);
        currentData = currentData.filter(x=>x.id !== c.id);
        renderList(currentData);
        countLine.textContent = `${currentData.length} client(s) affich√©(s).`;
        msg.textContent = 'Compte supprim√© ‚úîÔ∏è';
        msg.className = 'success';
      }catch(e){
        delBtn.disabled = false;
        msg.textContent = 'Erreur suppression: ' + e.message;
        msg.className = 'error';
      }
    });

    listBox.appendChild(line);
  });
}

async function load(query=''){
  try{
    msg.textContent = 'Chargement‚Ä¶'; msg.className='muted';

    const all  = await fetchAllClients();
    const data = filterClients(query, all);

    data.sort((a,b)=>
      (a.last_name  ||'').localeCompare(b.last_name  ||'', 'fr', {sensitivity:'base'}) ||
      (a.first_name ||'').localeCompare(b.first_name ||'', 'fr', {sensitivity:'base'})
    );

    currentData = data;
    countLine.textContent = `${data.length} client(s) au total${query ? ' (filtr√©)' : ''}.`;
    renderList(data);
    msg.textContent = '';
  }catch(e){
    console.error(e);
    msg.textContent = e.message || 'Erreur de chargement.';
    msg.className = 'error';
  }
}

// --------- UI "Compte client"
const accountPanel  = document.getElementById('accountPanel');
const accountClose  = document.getElementById('accountClose');
const accName       = document.getElementById('accName');
const accCode       = document.getElementById('accCode');
const accBalance    = document.getElementById('accBalance');
const accBonus      = document.getElementById('accBonus');

const accMsg        = document.getElementById('accMsg');
const accTxList     = document.getElementById('accTxList');
const accountForm   = document.getElementById('accountForm');
const accSave       = document.getElementById('accSave');

let currentAccountClient = null;

let accBaseTotalCents = 0;
let accBaseBonusCents = 0;


async function openAccount(client){
  try{
    currentAccountClient = client;
    accMsg.textContent = 'Chargement‚Ä¶';
    clientsSection.classList.add('hidden');
    accountPanel.classList.remove('hidden');

    const full = await fetchClientFull(client.id);

    const name = `${full.client.first_name||''} ${full.client.last_name||''}`.trim();
    accName.textContent = name || 'Client';
    accCode.textContent = full.client.code_public || '';

    const totalCents = Number(full.balance?.total_spent_cents || 0);
    const bonusCents = Number(full.balance?.bonus_cents || 0);
    
    // valeurs de base pour l‚Äôauto-motif
    accBaseTotalCents = totalCents;
    accBaseBonusCents = bonusCents;
    
    accBalance.value = (totalCents / 100).toFixed(2);
    accBonus.value   = (bonusCents / 100).toFixed(2);
    
    const txs = full.transactions || [];
    if (txs.length) {
      accTxList.innerHTML = `
        <div style="overflow:auto">
          <table class="history">
            <thead>
              <tr>
                <th>Date</th>
                <th>Source</th>
                <th>Montant / Cagnotte</th>
              </tr>
            </thead>
            <tbody>
              ${txs.map(txRow).join('')}
            </tbody>
          </table>
        </div>
      `;
    } else {
      accTxList.innerHTML = '<p class="muted">Aucune op√©ration r√©cente.</p>';
    }
    

    accMsg.textContent = '';
  }catch(e){
    console.error(e);
    accMsg.textContent = 'Erreur: ' + e.message;
  }
}

accountClose.addEventListener('click', ()=>{
  accountPanel.classList.add('hidden');
  clientsSection.classList.remove('hidden');
});


accountForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  try{
    if(!currentAccountClient) return;
    accMsg.textContent = 'Enregistrement‚Ä¶';
    accMsg.className   = 'muted';

    // Cumul achats (en ‚Ç¨) -> total_spent_cents
    const eurosTotalStr = String(accBalance.value || '0').replace(',','.');
    const totalCents = Math.max(
      0,
      Math.round(parseFloat(eurosTotalStr || '0') * 100)
    );

    // Bonus (en ‚Ç¨) -> bonus_cents
    const eurosBonusStr = String(accBonus.value || '0').replace(',','.');
    const bonusCents = Math.max(
      0,
      Math.round(parseFloat(eurosBonusStr || '0') * 100)
    );

    // üîç comme sur caisse.html : motif automatique
    const cumulChanged    = totalCents !== accBaseTotalCents;
    const cagnotteChanged = bonusCents !== accBaseBonusCents;

    let autoReason = '';
    if (cumulChanged && cagnotteChanged) {
      autoReason = 'Ajustement cumul/cagnotte';
    } else if (cumulChanged) {
      autoReason = 'Ajustement cumul';
    } else if (cagnotteChanged) {
      autoReason = 'Ajustement cagnotte';
    } else {
      autoReason = 'Ajustement sans changement';
    }

    const res = await adminAdjustBalance(
      currentAccountClient.id,
      totalCents,
      bonusCents,
      autoReason
    );

    // mettre √† jour les valeurs de base
    accBaseTotalCents = Number(
      res.total_spent_cents != null ? res.total_spent_cents : totalCents
    );
    accBaseBonusCents = Number(
      res.bonus_cents != null ? res.bonus_cents : bonusCents
    );

    // Mise √† jour en m√©moire
    currentAccountClient.total_spent_cents = accBaseTotalCents;
    currentAccountClient.bonus_cents       = accBaseBonusCents;

    // MAJ des champs
    accBalance.value = (accBaseTotalCents / 100).toFixed(2);
    accBonus.value   = (accBaseBonusCents / 100).toFixed(2);

    // üîÑ recharger les derni√®res op√©rations pour voir la ligne [ADMIN]
    const full2 = await fetchClientFull(currentAccountClient.id);
    const txs2 = full2.transactions || [];
    if (txs2.length) {
      accTxList.innerHTML = `
        <div style="overflow:auto">
          <table class="history">
            <thead>
              <tr>
                <th>Date</th>
                <th>Source</th>
                <th>Montant / Cagnotte</th>
              </tr>
            </thead>
            <tbody>
              ${txs2.map(txRow).join('')}
            </tbody>
          </table>
        </div>
      `;
    } else {
      accTxList.innerHTML = '<p class="muted">Aucune op√©ration r√©cente.</p>';
    }

    accMsg.textContent = 'Ajustement enregistr√© ‚úîÔ∏è';
    accMsg.className   = 'success';
  }catch(err){
    console.error(err);
    accMsg.textContent = 'Erreur: ' + err.message;
    accMsg.className   = 'error';
  }
});



// --------- Events liste
searchBtn .addEventListener('click', ()=> load(qInput.value));
resetBtn  .addEventListener('click', ()=> { qInput.value=''; load(''); });
refreshBtn.addEventListener('click', ()=> load(qInput.value));
qInput    .addEventListener('keydown', (e)=>{ if(e.key==='Enter') load(qInput.value); });

// Effet "flash" sur les principaux boutons
addButtonPressFlash(searchBtn);
addButtonPressFlash(resetBtn);
addButtonPressFlash(refreshBtn);
addButtonPressFlash(accountClose);
addButtonPressFlash(accSave);

// premier chargement
load();
</script>
</body>
</html>
