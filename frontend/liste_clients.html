<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Liste des clients</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
<header class="container center">
  <img src="./assets/logo.png" alt="Chez Tonton Moh" class="logo" />
  <h1>Liste des clients</h1>
  <p class="muted" id="countLine">Chargement‚Ä¶</p>
</header>

<main class="container">
  <section class="card">
    <div class="row" style="gap:.5rem; align-items:center; flex-wrap:wrap">
      <input id="q" type="search" placeholder="Rechercher (nom, pr√©nom, email, t√©l√©phone, code, RFID)‚Ä¶" style="flex:1; min-width:220px" />
      <button id="searchBtn" class="btn outline" type="button">Rechercher</button>
      <button id="resetBtn" class="btn outline" type="button">R√©initialiser</button>
      <button id="refreshBtn" class="btn" type="button">Actualiser</button>
    </div>
  </section>

  <section class="card">
    <h2 style="margin-top:0">Clients</h2>
    <p class="tip">
      Format : <i>index) pr√©nom nom email t√©l√©phone code [RFID]</i>.<br/>
      Cliquez sur <b>RFID</b> pour associer une carte, et sur üóëÔ∏è pour supprimer un client.
    </p>
    <div id="list" class="kv"></div>
    <p id="msg" class="muted"></p>
  </section>
</main>

<script>
const API = 'https://tontonmoh-api.azizekarma.workers.dev';

// --------- Utilitaires
function telNice(s){
  if(!s) return '‚Äî';
  const p = s.replace(/[^\d+]/g,'');
  return p;
}
function el(tag, attrs={}, children=[]){
  const e = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k === 'class') e.className = v;
    else if(k === 'html') e.innerHTML = v;
    else e.setAttribute(k, v);
  });
  (Array.isArray(children)?children:[children]).filter(Boolean).forEach(c=>{
    e.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
  });
  return e;
}

function normalizePhone(s){
  return String(s||'').replace(/[^\d+]/g,''); // garde + et chiffres
}

// On concat√®ne tous les champs utiles en minuscule pour la recherche
function buildHaystack(c){
  const phone = c.phone_e164 || '';
  return [
    c.first_name   || '',
    c.last_name    || '',
    c.email        || '',
    phone,
    normalizePhone(phone),     // version chiffres-seuls du t√©l√©phone
    c.code_public  || '',
    c.rfid_uid     || '',
    c.rfid_token   || ''
  ].join(' ').toLowerCase();
}

function filterClients(query, rows){
  const q = String(query || '').trim().toLowerCase();
  if(!q) return rows;

  const tokens = q.split(/\s+/).filter(Boolean);       // supporte 1 mot ou plusieurs
  const phoneQ = normalizePhone(q);                    // si on tape un num√©ro avec espaces
  const usePhone = phoneQ.length >= 3;                 // petit seuil

  return rows.filter(c => {
    const h = buildHaystack(c);
    // chaque mot doit matcher quelque part
    const textOk = tokens.every(t => h.includes(t));
    // si le query ressemble √† un t√©l√©phone, on autorise aussi le match sur chiffres-seuls
    const phoneOk = usePhone ? normalizePhone(c.phone_e164).includes(phoneQ) : true;
    return textOk && phoneOk;
  });
}

// --------- API
// On rapatrie toute la liste (pagin√©e) puis on filtrera en local
async function fetchAllClients(){
  const limit = 200;
  let offset = 0;
  let all = [];
  while(true){
    const url = new URL(API + '/api/clients');
    url.searchParams.set('limit', limit);
    url.searchParams.set('offset', offset);
    const r = await fetch(url);
    if(!r.ok) throw new Error('Erreur chargement clients');
    const page = await r.json();
    all = all.concat(page || []);
    if(!page || page.length < limit) break;
    offset += limit;
  }
  return all;
}

async function deleteClient(id){
  const r = await fetch(`${API}/api/clients/${encodeURIComponent(id)}`, { method:'DELETE' });
  if(!r.ok) throw new Error('Suppression refus√©e');
  return true;
}

// Associer une carte RFID √† un client
async function assignRfidToClient(client){
  // 1) Demander l‚ÄôUID (on pourra plus tard le recevoir automatiquement de l‚ÄôESP32)
  let uid = prompt(`UID de la carte RFID pour "${client.first_name || ''} ${client.last_name || ''}" ?\n(ex: 69 88 DB B2 ou 6988DBB2)`);
  if(!uid) return; // annul√©
  uid = uid.replace(/\s+/g,'').toUpperCase(); // supprime espaces, met en MAJ

  // Optionnel : possibilit√© de taper un token personnalis√©, sinon on laisse vide
  let token = prompt('Code √† √©crire dans les blocs (laisser vide pour g√©n√©rer automatiquement tontonmoh1, 2, ...) :') || '';
  token = token.trim();

  msg.textContent = 'Association RFID en cours‚Ä¶';
  msg.className = 'muted';

  try{
    const r = await fetch(API + '/api/rfid/assign', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({
        client_id: client.id,
        rfid_uid: uid,
        rfid_token: token || undefined  // si vide, le Worker g√©n√®re tontonmohX
      })
    });

    const data = await r.json();
    if(!r.ok || !data.ok){
      throw new Error(data.error || 'Erreur API RFID');
    }

    msg.textContent = `Carte RFID associ√©e ‚úîÔ∏è (token: ${data.rfid_token})`;
    msg.className = 'success';

    // On recharge la liste pour voir les nouvelles valeurs
    await load(qInput.value);
  }catch(e){
    console.error(e);
    msg.textContent = 'Erreur RFID: ' + e.message;
    msg.className = 'error';
  }
}

// --------- UI
const listBox    = document.getElementById('list');
const msg        = document.getElementById('msg');
const countLine  = document.getElementById('countLine');
const qInput     = document.getElementById('q');
const searchBtn  = document.getElementById('searchBtn');
const resetBtn   = document.getElementById('resetBtn');
const refreshBtn = document.getElementById('refreshBtn');

let currentData = [];

function renderList(data){
  listBox.innerHTML = '';
  if(!data.length){
    listBox.appendChild(el('p', { class:'muted' }, 'Aucun client.'));
    return;
  }

  data.forEach((c, i)=>{
    const idx = (i+1) + ') ';
    const rfidLabel = c.rfid_token ? ` [RFID: ${c.rfid_token}]` : ' [RFID: ‚Äî]';

    const line = el('div', {
      class:'row',
      style:'justify-content:space-between; align-items:center; gap:.75rem; padding:.4rem 0; border-bottom:1px dashed var(--muted,#eee);'
    }, [
      el('div', {}, [
        el('b', {}, idx),
        document.createTextNode(`${(c.first_name||'').trim()} ${(c.last_name||'').trim()}  `),
        el('span', { class:'muted' },
          ` ${c.email || '‚Äî'}  ${telNice(c.phone_e164)}  ${c.code_public || ''}${rfidLabel}`
        )
      ]),
      el('div', { class:'row', style:'gap:.4rem' }, [
        el('button', {
          class:'btn outline',
          'data-role':'rfid',
          title:'Associer/mettre √† jour une carte RFID pour ce client',
          style:'--btn-bg:transparent;'
        }, 'RFID'),
        el('button', {
          class:'btn outline',
          'data-role':'delete',
          title:'Supprimer ce client',
          style:'--btn-bg:transparent;'
        }, 'üóëÔ∏è')
      ])
    ]);

    const rfidBtn = line.querySelector('button[data-role="rfid"]');
    const delBtn  = line.querySelector('button[data-role="delete"]');

    // clic RFID
    rfidBtn.addEventListener('click', () => assignRfidToClient(c));

    // clic suppression
    delBtn.addEventListener('click', async ()=>{
      const name = `${c.first_name||''} ${c.last_name||''}`.trim() || 'Ce client';
      const ok = confirm(`Supprimer le compte "${name}" ?\n\nCette action supprime aussi son solde et ses transactions (ON DELETE CASCADE).`);
      if(!ok) return;
      try{
        delBtn.disabled = true;
        await deleteClient(c.id);
        currentData = currentData.filter(x=>x.id !== c.id);
        renderList(currentData);
        countLine.textContent = `${currentData.length} client(s) affich√©(s).`;
        msg.textContent = 'Compte supprim√© ‚úîÔ∏è';
        msg.className = 'success';
      }catch(e){
        delBtn.disabled = false;
        msg.textContent = 'Erreur suppression: ' + e.message;
        msg.className = 'error';
      }
    });

    listBox.appendChild(line);
  });
}

async function load(query=''){
  try{
    msg.textContent = 'Chargement‚Ä¶'; msg.className='muted';

    const all  = await fetchAllClients();        // on charge tout
    const data = filterClients(query, all);      // on filtre en local

    // tri simple par nom puis pr√©nom
    data.sort((a,b)=>
      (a.last_name  ||'').localeCompare(b.last_name  ||'', 'fr', {sensitivity:'base'}) ||
      (a.first_name ||'').localeCompare(b.first_name ||'', 'fr', {sensitivity:'base'})
    );

    currentData = data;
    countLine.textContent = `${data.length} client(s) au total${query ? ' (filtr√©)' : ''}.`;
    renderList(data);
    msg.textContent = '';
  }catch(e){
    console.error(e);
    msg.textContent = e.message || 'Erreur de chargement.';
    msg.className = 'error';
  }
}

// --------- Events
searchBtn .addEventListener('click', ()=> load(qInput.value));
resetBtn  .addEventListener('click', ()=> { qInput.value=''; load(''); });
refreshBtn.addEventListener('click', ()=> load(qInput.value));
qInput    .addEventListener('keydown', (e)=>{ if(e.key==='Enter') load(qInput.value); });

// premier chargement
load();
</script>
</body>
</html>
