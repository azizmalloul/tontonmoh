<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Caisse ‚Äî Scanner un QR</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
<header class="container center">
  <img src="./assets/logo.png" alt="Chez Tonton Moh" class="logo" />
  <h1>Caisse ‚Äî Montant puis Scan QR</h1>
</header>

<main class="container">
  <!-- SECTION 1 ‚Äî visible au d√©part -->
  <section id="formSection" class="card">
    <h2>1) Montant de l‚Äôachat</h2>
    <form id="amountForm" class="kv">
      <label for="amount">Montant (‚Ç¨)</label>
      <input id="amount" type="number" step="0.01" min="0.01" required />
      <div class="row">
        <button id="startBtn" class="btn" type="submit">D√©marrer le scan</button>
        
        <button id="clientsBtn" class="btn outline" type="button">Liste des clients</button>
      </div>
      <p class="tip">Entrez le montant puis scannez le QR du client. Le passage caisse sera enregistr√© automatiquement.</p>
      <p id="uiMsg" class="muted"></p>
    </form>

    <hr class="muted" />

    <h3>Code manuel (si cam√©ra indisponible)</h3>
    <div class="row">
      <input id="codeInput" type="text" placeholder="Code public (ex: RKDZDR)" />
      <button id="manualBtn" class="btn" type="button">Valider avec ce code</button>
    </div>
    <p class="tip">
      <small>
        Le QR contient le code public (6 caract√®res). Vous pouvez le saisir ici si la cam√©ra ne fonctionne pas.
      </small>
    </p>
  </section>

  <!-- SECTION 2 ‚Äî cach√©e, remplace la section 1 pendant le scan -->
  <section id="scanSection" class="card hidden">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0">2) Scanner le QR</h2>
    
      <div class="row" style="gap:10px">
        <!-- Basculer cam√©ra (2 fl√®ches) -->
        <button id="switchBtn" class="icon-btn" type="button" title="Basculer cam√©ra">
          <img
            src="./assets/icon_switch_camera.png"
            alt="Basculer cam√©ra"
            class="icon-img"
          />
        </button>
    
        <!-- Retour (fl√®che demi-cercle) -->
        <button id="backBtn" class="icon-btn" type="button" title="Retour">
          <img
            src="./assets/icon_retour_arriere.png"
            alt="Retour"
            class="icon-img"
          />
        </button>
      </div>
    </div>

    <div id="scanBox">
      <video id="preview" playsinline muted></video>
      <div id="overlayName" class="overlay-name"></div>
      <p id="scanStatus" class="muted">Visez le QR‚Ä¶</p>
    </div>

    <div id="clientCard" class="card" style="display:none">
      <h3 id="clientName">Client</h3>
      <button id="adminBtn" class="btn outline" type="button" >
        ‚öôÔ∏è Admin
      </button>
      <p class="muted kv">Code : <b id="clientCode"></b></p>

      
      <p class="muted kv">Cumul achats : <b id="clientTotal">0,00 ‚Ç¨</b></p>
      <p class="muted kv">Bonus dispo : <b id="clientBonus">0,00 ‚Ç¨</b></p>

      <p class="kv">
        Montant de cet achat : <b id="clientCurrentAmount">0,00 ‚Ç¨</b>
      </p>

      
      <label class="checkbox" style="margin-top:10px">
        <input id="useBonus" type="checkbox" />
        Utiliser mon bonus maintenant
      </label>

      <!-- üí∂ Montant tendu / Montant √† rendre -->
      <div id="cashRow" class="row" style="margin-top:10px">
        <div style="flex:1; min-width:130px">
          <label for="cashGiven">Montant tendu (‚Ç¨)</label>
          <input id="cashGiven" type="number" step="0.01" min="0" />
        </div>
        <div style="flex:1; min-width:130px">
          <label for="cashChange">Montant √† rendre (‚Ç¨)</label>
          <input id="cashChange" type="number" step="0.01" min="0" readonly />
        </div>
      </div>

      
      <div class="row" style="margin-top:10px">
        <button id="payBtn" class="btn" type="button">Encaisser</button>
      </div>
      
            
      <p id="formMsg" class="muted"></p>
    </div>
  </section>

  <!-- Admin panel (hidden) -->
  <section id="adminPanel" class="card hidden">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0">Compte client (Admin)</h2>
      <div class="row">
        <button id="adminClose" class="btn outline" type="button">Fermer</button>
      </div>
    </div>
  
    <div id="adminInfo" class="kv">
      <p><b id="adminName">‚Äî</b></p>
      <p class="muted">Code : <b id="adminCode">‚Äî</b></p>
    </div>
  
    <hr class="muted"/>
  
    <h3>Ajuster cumul / bonus</h3>
    <form id="adminForm" class="grid">
      <div>
        <label for="adminBalance">Cumul achats (en ‚Ç¨)</label>
        <input id="adminBalance" type="number" step="0.01" min="0" />
      </div>
      <div>
        <label for="adminBonus">Bonus (en ‚Ç¨)</label>
        <input id="adminBonus" type="number" step="0.01" min="0" />
      </div>
      <div style="grid-column:1/-1" class="row">
        <button id="adminSave" class="btn" type="submit" style="width:100%">
          Enregistrer l‚Äôajustement
        </button>
      </div>
      <p id="adminMsg" class="muted"></p>
    </form>

  
    <hr class="muted"/>
  
    <h3>Derni√®res op√©rations</h3>
    <div id="adminTxList" class="kv"></div>
  </section>

</main>

<!-- Librairie scanner -->
<script src="https://unpkg.com/@zxing/browser@latest"></script>
<script>
/* ====== PARAMS ====== */
const API = 'https://tontonmoh-api.azizekarma.workers.dev';
const USE_BY_CODE_ROUTE = true;
const CASHIER_ID = 'cash_001';
const LS_CAM_ID = 'tm_camera_id';
const LS_LAST_AMOUNT = 'tm_last_amount';
const COOLDOWN_MS = 15000;
const LS_LAST_RECEIPT = 'tm_last_receipt';

/* ====== EL√âMENTS ====== */
const formSection = document.getElementById('formSection');
const scanSection = document.getElementById('scanSection');

const amountForm  = document.getElementById('amountForm');
const amountInput = document.getElementById('amount');
const startBtn    = document.getElementById('startBtn');
const switchBtn   = document.getElementById('switchBtn');
const uiMsg       = document.getElementById('uiMsg');

const codeInput   = document.getElementById('codeInput');
const manualBtn   = document.getElementById('manualBtn');

const backBtn     = document.getElementById('backBtn');
const video       = document.getElementById('preview');
const scanStatus  = document.getElementById('scanStatus');
const overlayName = document.getElementById('overlayName');

const clientCard    = document.getElementById('clientCard');
const clientName    = document.getElementById('clientName');
const clientCode    = document.getElementById('clientCode');

const formMsg       = document.getElementById('formMsg');
const clientsBtn   = document.getElementById('clientsBtn');

const clientTotal  = document.getElementById('clientTotal');
  
const clientBonus  = document.getElementById('clientBonus');
const useBonus     = document.getElementById('useBonus');
const payBtn       = document.getElementById('payBtn');
let pendingClient  = null;

const clientCurrentAmount = document.getElementById('clientCurrentAmount');
let currentAmountCents = 0;   // montant de cet achat

// üí∂ nouveaux champs
const cashGivenInput  = document.getElementById('cashGiven');
const cashChangeInput = document.getElementById('cashChange');
const cashRow = document.getElementById('cashRow');

// conteneurs pour pouvoir les cacher / r√©afficher
const useBonusContainer = useBonus.closest('label');   // le label .checkbox
const payBtnRow         = payBtn.parentElement;        // le <div class="row"> autour d‚ÄôEncaisser


/* ====== √âTAT ====== */
const reader = new ZXingBrowser.BrowserQRCodeReader();
let devicesCache = [];
let currentDeviceId = localStorage.getItem(LS_CAM_ID) || null;
let busy = false;
let queuedNext = null;
const lastScan = new Map();

const ADMIN_KEY_LS = 'aziz';        // on m√©morise la cl√© admin localement
let currentClient = null;           // client courant

let adminBaseTotalCents = 0;
let adminBaseBonusCents = 0;

const adminBtn     = document.getElementById('adminBtn');
const adminPanel   = document.getElementById('adminPanel');
const adminClose   = document.getElementById('adminClose');
const adminForm    = document.getElementById('adminForm');
const adminName    = document.getElementById('adminName');
const adminCode    = document.getElementById('adminCode');
const adminBalance = document.getElementById('adminBalance');
const adminBonus   = document.getElementById('adminBonus');

const adminMsg     = document.getElementById('adminMsg');
const adminTxList  = document.getElementById('adminTxList');

// üßæ effacer le dernier re√ßu m√©moris√©
function clearLastReceipt() {
  try { localStorage.removeItem(LS_LAST_RECEIPT); } catch (_) {}
}

// üßæ restaurer le dernier re√ßu apr√®s un refresh
function restoreLastReceipt() {
  try {
    const raw = localStorage.getItem(LS_LAST_RECEIPT);
    if (!raw) return;

    const r = JSON.parse(raw);
    if (!r.client || !r.client.id) return;

    currentClient      = r.client;
    pendingClient      = null;
    currentAmountCents = r.amount_cents || 0;

    // on affiche directement la section 2 + carte client
    formSection.classList.add('hidden');
    scanSection.classList.remove('hidden');
    stopCameraStream();      // par s√©curit√©, cam√©ra coup√©e
    collapseScanBox();       // on replie le cadre cam√©ra

    clientCard.style.display = 'block';
    clientName.textContent   = `${currentClient.first_name || ''} ${currentClient.last_name || ''}`.trim() || 'Client';
    clientCode.textContent   = currentClient.code_public || '';
    clientTotal.textContent  = euros(currentClient.total_spent_cents || 0);
    clientBonus.textContent  = euros(currentClient.bonus_cents || 0);
    clientCurrentAmount.textContent = euros(currentAmountCents);

    formMsg.textContent   = 'Achat enregistr√© ‚úîÔ∏è';
    formMsg.className     = 'success';
    scanStatus.textContent = 'Encaissement termin√©. Retournez en arri√®re pour un nouveau client.';

    // apr√®s encaissement : on cache bonus / encaisser / esp√®ces
    if (useBonusContainer) useBonusContainer.style.display = 'none';
    if (payBtnRow)         payBtnRow.style.display = 'none';
    if (cashRow)           cashRow.style.display = 'none';

  } catch (e) {
    console.error('restoreLastReceipt', e);
  }
}


let isSwitching = false;
let cameraWarmed = false;
const LS_FACING = 'tm_facing';
let preferredFacing = localStorage.getItem(LS_FACING) || 'environment'; // back par d√©faut

function pickByFacing(devices, facing){
  const reFront = /(front|user|avant)/i;
  const reBack  = /(back|rear|arri√®re|environment)/i;

  const re = (facing === 'user') ? reFront : reBack;
  const cand = devices.find(d => re.test(d.label || ''));
  return cand?.deviceId || null;
}

function pickDifferentDevice(devices, currentId){
  if (devices.length <= 1) return currentId || devices[0]?.deviceId || null;
  const other = devices.find(d => d.deviceId !== currentId);
  return other?.deviceId || devices[0]?.deviceId || null;
}


/* ====== UTILS ====== */
function euros(c){
  return (Number(c||0)/100)
    .toFixed(2)          // 12.50
    .replace('.', ',')   // 12,50
    + ' ‚Ç¨';
}

// --- Helpers pour affichage historique fa√ßon "Mon compte" ---

// QR / RFID / ADMIN en fonction de la note
function txMode(tx) {
  const note = (tx.note || '').toLowerCase();
  if (note.includes('rfid'))   return 'RFID';
  if (note.includes('[admin')) return 'ADMIN';
  return 'QR';
}

// m√™me r√®gle que sur mon-compte (10 %)
const BONUS_RATE = 0.10;
function bonusForTx(amount_cents) {
  return Math.round(Number(amount_cents || 0) * BONUS_RATE);
}

// Une ligne "bloc gris" (2 lignes) pour une transaction
function txRow(tx){
  const sign = tx.status === 'OK' ? '+' : '¬±';
  const dt   = new Date(tx.created_at || tx.createdAt || tx.ts || Date.now());
  const pad  = n => String(n).padStart(2, '0');

  const date = `${pad(dt.getDate())}/${pad(dt.getMonth()+1)}/${dt.getFullYear()}`;
  const time = `${pad(dt.getHours())}:${pad(dt.getMinutes())}:${pad(dt.getSeconds())}`;

  const mode      = txMode(tx);                       // QR / RFID / ADMIN
  const amountStr = `${sign} ${euros(tx.amount_cents)}`;
  const bonusStr  = euros(bonusForTx(tx.amount_cents));
  const note      = tx.note ? ` ‚Äî ${tx.note}` : '';

  return `
    <tr class="tx-row">
      <td colspan="3">
        <div class="tx-box">
          <div class="tx-grid">
            <div class="tx-date">${date}</div>
            <div class="tx-mode">${mode}</div>
            <div class="tx-amount">${amountStr} / ${bonusStr}</div>
            <div class="tx-subline">${time}${note}</div>
          </div>
        </div>
      </td>
    </tr>`;
}


function validAmount(){
  const v = parseFloat(String(amountInput.value).replace(',','.'));
  return (v && v>0) ? Math.round(v*100) : 0;
}

function updateChangePreview(){
  if (!cashGivenInput || !cashChangeInput) return;
  if (!currentAmountCents || !pendingClient){
    cashChangeInput.value = '';
    cashChangeInput.classList.remove('negatif');
    cashGivenInput.classList.remove('negatif');
    return;
  }

  // Montant tendu dans la petite case
  const v = parseFloat(String(cashGivenInput.value).replace(',', '.'));
  if (!v && v !== 0){
    cashChangeInput.value = '';
    cashChangeInput.classList.remove('negatif');
    cashGivenInput.classList.remove('negatif');
    return;
  }
  const tenderedCents = Math.round(v * 100);

  // Bonus dispo si coch√©
  let bonusAvail = 0;
  if (useBonus.checked){
    bonusAvail = Number(pendingClient.bonus_cents || 0);
  }

  // Bonus utilis√© (max = montant achat)
  const bonusUsed = Math.min(bonusAvail, currentAmountCents);

  // Montant r√©ellement √† payer
  const toPayCents = currentAmountCents - bonusUsed;

  // Change √† rendre (peut √™tre NEGATIF)
  const changeCents = tenderedCents - toPayCents;

  // affichage brut (ex: -3.70 si le client doit encore 3,70 ‚Ç¨)
  cashChangeInput.value = (changeCents / 100).toFixed(2);

  // style rouge si montant NEGATIF
  const isNegative = changeCents < 0;
  cashChangeInput.classList.toggle('negatif', isNegative);
  cashGivenInput.classList.toggle('negatif', isNegative);
}


function showOverlay(text, opts = {}){
  const { duration = 3000, onHide } = opts;
  overlayName.textContent = text;
  overlayName.classList.add('show');
  clearTimeout(showOverlay._t);
  showOverlay._t = setTimeout(()=>{
    overlayName.classList.remove('show');
    if (typeof onHide === 'function') onHide();
  }, duration);
}

function collapseScanBox(){
  const box = document.getElementById('scanBox');
  if (!box) return;
  box.classList.add('scan-box-collapsed');
  scanStatus.textContent = '';
}

function expandScanBox(){
  const box = document.getElementById('scanBox');
  if (!box) return;
  box.classList.remove('scan-box-collapsed');
  scanStatus.textContent = 'Visez le QR‚Ä¶';
}


async function listCameras(){
  const list = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
  devicesCache = list;
  return list;
}
function pickRearCamera(devices){
  const re = /(back|arri√®re|rear|environment)/i;
  const cand = devices.find(d => re.test(d.label || ''));
  return cand?.deviceId || devices[devices.length - 1]?.deviceId || devices[0]?.deviceId || null;
}
async function warmUpCameraPermission(){
  try { const s = await navigator.mediaDevices.getUserMedia({ video:true, audio:false }); s.getTracks().forEach(t=>t.stop()); } catch(_) {}
}
function beep(){
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type='square';
    o.frequency.value = 880;
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.18);
    o.connect(g); g.connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime + 0.2);
  }catch(_){}
}

/* ====== API ====== */
async function fetchClientByCode(code){
  const url = USE_BY_CODE_ROUTE
    ? `${API}/api/clients/by-code/${encodeURIComponent(code)}`
    : `${API}/api/clients?code_public=${encodeURIComponent(code)}`;
  const r = await fetch(url);
  if (!r.ok) throw new Error('Code inconnu');
  return await r.json();
}
async function postTransaction(cli, amount_cents, use_bonus){
  const txId = 'tx_' + Date.now();
  const r = await fetch(`${API}/api/transactions`, {
    method: 'POST',
    headers: { 'Content-Type':'application/json', 'X-Idempotency-Key': txId },
    body: JSON.stringify({
      id: txId,
      client_id: cli.id,
      cashier_id: CASHIER_ID,
      amount_cents,
      status: 'OK',
      note: 'Achat en caisse',
      use_bonus: !!use_bonus
    }),
  });
  const txt = await r.text(); let j={}; try{ j=JSON.parse(txt) }catch{}
  if (!r.ok) throw new Error(j.error||txt||'Erreur API');
  return j;
}

async function fetchClientFull(clientId){
  const r = await fetch(`${API}/api/clients/${encodeURIComponent(clientId)}/full`);
  if(!r.ok) throw new Error('Impossible de charger le compte client');
  return await r.json();
}
async function adminAdjustBalance(clientId, newTotalSpentCents, newBonusCents, reason, cashierId) {
  const adminKey = localStorage.getItem(ADMIN_KEY_LS) || '';
  if (!adminKey) throw new Error('Cl√© admin manquante');

  const body = {
    client_id: clientId,
    set_total_spent_cents: newTotalSpentCents,
    set_bonus_cents: newBonusCents,
    reason: reason || '',
    cashier_id: cashierId || CASHIER_ID
  };

  const r = await fetch(`${API}/api/admin/balances/adjust`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Admin-Key': adminKey
    },
    body: JSON.stringify(body)
  });

  const j = await r.json().catch(() => ({}));
  if (!r.ok || !j.ok) {
    throw new Error(j.error ? `Erreur admin: ${j.error}` : 'Ajustement refus√©');
  }
  return j; // { ok, bonus_cents, bonus_progress_cents, total_spent_cents }
}


/* ====== UI CLIENT ====== */
function showClient(cli){
  currentClient = cli;
  pendingClient = cli;

  clientName.textContent = `${cli.first_name||''} ${cli.last_name||''}`.trim() || 'Client';
  clientCode.textContent = cli.code_public || '';

  clientTotal.textContent = euros(cli.total_spent_cents || 0);
  clientBonus.textContent = euros(cli.bonus_cents || 0);

  useBonus.checked = false;
  clientCard.style.display = 'block';
  adminBtn.style.display = 'inline-block';

  // ‚ûú on r√©-affiche la case bonus + le bouton Encaisser
  if (useBonusContainer) useBonusContainer.style.display = 'flex';
  if (payBtnRow)         payBtnRow.style.display = 'flex';

  // ‚ûú on r√©-affiche la ligne "Montant tendu / Montant √† rendre"
  if (cashRow) cashRow.style.display = 'flex';

  // reset des champs esp√®ces
  if (cashGivenInput)  cashGivenInput.value  = '';
  if (cashChangeInput) cashChangeInput.value = '';

  // üîÑ recalcul au cas o√π
  updateChangePreview();
 
}


/* ====== SCAN QR (cam√©ra) ====== */

const readerInstance = reader; // juste pour √™tre clair

async function startScanner(opts = {}) {
  const { forceDevice = false, keepUI = false } = opts;

  expandScanBox();   // on r√©-affiche le carr√© cam√©ra

  const amountCents = validAmount();
  if (!amountCents){
    uiMsg.textContent='Entrez le montant avant de scanner.';
    uiMsg.className='error';
    return;
  }
  currentAmountCents = amountCents;                      // on garde ce montant
  clientCurrentAmount.textContent = euros(amountCents);  // pr√©-affiche dans la fiche client
  updateChangePreview(); 



  if (!keepUI) {
    formSection.classList.add('hidden');
    scanSection.classList.remove('hidden');
  }

  try{
    if (!cameraWarmed) {
      await warmUpCameraPermission();
      cameraWarmed = true;
    }

    let devices = await listCameras();
    if (!devices.length){ await new Promise(r=>setTimeout(r,150)); devices = await listCameras(); }
    if (!devices.length){ scanStatus.textContent='Aucune cam√©ra d√©tect√©e (permission ?)'; return; }

    // si on n'impose pas un device, on suit preferredFacing
    if (!forceDevice) {
      const byFacing = pickByFacing(devices, preferredFacing);
      if (byFacing) {
        currentDeviceId = byFacing;
      } else if (!currentDeviceId || !devices.some(d => d.deviceId === currentDeviceId)) {
        currentDeviceId = devices[0]?.deviceId || null;
      }
      if (currentDeviceId) localStorage.setItem(LS_CAM_ID, currentDeviceId);
    } else {
      // forceDevice=true : on garde currentDeviceId si possible
      if (!currentDeviceId || !devices.some(d => d.deviceId === currentDeviceId)) {
        const byFacing = pickByFacing(devices, preferredFacing);
        currentDeviceId = byFacing || devices[0]?.deviceId || null;
        if (currentDeviceId) localStorage.setItem(LS_CAM_ID, currentDeviceId);
      }
    }

    switchBtn.style.display = devices.length > 1 ? 'inline-flex' : 'none';

    const constraints = {
      video: currentDeviceId ? { deviceId: { exact: currentDeviceId } } : { facingMode:{ ideal:'environment' } },
      audio: false
    };

    scanStatus.textContent = 'Scanner pr√™t. Visez le QR‚Ä¶';

    await reader.decodeFromConstraints(constraints, video, async (result, err) => {
      if (err && !(err instanceof ZXingBrowser.NotFoundException)) return;
      if (!result) return;
    
      const code = result.getText().trim().toUpperCase();
      const now  = Date.now();
    
      const last = lastScan.get(code) || 0;
      if (now - last < COOLDOWN_MS) return;
    
      if (busy) return;
    
      busy = true;
      lastScan.set(code, now);
    
      try {
        // on m√©morise le dernier montant
        localStorage.setItem(LS_LAST_AMOUNT, String(amountInput.value));
    
        // on charge le client
        const cli = await fetchClientByCode(code);
        showClient(cli);

        // montant de cet achat dans la fiche
        clientCurrentAmount.textContent = euros(currentAmountCents);

        const fullName = `${cli.first_name || ''} ${cli.last_name || ''}`.trim() || 'Client';

        // Affiche le nom 1 seconde, puis replie le carr√© cam√©ra
        showOverlay(fullName, {
          duration: 1000,
          onHide: collapseScanBox
        });

        formMsg.textContent  = 'Choisissez bonus ou non, puis cliquez ‚ÄúEncaisser‚Äù.';
        formMsg.className    = 'muted';
        scanStatus.textContent = 'En attente encaissement‚Ä¶';
        beep();

      } catch (e) {
        console.error(e);
        formMsg.textContent = 'Erreur: ' + e.message;
        formMsg.className   = 'error';
      } finally {
        busy = false;
      }
    });


    // Lampe
    try{
      const track = video.srcObject ? video.srcObject.getVideoTracks()[0] : null;
      const caps = track?.getCapabilities?.();
      if (caps && 'torch' in caps && !document.getElementById('torchBtn')){
        const torchBtn = document.createElement('button');
        torchBtn.id='torchBtn'; torchBtn.type='button';
        torchBtn.className='btn outline'; torchBtn.textContent='Lampe';
        torchBtn.addEventListener('click', async ()=>{
          const s = track.getSettings();
          await track.applyConstraints({ advanced:[{ torch: !s.torch }] });
        });
        document.getElementById('scanBox').appendChild(torchBtn);
      }
    }catch(_){}
  }catch(e){
    console.error(e);
    scanStatus.textContent = 'Impossible d‚Äôacc√©der √† la cam√©ra. V√©rifiez les permissions.';
  }
}

function stopCameraStream(){
  try { reader.reset(); } catch(_) {}

  try{
    const s = video.srcObject;
    if (s){
      s.getTracks().forEach(t => t.stop());
    }
    video.srcObject = null;
  }catch(_){}
}
  
function stopScanner(fully=true){
  if (fully){
    stopCameraStream();  // coupe vraiment la cam√©ra
  }
  scanSection.classList.add('hidden');
  formSection.classList.remove('hidden');
  clientCard.style.display='none';
  formMsg.textContent='';
  scanStatus.textContent='Visez le QR‚Ä¶';
}


amountForm.addEventListener('submit', (e) => {
  e.preventDefault();
  clearLastReceipt();   // üëâ on oublie l‚Äôancien ticket
  startScanner();
});

switchBtn.addEventListener('click', async () => {
  if (isSwitching) return;
  isSwitching = true;
  switchBtn.disabled = true;

  try {
    // üî• toggle facing (back <-> front)
    preferredFacing = (preferredFacing === 'environment') ? 'user' : 'environment';
    localStorage.setItem(LS_FACING, preferredFacing);

    // stop propre
    try { reader.reset(); } catch(_) {}
    try {
      const s = video.srcObject;
      if (s) s.getTracks().forEach(t => t.stop());
      video.srcObject = null;
    } catch(_) {}

    scanStatus.textContent = "Changement de cam√©ra‚Ä¶";

    // refresh devices apr√®s stop (important)
    const devs = await listCameras();
    if (!devs.length) { scanStatus.textContent = "Aucune cam√©ra."; return; }

    // ‚úÖ choisir directement la bonne cam√©ra (front/back)
    const wanted = pickByFacing(devs, preferredFacing);
    currentDeviceId = wanted || pickDifferentDevice(devs, currentDeviceId);
    if (currentDeviceId) localStorage.setItem(LS_CAM_ID, currentDeviceId);

    // petit d√©lai
    await new Promise(r => setTimeout(r, 10));
    
    // relance
    await startScanner({ forceDevice: true, keepUI: true });
    
    // fallback si Safari est lent
    if (!(video.srcObject && video.readyState >= 2)) {
    await new Promise(r => setTimeout(r, 120));
    try { reader.reset(); } catch(_) {}
    await startScanner({ forceDevice: true, keepUI: true });
  }

  } catch (e) {
    console.error(e);
    scanStatus.textContent = "Impossible de basculer la cam√©ra.";
  } finally {
    switchBtn.disabled = false;
    isSwitching = false;
  }
});

backBtn.addEventListener('click', () => {
  clearLastReceipt();   // üëâ on oublie le ticket
  stopScanner(true);
});

clientsBtn.addEventListener('click', () => {
  window.location.href = './liste_clients.html';
});

manualBtn.addEventListener('click', async () => {
  clearLastReceipt();   // üëâ nouveau passage, on efface l‚Äôancien
  const code = (codeInput.value || '').trim().toUpperCase();
  if (!code) {
    uiMsg.textContent = 'Entrez un code.';
    uiMsg.className   = 'error';
    return;
  }
  const amount_cents = validAmount();
  if (!amount_cents) {
    uiMsg.textContent = 'Entrez le montant avant de valider.';
    uiMsg.className   = 'error';
    return;
  }
  currentAmountCents = amount_cents;
  clientCurrentAmount.textContent = euros(currentAmountCents);
  updateChangePreview();

  try {
    const now  = Date.now();
    const last = lastScan.get(code) || 0;
    if (now - last < COOLDOWN_MS) {
      uiMsg.textContent = 'M√™me client scann√© r√©cemment ‚Äî patientez quelques secondes.';
      uiMsg.className   = 'error';
      return;
    }
    lastScan.set(code, now);

    localStorage.setItem(LS_LAST_AMOUNT, String(amountInput.value));

    formSection.classList.add('hidden');
    scanSection.classList.remove('hidden');

    const cli = await fetchClientByCode(code);
    showClient(cli);

    const fullName = `${cli.first_name || ''} ${cli.last_name || ''}`.trim() || 'Client';
    showOverlay(fullName, {
      duration: 1000,
      onHide: collapseScanBox
    });

    formMsg.textContent  = 'Choisissez bonus ou non, puis cliquez ‚ÄúEncaisser‚Äù.';
    formMsg.className    = 'muted';
    scanStatus.textContent = 'Vous pouvez maintenant cliquer sur ‚ÄúEncaisser‚Äù.';
    beep();
  } catch (err) {
    console.error(err);
    formMsg.textContent = 'Erreur: ' + err.message;
    formMsg.className   = 'error';
  }
});


/* ====== ADMIN UI ====== */
adminBtn.addEventListener('click', async ()=>{
  try{
    if(!currentClient) return;
    let key = localStorage.getItem(ADMIN_KEY_LS);
    if(!key){
      key = prompt('Cl√© Admin ?');
      if(!key) return;
      localStorage.setItem(ADMIN_KEY_LS, key);
    }
    adminMsg.textContent = 'Chargement‚Ä¶';
    const full = await fetchClientFull(currentClient.id);

    const name = `${full.client.first_name||''} ${full.client.last_name||''}`.trim();
    adminName.textContent = name || 'Client';
    adminCode.textContent = full.client.code_public || '';

    const balCents   = Number(full.balance?.total_spent_cents || 0);
    const bonusCents = Number(full.balance?.bonus_cents || 0);

    adminBaseTotalCents = balCents;
    adminBaseBonusCents = bonusCents;
    
    adminBalance.value = (balCents / 100).toFixed(2);
    adminBonus.value   = (bonusCents / 100).toFixed(2);


    const txs = full.transactions || [];
    if (txs.length) {
      adminTxList.innerHTML = `
        <div style="overflow:auto">
          <table class="history">
            <thead>
              <tr>
                <th>Date</th>
                <th>Source</th>
                <th>Montant / Cagnotte</th>
              </tr>
            </thead>
            <tbody>
              ${txs.map(txRow).join('')}
            </tbody>
          </table>
        </div>
      `;
    } else {
      adminTxList.innerHTML = '<p class="muted">Aucune op√©ration r√©cente.</p>';
    }


    adminMsg.textContent = '';
    scanSection.classList.add('hidden');
    formSection.classList.add('hidden');
    adminPanel.classList.remove('hidden');
  }catch(e){
    console.error(e);
    alert(e.message || String(e));
  }
});

adminClose.addEventListener('click', ()=>{
  adminPanel.classList.add('hidden');
  scanSection.classList.remove('hidden');
});

adminForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  try {
    if (!currentClient) return;
    adminMsg.textContent = 'Enregistrement‚Ä¶';
    adminMsg.className   = 'muted';

    // Champ "Cumul achats (en ‚Ç¨)" -> total_spent_cents
    const eurosTotalStr = String(adminBalance.value || '0').replace(',', '.');
    const totalCents = Math.max(
      0,
      Math.round(parseFloat(eurosTotalStr || '0') * 100)
    );

    // Champ "Bonus (en ‚Ç¨)" -> bonus_cents
    const eurosBonusStr = String(adminBonus.value || '0').replace(',', '.');
    const bonusCents = Math.max(
      0,
      Math.round(parseFloat(eurosBonusStr || '0') * 100)
    );

    // üîç d√©tecter ce qui a chang√© par rapport aux valeurs de base
    const cumulChanged    = totalCents !== adminBaseTotalCents;
    const cagnotteChanged = bonusCents !== adminBaseBonusCents;

    let autoReason = '';
    if (cumulChanged && cagnotteChanged) {
      autoReason += 'Ajustement cumul/cagnotte';
    } else if (cumulChanged) {
      autoReason += 'Ajustement cumul';
    } else if (cagnotteChanged) {
      autoReason += 'Ajustement cagnotte';
    } else {
      autoReason += 'Ajustement sans changement';
    }

    // Appel API avec le motif auto
    const res = await adminAdjustBalance(
      currentClient.id,
      totalCents,
      bonusCents,
      autoReason,
      CASHIER_ID
    );

    // Mettre √† jour les valeurs de base pour le prochain ajustement
    adminBaseTotalCents = Number(
      res.total_spent_cents != null ? res.total_spent_cents : totalCents
    );
    adminBaseBonusCents = Number(
      res.bonus_cents != null ? res.bonus_cents : bonusCents
    );

    // Mise √† jour du client en m√©moire
    currentClient.total_spent_cents = adminBaseTotalCents;
    currentClient.bonus_cents       = adminBaseBonusCents;

    // MAJ UI caisse
    clientTotal.textContent = euros(currentClient.total_spent_cents);
    clientBonus.textContent = euros(currentClient.bonus_cents);

    // MAJ UI admin (inputs)
    adminBalance.value = (currentClient.total_spent_cents / 100).toFixed(2);
    adminBonus.value   = (currentClient.bonus_cents / 100).toFixed(2);

    // üü¶ recharger la liste des derni√®res op√©rations pour voir la ligne [ADMIN]
    const full2 = await fetchClientFull(currentClient.id);
    const txs2 = full2.transactions || [];
    if (txs2.length) {
      adminTxList.innerHTML = `
        <div style="overflow:auto">
          <table class="history">
            <thead>
              <tr>
                <th>Date</th>
                <th>Source</th>
                <th>Montant / Cagnotte</th>
              </tr>
            </thead>
            <tbody>
              ${txs2.map(txRow).join('')}
            </tbody>
          </table>
        </div>
      `;
    } else {
      adminTxList.innerHTML = '<p class="muted">Aucune op√©ration r√©cente.</p>';
    }


    adminMsg.textContent = 'Ajustement enregistr√© ‚úîÔ∏è';
    adminMsg.className   = 'success';
  } catch (err) {
    console.error(err);
    adminMsg.textContent = 'Erreur: ' + err.message;
    adminMsg.className   = 'error';
  }
});




payBtn.addEventListener('click', async () => {
  try {
    if (!pendingClient) return;

    const amount_cents = currentAmountCents;
    if (!amount_cents) {
      formMsg.textContent = 'Montant invalide.';
      formMsg.className   = 'error';
      return;
    }

    const use = useBonus.checked;

    // on garde l'ancien bonus pour calculer le "bonus gagn√©"
    const oldBonus = Number(pendingClient.bonus_cents || 0);

    const res = await postTransaction(pendingClient, amount_cents, use);

    const newBonus   = Number(res.bonus_cents || 0);
    const usedBonus  = Number(res.bonus_used_cents || 0);
    const paid       = Number(res.paid_cents != null ? res.paid_cents : amount_cents);
    const earned     = Math.max(0, newBonus - (oldBonus - usedBonus));

    // mettre √† jour le mod√®le local
    pendingClient.bonus_cents       = newBonus;
    pendingClient.total_spent_cents = Number(res.total_spent_cents || 0);

    // MAJ UI
    clientTotal.textContent = euros(pendingClient.total_spent_cents);
    clientBonus.textContent = euros(pendingClient.bonus_cents);

    const fullName = `${pendingClient.first_name || ''} ${pendingClient.last_name || ''}`.trim() || 'ce client';

    showOverlay(
      `‚úÖ Pay√© : ${euros(paid)}\n` +
      (usedBonus ? `üé´ Bonus utilis√© : ${euros(usedBonus)}\n` : '') +
      `üéÅ Bonus gagn√© : ${euros(earned)}\n` +
      `Pour ${fullName}`
    );

    formMsg.textContent   = 'Achat enregistr√© ‚úîÔ∏è';
    formMsg.className     = 'success';
    scanStatus.textContent = 'Encaissement termin√©. Retournez en arri√®re pour un nouveau client.';
    beep();

    // üßæ M√©moriser ce re√ßu pour le retrouver apr√®s un refresh
    try {
      const receipt = {
        client: {
          id: pendingClient.id,
          first_name: pendingClient.first_name,
          last_name: pendingClient.last_name,
          code_public: pendingClient.code_public,
          total_spent_cents: pendingClient.total_spent_cents,
          bonus_cents: pendingClient.bonus_cents
        },
        amount_cents,
        used_bonus_cents: usedBonus,
        paid_cents: paid,
        earned_cents: earned
      };
      localStorage.setItem(LS_LAST_RECEIPT, JSON.stringify(receipt));
    } catch (_) {}


    // üî• on coupe la cam√©ra et le scanner,
    // la carte client reste affich√©e
    stopCameraStream();
    
    // reset logique : pas de 2e encaissement, mais fiche client visible
    pendingClient = null;
    useBonus.checked = false;

    // ‚ûú on masque la case "Utiliser mon bonus" et le bouton Encaisser
    if (useBonusContainer) useBonusContainer.style.display = 'none';
    if (payBtnRow)         payBtnRow.style.display = 'none';

    // ‚ûú on masque aussi "Montant tendu / Montant √† rendre"
    if (cashRow) cashRow.style.display = 'none';

    // et on vide les champs
    if (cashGivenInput)  cashGivenInput.value  = '';
    if (cashChangeInput) cashChangeInput.value = '';



  } catch (e) {
    formMsg.textContent = 'Erreur: ' + e.message;
    formMsg.className   = 'error';
  }
});

// üí∂ recalculer le rendu quand on tape le montant tendu
if (cashGivenInput){
  cashGivenInput.addEventListener('input', updateChangePreview);
}

// üí∂ et aussi quand on coche / d√©coche "Utiliser mon bonus"
if (useBonus){
  useBonus.addEventListener('change', updateChangePreview);
}


// Pr√©-remplir dernier montant
const last = localStorage.getItem(LS_LAST_AMOUNT);
if (last) amountInput.value = last;
// üßæ Si un re√ßu a √©t√© m√©moris√©, on le r√©-affiche
restoreLastReceipt();

</script>
</body>
</html>
