<link rel="stylesheet" href="./styles.css" />

<main class="container card">
  <h1>Encaissement — Scanner le QR</h1>

  <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
    <!-- Colonne gauche : scanner -->
    <section>
      <div id="scanBox" class="center">
        <video id="preview" class="qr" playsinline></video>
        <p class="muted" id="scanStatus">Autorisez l’accès à la caméra pour scanner…</p>
        <button id="toggleCam" class="btn" type="button">Basculer caméra</button>
      </div>
    </section>

    <!-- Colonne droite : fiche client + encaissement -->
    <section>
      <div id="clientBox" class="card" style="display:none">
        <h2 id="clientName"></h2>
        <p class="muted">Code : <b id="clientCode"></b></p>
        <p>Solde cumulé : <b id="clientBalance">0 €</b> — Cadeaux : <b id="clientGifts">0</b></p>

        <form id="payForm">
          <label>Montant (€)</label>
          <input type="number" id="amount" step="0.01" min="0.01" required />
          <div class="row">
            <button class="btn" type="submit">Valider l’achat</button>
            <button class="btn outline" type="button" id="resetScan">Scanner un autre QR</button>
          </div>
        </form>

        <p id="formMsg" class="muted"></p>
      </div>
    </section>
  </div>
</main>

<!-- ZXing scanner -->
<script src="https://unpkg.com/@zxing/browser@latest"></script>
<script>
const API = 'https://tontonmoh-api.azizekarma.workers.dev';
const useRouteByCode = true; // true si tu as implémenté /api/clients/by-code/<CODE>. Sinon mets false pour ?code_public=...

const video = document.getElementById('preview');
const scanStatus = document.getElementById('scanStatus');
const toggleBtn = document.getElementById('toggleCam');

const clientBox = document.getElementById('clientBox');
const clientName = document.getElementById('clientName');
const clientCode = document.getElementById('clientCode');
const clientBalance = document.getElementById('clientBalance');
const clientGifts = document.getElementById('clientGifts');

const payForm = document.getElementById('payForm');
const amountInput = document.getElementById('amount');
const formMsg = document.getElementById('formMsg');
const resetBtn = document.getElementById('resetScan');

let currentClient = null;
let currentDeviceIndex = 0;

const codeReader = new ZXingBrowser.BrowserMultiFormatReader();

async function startScanner() {
  try {
    const devices = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
    if (!devices.length) {
      scanStatus.textContent = 'Aucune caméra détectée.';
      return;
    }
    const deviceId = devices[currentDeviceIndex % devices.length].deviceId;
    await codeReader.decodeFromVideoDevice(deviceId, video, (result, err) => {
      if (result) {
        const code = result.getText().trim().toUpperCase();
        codeReader.reset(); // stop scanning
        scanStatus.textContent = 'QR détecté : ' + code;
        onCodeScanned(code);
      }
      if (err && !(err instanceof ZXingBrowser.NotFoundException)) {
        console.warn(err);
      }
    });
    scanStatus.textContent = 'Scanner prêt. Visez le QR…';
  } catch (e) {
    console.error(e);
    scanStatus.textContent = 'Impossible de démarrer la caméra.';
  }
}

toggleBtn.addEventListener('click', async () => {
  codeReader.reset();
  currentDeviceIndex++;
  await startScanner();
});

async function onCodeScanned(code) {
  // Récupérer le client par code_public
  const url = useRouteByCode
    ? `${API}/api/clients/by-code/${encodeURIComponent(code)}`
    : `${API}/api/clients?code_public=${encodeURIComponent(code)}`;

  const res = await fetch(url);
  if (!res.ok) {
    scanStatus.textContent = 'Code inconnu. Réessayez.';
    await startScanner();
    return;
  }
  const cli = await res.json();
  currentClient = cli;

  clientName.textContent = `${cli.first_name || ''} ${cli.last_name || ''}`.trim() || 'Client';
  clientCode.textContent = cli.code_public;
  clientBalance.textContent = (cli.balance / 100).toFixed(2) + ' €';
  clientGifts.textContent = cli.gifts_count || 0;

  clientBox.style.display = 'block';
}

resetBtn.addEventListener('click', async () => {
  clientBox.style.display = 'none';
  currentClient = null;
  amountInput.value = '';
  formMsg.textContent = '';
  await startScanner();
});

// POST /api/transactions
payForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  formMsg.textContent = '';

  if (!currentClient) {
    formMsg.textContent = 'Aucun client sélectionné.';
    return;
  }
  const euros = parseFloat(amountInput.value.replace(',', '.'));
  if (!euros || euros <= 0) {
    formMsg.textContent = 'Montant invalide.';
    return;
  }
  const amount_cents = Math.round(euros * 100);

  const txId = 'tx_' + Date.now();
  const payload = {
    id: txId,
    client_id: currentClient.id,
    cashier_id: 'cash_001',    // tu peux mettre l’id réel de la caisse
    amount_cents,
    status: 'OK',
    note: 'Achat en caisse',
  };

  try {
    const res = await fetch(`${API}/api/transactions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Idempotency-Key': txId // simple idempotency
      },
      body: JSON.stringify(payload),
    });

    const txt = await res.text();
    let j = {}; try { j = JSON.parse(txt) } catch {}

    if (!res.ok) throw new Error(j.error || txt || 'Erreur API');

    formMsg.textContent = 'Achat enregistré ✔️';
    // maj solde affiché (client côté serveur déjà mis à jour)
    currentClient.balance += amount_cents;
    clientBalance.textContent = (currentClient.balance / 100).toFixed(2) + ' €';
    amountInput.value = '';
  } catch (err) {
    console.error(err);
    formMsg.textContent = 'Erreur: ' + err.message;
  }
});

// démarrer
startScanner();
</script>
