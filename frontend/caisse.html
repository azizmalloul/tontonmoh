<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Caisse ‚Äî Scanner un QR</title>
  <link rel="stylesheet" href="./styles.css" />
  
</head>
<body>
<header class="container center">
  <img src="./assets/logo.png" alt="Chez Tonton Moh" class="logo" />
  <h1>Caisse ‚Äî Montant puis Scan QR</h1>
</header>

<main class="container two-cols">
  <!-- Colonne 1 : Saisie montant + d√©marrage scanner -->
  <section class="card">
    <h2>1) Montant de l‚Äôachat</h2>
    <form id="amountForm" class="kv">
      <label for="amount">Montant (‚Ç¨)</label>
      <input id="amount" type="number" step="0.01" min="0.01" required />
      <div class="row">
        <button id="startBtn" class="btn" type="submit">D√©marrer le scan</button>
        <button id="switchBtn" class="btn outline" type="button" title="Cam√©ra avant/arri√®re">Basculer cam√©ra</button>
      </div>
      <p class="tip">
        Entrez le montant puis scannez le QR du client. Le passage caisse sera enregistr√© automatiquement.
      </p>
      <p id="uiMsg" class="muted"></p>
    </form>

    <hr class="muted" />

    <h3>Code manuel (si cam√©ra indisponible)</h3>
    <div class="row">
      <input id="codeInput" type="text" placeholder="Code public (ex: RKDZDR)" />
      <button id="manualBtn" class="btn" type="button">Valider avec ce code</button>
    </div>
    <p class="tip"><small>
      Astuce : le QR contient le code public (6 caract√®res). Vous pouvez le saisir ici.
    </small></p>
  </section>

  <!-- Colonne 2 : Scanner + fiche client -->
  <section class="card">
    <h2>2) Scanner le QR</h2>
    <div id="scanBox">
      <video id="preview" playsinline muted></video>
      <div id="overlayName" class="overlay-name"></div>

      <p id="scanStatus" class="muted">Appuyez sur ‚ÄúD√©marrer le scan‚Äù.</p>
    </div>

    <div id="clientCard" class="card" style="display:none">
      <h3 id="clientName">Client</h3>
      <p class="muted kv">Code : <b id="clientCode"></b></p>
      <p class="muted kv">Solde cumul√© : <b id="clientBalance">0,00 ‚Ç¨</b> ‚Äî Cadeaux : <b id="clientGifts">0</b></p>
      <p id="formMsg" class="muted"></p>
      <div class="row">
        <button class="btn outline" id="scanAgain" type="button">Scanner un autre QR</button>
      </div>
    </div>
  </section>
</main>

<!-- Librairie scanner -->
<script src="https://unpkg.com/@zxing/browser@latest"></script>
<script>
  // ========= PARAMS =========
  const API = 'https://tontonmoh-api.azizekarma.workers.dev';
  const USE_BY_CODE_ROUTE = true;         // vrai si /api/clients/by-code/:code existe (oui)
  const CASHIER_ID = 'cash_001';
  const LS_CAM_ID = 'tm_camera_id';       // on retient la cam√©ra arri√®re choisie
  const LS_LAST_AMOUNT = 'tm_last_amount';

  // ========= √âL√âMENTS =========
  const amountForm = document.getElementById('amountForm');
  const amountInput= document.getElementById('amount');
  const startBtn   = document.getElementById('startBtn');
  const switchBtn  = document.getElementById('switchBtn');
  const uiMsg      = document.getElementById('uiMsg');

  const video      = document.getElementById('preview');
  const scanStatus = document.getElementById('scanStatus');
  const overlayName = document.getElementById('overlayName');
  function showOverlay(text){
    overlayName.textContent = text;
    overlayName.classList.add('show');
    clearTimeout(showOverlay._t);
    showOverlay._t = setTimeout(()=>overlayName.classList.remove('show'), 1800);
  }


  const codeInput  = document.getElementById('codeInput');
  const manualBtn  = document.getElementById('manualBtn');

  const clientCard   = document.getElementById('clientCard');
  const clientName   = document.getElementById('clientName');
  const clientCode   = document.getElementById('clientCode');
  const clientBalance= document.getElementById('clientBalance');
  const clientGifts  = document.getElementById('clientGifts');
  const formMsg      = document.getElementById('formMsg');
  const scanAgainBtn = document.getElementById('scanAgain');

  const COOLDOWN_MS = 15000;           // 15 s entre deux scans du M√äME code
  const lastScan = new Map();          // code_public -> timestamp du dernier scan accept√©
  let busy = false;                    // true pendant l'enregistrement d'un achat
  let queuedNext = null;               // si un autre code arrive pendant busy, on le met en file
  

  // ========= √âTAT =========
  let scanning = false;             // on garde la cam√©ra ouverte, mais on ‚Äúpause‚Äù la lecture
  let currentClient = null;
  let currentDeviceId = localStorage.getItem(LS_CAM_ID) || null;
  let devicesCache = [];
  const reader = new ZXingBrowser.BrowserQRCodeReader(); // QR seulement ‚Üí meilleure d√©tection

  // ========= OUTILS =========
  function euros(cents){ return (Number(cents||0)/100).toFixed(2) + ' ‚Ç¨'; }
  function validAmount(){
    const v = parseFloat(String(amountInput.value).replace(',','.'));
    return (v && v>0) ? Math.round(v*100) : 0;
  }

  async function listCameras(){
    const list = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
    devicesCache = list;
    return list;
  }

  function pickRearCamera(devices){
    // 1) si on a un deviceId m√©moris√© : on le reprend
    if (currentDeviceId && devices.some(d=>d.deviceId===currentDeviceId)) return currentDeviceId;
    // 2) on cherche un label 'back'/'rear'/'environment'
    const re = /(back|arri√®re|rear|environment)/i;
    const cand = devices.find(d=>re.test(d.label));
    if (cand) return cand.deviceId;
    // 3) sinon, on prend le dernier (souvent la cam√©ra arri√®re sur mobile)
    return (devices[devices.length-1] || devices[0])?.deviceId || null;
  }

  async function startScanner(){
    const amountCents = validAmount();
    if (!amountCents){
      uiMsg.textContent = 'Entrez le montant avant de scanner.';
      uiMsg.className = 'err';
      return;
    }
    uiMsg.textContent = '';
    uiMsg.className = 'muted';
  
    try{
      const devices = await listCameras();
      if (!devices.length){
        scanStatus.textContent = 'Aucune cam√©ra d√©tect√©e.';
        return;
      }
      // choisir l‚Äôarri√®re et m√©moriser
      const deviceId = pickRearCamera(devices);
      currentDeviceId = deviceId;
      localStorage.setItem(LS_CAM_ID, deviceId);
  
      // Contraintes vid√©o ‚Äúpropres‚Äù pour mobile
      const constraints = {
        video: {
          deviceId: { exact: deviceId },
          facingMode: { ideal: 'environment' },
          width:  { ideal: 1280 },
          height: { ideal: 720 },
          advanced: [
            { focusMode: 'continuous' },
            { focusMode: 'auto' }
          ]
        },
        audio: false
      };
  
      scanning = true;
  
      // ‚¨áÔ∏è ICI on LANCE vraiment le scan avec decodeFromConstraints ‚¨áÔ∏è
      await reader.decodeFromConstraints(constraints, video, async (result, err) => {
        if (err && !(err instanceof ZXingBrowser.NotFoundException)) {
          // erreurs non fatales ‚Üí on ignore
          return;
        }
        if (!result) return;
  
        const code = result.getText().trim().toUpperCase();
        const now  = Date.now();
  
        // 1) Anti-rescan du M√äME code pendant 15 s
        const last = lastScan.get(code) || 0;
        if (now - last < COOLDOWN_MS) {
          return; // on ignore juste ce m√™me QR
        }
  
        // 2) Si un achat est d√©j√† en cours ‚Üí file d‚Äôattente pour un AUTRE code
        if (busy) {
          if (queuedNext !== code) {
            queuedNext = code;
            showOverlay('Patienter‚Ä¶');
          }
          return;
        }
  
        // 3) Traiter maintenant
        busy = true;
        lastScan.set(code, now);
        scanStatus.textContent = 'QR d√©tect√© : ' + code;
        showOverlay(code); // affiche le code imm√©diatement
  
        try {
          localStorage.setItem(LS_LAST_AMOUNT, String(amountInput.value));
          // r√©cup√®re le client
          const cli = await fetchClientByCode(code);
          showClient(cli);
          const fullname = `${cli.first_name || ''} ${cli.last_name || ''}`.trim() || 'Client';
          showOverlay(fullname); // remplace par le NOM au centre
  
          // enregistre la transaction
          const amount_cents = validAmount();
          await postTransaction(cli, amount_cents);
  
          // MAJ solde affich√©
          cli.balance += amount_cents;
          clientBalance.textContent = (cli.balance/100).toFixed(2) + ' ‚Ç¨';
          formMsg.textContent = 'Achat enregistr√© ‚úîÔ∏è'; formMsg.className = 'ok';
          scanStatus.textContent = 'Pr√™t pour un autre QR‚Ä¶';
        } catch (e) {
          console.error(e);
          formMsg.textContent = 'Erreur: ' + e.message; formMsg.className = 'err';
        } finally {
          busy = false;
  
          // 4) Si un AUTRE code est arriv√© pendant le traitement, encha√Æne-le tout de suite
          if (queuedNext) {
            const nextCode = queuedNext;
            queuedNext = null;
  
            const now2 = Date.now();
            const last2 = lastScan.get(nextCode) || 0;
            if (now2 - last2 >= COOLDOWN_MS) {
              // retravailler le prochain code
              busy = true;
              lastScan.set(nextCode, now2);
              scanStatus.textContent = 'QR d√©tect√© : ' + nextCode;
              showOverlay(nextCode);
              try{
                const cli2 = await fetchClientByCode(nextCode);
                showClient(cli2);
                const fullname2 = `${cli2.first_name || ''} ${cli2.last_name || ''}`.trim() || 'Client';
                showOverlay(fullname2);
                const amount_cents2 = validAmount();
                await postTransaction(cli2, amount_cents2);
                cli2.balance += amount_cents2;
                clientBalance.textContent = (cli2.balance/100).toFixed(2) + ' ‚Ç¨';
                formMsg.textContent = 'Achat enregistr√© ‚úîÔ∏è'; formMsg.className = 'ok';
                scanStatus.textContent = 'Pr√™t pour un autre QR‚Ä¶';
              } catch(e2){
                console.error(e2);
                formMsg.textContent = 'Erreur: ' + e2.message; formMsg.className = 'err';
              } finally {
                busy = false;
              }
            }
          }
        }
      });
  
      scanStatus.textContent = 'Scanner pr√™t. Visez le QR‚Ä¶';
  
      // üî¶ Bouton lampe si dispo (Android)
      try {
        const track = video.srcObject ? video.srcObject.getVideoTracks()[0] : null;
        const caps  = track?.getCapabilities?.();
        if (caps && 'torch' in caps) {
          if (!document.getElementById('torchBtn')) {
            const torchBtn = document.createElement('button');
            torchBtn.id = 'torchBtn';
            torchBtn.type = 'button';
            torchBtn.className = 'btn outline';
            torchBtn.textContent = 'Lampe';
            torchBtn.addEventListener('click', async ()=>{
              const s = track.getSettings();
              const next = !s.torch;
              await track.applyConstraints({ advanced:[{ torch: next }] });
            });
            document.getElementById('scanBox').appendChild(torchBtn);
          }
        }
      } catch(_) {}
    }catch(e){
      console.error(e);
      scanStatus.textContent = 'Impossible d‚Äôacc√©der √† la cam√©ra. V√©rifiez les permissions.';
    }
  }


  async function stopScanner(keepStream=true){
    try{
      // BrowserMultiFormatReader.reset() coupe le flux ; pour √©viter les re-prompts,
      // on NE le fait pas tant qu‚Äôon reste sur la page. On ‚Äúg√®le‚Äù via scanning=false.
      scanning = false;
      if (!keepStream){
        reader.reset(); // coupe totalement (utiliser si vous quittez la page)
      }
    }catch(e){ console.warn(e); }
  }

  switchBtn.addEventListener('click', async ()=>{
    // bascule entre cam√©ras : on coupe le flux et on relance sur l‚Äôautre device
    reader.reset(); // ici volontaire: on change de device ‚Üí nouveau getUserMedia
    const devs = devicesCache.length ? devicesCache : await listCameras();
    if (!devs.length){ scanStatus.textContent = 'Aucune cam√©ra.'; return; }
    const idx = devs.findIndex(d=>d.deviceId===currentDeviceId);
    const next = devs[(idx+1) % devs.length];
    currentDeviceId = next.deviceId;
    localStorage.setItem(LS_CAM_ID, currentDeviceId);
    startScanner();
  });

  amountForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    startScanner(); // user gesture ‚Üí aide iOS √† autoriser la cam√©ra
  });

  // ========= API =========
  async function fetchClientByCode(code){
    const url = USE_BY_CODE_ROUTE
      ? `${API}/api/clients/by-code/${encodeURIComponent(code)}`
      : `${API}/api/clients?code_public=${encodeURIComponent(code)}`;
    const r = await fetch(url);
    if (!r.ok) throw new Error('Code inconnu');
    return await r.json();
  }

  async function postTransaction(client, amount_cents){
    const txId = 'tx_' + Date.now();
    const payload = {
      id: txId,
      client_id: client.id,
      cashier_id: CASHIER_ID,
      amount_cents,
      status: 'OK',
      note: 'Achat en caisse',
    };
    const r = await fetch(`${API}/api/transactions`, {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'X-Idempotency-Key': txId },
      body: JSON.stringify(payload),
    });
    const txt = await r.text(); let j={}; try{ j=JSON.parse(txt) }catch{}
    if (!r.ok) throw new Error(j.error||txt||'Erreur API');
    return j;
  }

  function showClient(cli){
    currentClient = cli;
    clientName.textContent = `${cli.first_name||''} ${cli.last_name||''}`.trim() || 'Client';
    clientCode.textContent = cli.code_public || '';
    clientBalance.textContent = euros(cli.balance);
    clientGifts.textContent = cli.gifts_count || 0;
    clientCard.style.display = 'block';
  }

  
  // Fallback manuel
  manualBtn.addEventListener('click', async ()=>{
    const code = (codeInput.value||'').trim().toUpperCase();
    if (!code){
      uiMsg.textContent='Entrez un code.'; 
      uiMsg.className='err'; 
      return;
    }
    const amount_cents = validAmount();
    if (!amount_cents){
      uiMsg.textContent='Entrez le montant avant de valider.'; 
      uiMsg.className='err'; 
      return;
    }
  
    try{
      // anti-rescan 15s seulement pour le m√™me code (coh√©rent avec le scan cam√©ra)
      const now = Date.now();
      const last = lastScan.get(code) || 0;
      if (now - last < COOLDOWN_MS){
        uiMsg.textContent = 'M√™me client scann√© r√©cemment ‚Äî patientez quelques secondes.';
        uiMsg.className = 'err';
        return;
      }
      lastScan.set(code, now);
  
      localStorage.setItem(LS_LAST_AMOUNT, String(amountInput.value));
  
      // 1) R√©cup√©rer le client
      const cli = await fetchClientByCode(code);
      showClient(cli);
      const fullname = `${cli.first_name || ''} ${cli.last_name || ''}`.trim() || 'Client';
      showOverlay(fullname); // affiche le nom au centre
  
      // 2) Enregistrer la transaction
      await postTransaction(cli, amount_cents);
  
      // 3) Mettre √† jour l‚Äôaffichage
      cli.balance += amount_cents;
      clientBalance.textContent = (cli.balance/100).toFixed(2) + ' ‚Ç¨';
      formMsg.textContent = 'Achat enregistr√© ‚úîÔ∏è';
      formMsg.className = 'ok';
      scanStatus.textContent = 'Pr√™t pour un autre QR‚Ä¶';
    }catch(err){
      console.error(err);
      formMsg.textContent = 'Erreur: ' + err.message;
      formMsg.className = 'err';
    }
  });


  // Scanner un autre QR (sans perdre la permission)
  scanAgainBtn.addEventListener('click', ()=>{
    clientCard.style.display = 'none';
    formMsg.textContent = '';
    scanning = true;
    scanStatus.textContent = 'Visez le QR‚Ä¶';
  });

  // Restaurer dernier montant saisi (gain de temps √† la caisse)
  const last = localStorage.getItem(LS_LAST_AMOUNT);
  if (last) amountInput.value = last;

  // iOS : ne rien lancer automatiquement, attendre le clic sur ‚ÄúD√©marrer le scan‚Äù
  // Android/Chrome aussi : ce clic sert de ‚Äúuser gesture‚Äù ‚Üí pas de popup √† chaque fois.
</script>
</body>
</html>
