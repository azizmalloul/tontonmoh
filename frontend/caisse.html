<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Caisse ‚Äî Scanner un QR</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
<header class="container center">
  <img src="./assets/logo.png" alt="Chez Tonton Moh" class="logo" />
  <h1>Caisse ‚Äî Montant puis Scan QR</h1>
</header>

<main class="container">
  <!-- SECTION 1 ‚Äî visible au d√©part -->
  <section id="formSection" class="card">
    <h2>1) Montant de l‚Äôachat</h2>
    <form id="amountForm" class="kv">
      <label for="amount">Montant (‚Ç¨)</label>
      <input id="amount" type="number" step="0.01" min="0.01" required />
      <div class="row">
        <button id="startBtn" class="btn" type="submit">D√©marrer le scan</button>
        <button id="switchBtn" class="btn outline" type="button" title="Cam√©ra avant/arri√®re">Basculer cam√©ra</button>
      </div>
      <p class="tip">Entrez le montant puis scannez le QR du client. Le passage caisse sera enregistr√© automatiquement.</p>
      <p id="uiMsg" class="muted"></p>
    </form>

    <hr class="muted" />

    <h3>Code manuel (si cam√©ra indisponible)</h3>
    <div class="row">
      <input id="codeInput" type="text" placeholder="Code public (ex: RKDZDR)" />
      <button id="manualBtn" class="btn" type="button">Valider avec ce code</button>
    </div>
    <p class="tip"><small>Astuce : le QR contient le code public (6 caract√®res). Vous pouvez le saisir ici.</small></p>
  </section>

  <!-- SECTION 2 ‚Äî cach√©e, remplace la section 1 pendant le scan -->
  <section id="scanSection" class="card hidden">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0">2) Scanner le QR</h2>
      <button id="backBtn" class="btn outline" type="button">‚üµ Retour</button>
    </div>

    <div id="scanBox">
      <video id="preview" playsinline muted></video>
      <div id="overlayName" class="overlay-name"></div>
      <p id="scanStatus" class="muted">Visez le QR‚Ä¶</p>
    </div>

    <div id="clientCard" class="card" style="display:none">
      <h3 id="clientName">Client</h3>
      <button id="adminBtn" class="btn outline" type="button" style="float:right; margin-top:-6px;">
        ‚öôÔ∏è Admin
      </button>
      <p class="muted kv">Code : <b id="clientCode"></b></p>
      <p class="muted kv">Solde cumul√© : <b id="clientBalance">0,00 ‚Ç¨</b> ‚Äî Cadeaux : <b id="clientGifts">0</b></p>
      <p id="formMsg" class="muted"></p>
    </div>
  </section>

  <!-- Admin panel (hidden) -->
  <section id="adminPanel" class="card hidden">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0">Compte client (Admin)</h2>
      <div class="row">
        <button id="adminClose" class="btn outline" type="button">Fermer</button>
      </div>
    </div>
  
    <div id="adminInfo" class="kv">
      <p><b id="adminName">‚Äî</b></p>
      <p class="muted">Code : <b id="adminCode">‚Äî</b></p>
    </div>
  
    <hr class="muted"/>
  
    <h3>Ajuster cumul / cadeaux</h3>
    <form id="adminForm" class="grid">
      <div>
        <label for="adminBalance">Cumul (en ‚Ç¨)</label>
        <input id="adminBalance" type="number" step="0.01" min="0" />
      </div>
      <div>
        <label for="adminGifts">Cadeaux (compteur)</label>
        <input id="adminGifts" type="number" min="0" />
      </div>
      <div style="grid-column:1/-1" class="row">
        <input id="adminReason" type="text" placeholder="Motif de l'ajustement (ex: cadeau remis / correction saisie)" style="flex:1"/>
        <button id="adminSave" class="btn" type="submit">Enregistrer l‚Äôajustement</button>
      </div>
      <p id="adminMsg" class="muted"></p>
    </form>
  
    <hr class="muted"/>
  
    <h3>Derni√®res op√©rations</h3>
    <div id="adminTxList" class="kv"></div>
  </section>

</main>

<!-- Librairie scanner -->
<script src="https://unpkg.com/@zxing/browser@latest"></script>
<script>
/* ====== PARAMS ====== */
const API = 'https://tontonmoh-api.azizekarma.workers.dev';
const USE_BY_CODE_ROUTE = true;
const CASHIER_ID = 'cash_001';
const LS_CAM_ID = 'tm_camera_id';
const LS_LAST_AMOUNT = 'tm_last_amount';
const COOLDOWN_MS = 15000;

/* ====== EL√âMENTS ====== */
const formSection = document.getElementById('formSection');
const scanSection = document.getElementById('scanSection');

const amountForm  = document.getElementById('amountForm');
const amountInput = document.getElementById('amount');
const startBtn    = document.getElementById('startBtn');
const switchBtn   = document.getElementById('switchBtn');
const uiMsg       = document.getElementById('uiMsg');

const codeInput   = document.getElementById('codeInput');
const manualBtn   = document.getElementById('manualBtn');

const backBtn     = document.getElementById('backBtn');
const video       = document.getElementById('preview');
const scanStatus  = document.getElementById('scanStatus');
const overlayName = document.getElementById('overlayName');

const clientCard    = document.getElementById('clientCard');
const clientName    = document.getElementById('clientName');
const clientCode    = document.getElementById('clientCode');
const clientBalance = document.getElementById('clientBalance');
const clientGifts   = document.getElementById('clientGifts');
const formMsg       = document.getElementById('formMsg');

/* ====== √âTAT ====== */
const reader = new ZXingBrowser.BrowserQRCodeReader();
let devicesCache = [];
let currentDeviceId = localStorage.getItem(LS_CAM_ID) || null;
let busy = false;
let queuedNext = null;
const lastScan = new Map();

const ADMIN_KEY_LS = 'tm_admin_key';        // on m√©morise la cl√© admin localement
let currentClient = null;                    // ‚Üê on suit le client courant

const adminBtn     = document.getElementById('adminBtn');
const adminPanel   = document.getElementById('adminPanel');
const adminClose   = document.getElementById('adminClose');
const adminForm    = document.getElementById('adminForm');
const adminName    = document.getElementById('adminName');
const adminCode    = document.getElementById('adminCode');
const adminBalance = document.getElementById('adminBalance');
const adminGifts   = document.getElementById('adminGifts');
const adminReason  = document.getElementById('adminReason');
const adminMsg     = document.getElementById('adminMsg');
const adminTxList  = document.getElementById('adminTxList');



/* ====== UTILS ====== */
function euros(c){ return (Number(c||0)/100).toFixed(2) + ' ‚Ç¨'; }
function validAmount(){
  const v = parseFloat(String(amountInput.value).replace(',','.'));
  return (v && v>0) ? Math.round(v*100) : 0;
}
function showOverlay(text){
  overlayName.textContent = text;
  overlayName.classList.add('show');
  clearTimeout(showOverlay._t);
  showOverlay._t = setTimeout(()=>overlayName.classList.remove('show'), 1800);
}
async function listCameras(){
  const list = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
  devicesCache = list;
  return list;
}
function pickRearCamera(devices){
  if (currentDeviceId && devices.some(d=>d.deviceId===currentDeviceId)) return currentDeviceId;
  const re = /(back|arri√®re|rear|environment)/i;
  const cand = devices.find(d=>re.test(d.label));
  return (cand?.deviceId) || (devices[devices.length-1]||devices[0])?.deviceId || null;
}
async function warmUpCameraPermission(){
  try { const s = await navigator.mediaDevices.getUserMedia({ video:true, audio:false }); s.getTracks().forEach(t=>t.stop()); } catch(_) {}
}
// petit bip √† chaque scan valid√©
function beep(){
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type='square';
    o.frequency.value = 880;
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.18);
    o.connect(g); g.connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime + 0.2);
  }catch(_){ /* pas grave si audio bloqu√© */ }
}

/* ====== API ====== */
async function fetchClientByCode(code){
  const url = USE_BY_CODE_ROUTE
    ? `${API}/api/clients/by-code/${encodeURIComponent(code)}`
    : `${API}/api/clients?code_public=${encodeURIComponent(code)}`;
  const r = await fetch(url);
  if (!r.ok) throw new Error('Code inconnu');
  return await r.json();
}
async function postTransaction(cli, amount_cents){
  const txId = 'tx_' + Date.now();
  const r = await fetch(`${API}/api/transactions`, {
    method: 'POST',
    headers: { 'Content-Type':'application/json', 'X-Idempotency-Key': txId },
    body: JSON.stringify({
      id: txId,
      client_id: cli.id,
      cashier_id: CASHIER_ID,
      amount_cents,
      status: 'OK',
      note: 'Achat en caisse'
    }),
  });
  const txt = await r.text(); let j={}; try{ j=JSON.parse(txt) }catch{}
  if (!r.ok) throw new Error(j.error||txt||'Erreur API');
  // j = { ok:true, balance_cents: number, gifts_count: number }
  return j;
}

async function fetchClientFull(clientId){
  const r = await fetch(`${API}/api/clients/${encodeURIComponent(clientId)}/full`);
  if(!r.ok) throw new Error('Impossible de charger le compte client');
  return await r.json(); // { client:{...}, balance:{...}, transactions:[...] }
}

async function adminAdjustBalance(clientId, newBalanceCents, newGiftsCount, reason, cashierId){
  const adminKey = localStorage.getItem(ADMIN_KEY_LS) || '';
  if (!adminKey) throw new Error('Cl√© admin manquante');

  const r = await fetch(`${API}/api/admin/balances/adjust`, {
    method: 'POST',
    headers: {
      'Content-Type':'application/json',
      'X-Admin-Key': adminKey
    },
    body: JSON.stringify({
      client_id: clientId,
      set_balance_cents: newBalanceCents,
      set_gifts_count: newGiftsCount,
      reason: reason || '',
      cashier_id: cashierId || CASHIER_ID
    })
  });
  const j = await r.json().catch(()=>({}));
  if(!r.ok || !j.ok){
    throw new Error(j.error ? `Erreur admin: ${j.error}` : 'Ajustement refus√©');
  }
  return j; // { ok:true, balance_cents, gifts_count }
}



/* ====== UI CLIENT ====== */
function showClient(cli){
  currentClient = cli; // <-- m√©moriser
  clientName.textContent = `${cli.first_name||''} ${cli.last_name||''}`.trim() || 'Client';
  clientCode.textContent = cli.code_public || '';
  clientBalance.textContent = euros(cli.balance);
  clientGifts.textContent = cli.gifts_count || 0;
  clientCard.style.display = 'block';

  // afficher le bouton admin si une cl√© existe d√©j√† en local
  const hasKey = !!localStorage.getItem(ADMIN_KEY_LS);
  adminBtn.style.display = hasKey ? 'inline-block' : 'inline-block'; // on le montre toujours; la cl√© sera demand√©e au clic
}


/* ====== SCAN ====== */
async function startScanner(){
  const amountCents = validAmount();
  if (!amountCents){ uiMsg.textContent='Entrez le montant avant de scanner.'; uiMsg.className='error'; return; }
  uiMsg.textContent=''; uiMsg.className='muted';

  // Remplace section 1 par section 2
  formSection.classList.add('hidden');
  scanSection.classList.remove('hidden');

  try{
    await warmUpCameraPermission();

    let devices = await listCameras();
    if (!devices.length){ await new Promise(r=>setTimeout(r,150)); devices = await listCameras(); }
    if (!devices.length){ scanStatus.textContent='Aucune cam√©ra d√©tect√©e (permission ?)'; return; }

    currentDeviceId = pickRearCamera(devices);
    if (currentDeviceId) localStorage.setItem(LS_CAM_ID, currentDeviceId);

    const constraints = {
      video: currentDeviceId ? {
        deviceId: { exact: currentDeviceId },
        width:{ ideal:1280 }, height:{ ideal:720 },
        advanced:[{ focusMode:'continuous' },{ focusMode:'auto' }]
      } : {
        facingMode:{ ideal:'environment' },
        width:{ ideal:1280 }, height:{ ideal:720 },
        advanced:[{ focusMode:'continuous' },{ focusMode:'auto' }]
      },
      audio:false
    };

    scanStatus.textContent = 'Scanner pr√™t. Visez le QR‚Ä¶';

    await reader.decodeFromConstraints(constraints, video, async (result, err)=>{
      if (err && !(err instanceof ZXingBrowser.NotFoundException)) return;
      if (!result) return;

      const code = result.getText().trim().toUpperCase();
      const now  = Date.now();

      const last = lastScan.get(code)||0;
      if (now - last < COOLDOWN_MS) return;

      if (busy){
        if (queuedNext !== code){ queuedNext = code; showOverlay('Patienter‚Ä¶'); }
        return;
      }

      busy = true;
      lastScan.set(code, now);
      showOverlay(code);

      try{
        localStorage.setItem(LS_LAST_AMOUNT, String(amountInput.value));

        const cli = await fetchClientByCode(code);
        showClient(cli);
        showOverlay(`${cli.first_name||''} ${cli.last_name||''}`.trim() || 'Client');

        const amount_cents = validAmount();
        const res = await postTransaction(cli, amount_cents);
        // Utiliser ce que calcule le serveur (cumul d√©j√† d√©cr√©ment√© par paliers de 80‚Ç¨)
        clientBalance.textContent = euros(res.balance_cents);
        clientGifts.textContent   = res.gifts_count;
        formMsg.textContent = 'Achat enregistr√© ‚úîÔ∏è';
        formMsg.className = 'success';
        scanStatus.textContent = 'Pr√™t pour un autre QR‚Ä¶';
        beep();
                        
      }catch(e){
        console.error(e);
        formMsg.textContent = 'Erreur: ' + e.message;
        formMsg.className = 'error';
      }finally{
        busy = false;

        if (queuedNext){
          const nextCode = queuedNext; queuedNext = null;
          const now2 = Date.now();
          if ((now2 - (lastScan.get(nextCode)||0)) >= COOLDOWN_MS){
            lastScan.set(nextCode, now2);
            try{
              const cli2 = await fetchClientByCode(nextCode);
              showClient(cli2);
              showOverlay(`${cli2.first_name||''} ${cli2.last_name||''}`.trim() || 'Client');
        
              const amount_cents2 = validAmount();
              const res2 = await postTransaction(cli2, amount_cents2);
        
              // üîÅ utiliser la r√©ponse serveur (apr√®s application du palier 80‚Ç¨)
              clientBalance.textContent = euros(res2.balance_cents);
              clientGifts.textContent   = res2.gifts_count;
        
              formMsg.textContent = 'Achat enregistr√© ‚úîÔ∏è';
              formMsg.className = 'success';
              scanStatus.textContent = 'Pr√™t pour un autre QR‚Ä¶';
              beep();
            }catch(e2){
              console.error(e2);
              formMsg.textContent = 'Erreur: ' + e2.message;
              formMsg.className = 'error';
            }
          }
        }
      }
    });

    // Ajout lampe si dispo
    try{
      const track = video.srcObject ? video.srcObject.getVideoTracks()[0] : null;
      const caps = track?.getCapabilities?.();
      if (caps && 'torch' in caps && !document.getElementById('torchBtn')){
        const torchBtn = document.createElement('button');
        torchBtn.id='torchBtn'; torchBtn.type='button';
        torchBtn.className='btn outline'; torchBtn.textContent='Lampe';
        torchBtn.addEventListener('click', async ()=>{
          const s = track.getSettings();
          await track.applyConstraints({ advanced:[{ torch: !s.torch }] });
        });
        document.getElementById('scanBox').appendChild(torchBtn);
      }
    }catch(_){}
  }catch(e){
    console.error(e);
    scanStatus.textContent = 'Impossible d‚Äôacc√©der √† la cam√©ra. V√©rifiez les permissions.';
  }
}

function stopScanner(fully=true){
  try{ if (fully) reader.reset(); }catch(_){}
  // r√©-affiche la section 1
  scanSection.classList.add('hidden');
  formSection.classList.remove('hidden');
  clientCard.style.display='none';
  formMsg.textContent='';
  scanStatus.textContent='Visez le QR‚Ä¶';
}

/* ====== √âV√âNEMENTS ====== */
amountForm.addEventListener('submit', (e)=>{ e.preventDefault(); startScanner(); });

switchBtn.addEventListener('click', async ()=>{
  let devs = devicesCache.length ? devicesCache : await listCameras();
  if (!devs.length){ uiMsg.textContent='Aucune cam√©ra.'; uiMsg.className='error'; return; }
  const idx = devs.findIndex(d=>d.deviceId===currentDeviceId);
  const next = devs[(idx+1) % devs.length];
  currentDeviceId = next.deviceId;
  localStorage.setItem(LS_CAM_ID, currentDeviceId);
  uiMsg.textContent = 'Cam√©ra s√©lectionn√©e. Cliquez sur ‚ÄúD√©marrer le scan‚Äù.';
  uiMsg.className = 'muted';
  if (!scanSection.classList.contains('hidden')){ reader.reset(); startScanner(); }
});

backBtn.addEventListener('click', ()=> stopScanner(true));

manualBtn.addEventListener('click', async ()=>{
  const code = (codeInput.value||'').trim().toUpperCase();
  if (!code){ uiMsg.textContent='Entrez un code.'; uiMsg.className='error'; return; }
  const amount_cents = validAmount();
  if (!amount_cents){ uiMsg.textContent='Entrez le montant avant de valider.'; uiMsg.className='error'; return; }

  try{
    const now = Date.now();
    const last = lastScan.get(code)||0;
    if (now - last < COOLDOWN_MS){
      uiMsg.textContent = 'M√™me client scann√© r√©cemment ‚Äî patientez quelques secondes.';
      uiMsg.className = 'error';
      return;
    }
    lastScan.set(code, now);

    localStorage.setItem(LS_LAST_AMOUNT, String(amountInput.value));

    // on passe √† la section 2 pour afficher la fiche
    formSection.classList.add('hidden');
    scanSection.classList.remove('hidden');

    const cli = await fetchClientByCode(code);
    showClient(cli);
    showOverlay(`${cli.first_name||''} ${cli.last_name||''}`.trim() || 'Client');

    const r = await postTransaction(cli, amount_cents);
    clientBalance.textContent = euros(r.balance_cents);
    clientGifts.textContent   = r.gifts_count;
    formMsg.textContent = 'Achat enregistr√© ‚úîÔ∏è';
    formMsg.className = 'success';
    scanStatus.textContent = 'Vous pouvez scanner un autre QR‚Ä¶';
    beep();
  }catch(err){
    console.error(err);
    formMsg.textContent = 'Erreur: ' + err.message;
    formMsg.className = 'error';
  }
});

adminBtn.addEventListener('click', async ()=>{
  try{
    if(!currentClient) return;

    // demander la cl√© admin si absente
    let key = localStorage.getItem(ADMIN_KEY_LS);
    if(!key){
      key = prompt('Cl√© Admin ?');
      if(!key) return; // annul√©
      localStorage.setItem(ADMIN_KEY_LS, key);
    }

    // charger la vue compl√®te
    adminMsg.textContent = 'Chargement‚Ä¶';
    const full = await fetchClientFull(currentClient.id);

    const name = `${full.client.first_name||''} ${full.client.last_name||''}`.trim();
    adminName.textContent = name || 'Client';
    adminCode.textContent = full.client.code_public || '';

    // valeurs actuelles
    const balCents = Number(full.balance?.euro_cents_accumulated || 0);
    const gifts    = Number(full.balance?.gifts_count || 0);
    adminBalance.value = (balCents/100).toFixed(2);
    adminGifts.value   = gifts;

    // historique
    adminTxList.innerHTML = (full.transactions||[]).map(t=>{
      const dt = (t.created_at||'').replace('T',' ').replace('Z','');
      const amt = (Number(t.amount_cents||0)/100).toFixed(2)+' ‚Ç¨';
      return `<p class="muted"><b>${dt}</b> ‚Äî ${t.status} ‚Äî ${amt} ‚Äî <i>${t.note||''}</i></p>`;
    }).join('') || '<p class="muted">Aucune op√©ration r√©cente.</p>';

    adminMsg.textContent = '';
    // montrer le panneau
    scanSection.classList.add('hidden');
    formSection.classList.add('hidden');
    adminPanel.classList.remove('hidden');
  }catch(e){
    console.error(e);
    alert(e.message || String(e));
  }
});

adminClose.addEventListener('click', ()=>{
  adminPanel.classList.add('hidden');
  // revenir √† la section de scan (si elle √©tait affich√©e)
  scanSection.classList.remove('hidden');
});

adminForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  try{
    if(!currentClient) return;
    adminMsg.textContent = 'Enregistrement‚Ä¶';

    const eurosStr = String(adminBalance.value || '0').replace(',','.');
    const cents = Math.max(0, Math.round(parseFloat(eurosStr||'0')*100));
    const gifts = Math.max(0, parseInt(adminGifts.value||'0', 10));
    const reason = adminReason.value || '';

    const res = await adminAdjustBalance(currentClient.id, cents, gifts, reason, CASHIER_ID);

    // MAJ UI (panneau + fiche client)
    adminMsg.textContent = 'Ajustement enregistr√© ‚úîÔ∏è';
    clientBalance.textContent = euros(res.balance_cents);
    clientGifts.textContent   = res.gifts_count;

    // garder les valeurs coh√©rentes si on rouvre
    adminBalance.value = (res.balance_cents/100).toFixed(2);
    adminGifts.value   = res.gifts_count;
  }catch(err){
    console.error(err);
    adminMsg.textContent = 'Erreur: ' + err.message;
  }
});


// Pr√©-remplir dernier montant
const last = localStorage.getItem(LS_LAST_AMOUNT);
if (last) amountInput.value = last;
</script>
</body>
</html>
