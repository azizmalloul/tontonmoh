<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Caisse ‚Äî Scanner un QR</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
<header class="container center">
  <img src="./assets/logo.png" alt="Chez Tonton Moh" class="logo" />
  <h1>Caisse ‚Äî Montant puis Scan QR</h1>
</header>

<main class="container">
  <!-- SECTION 1 ‚Äî visible au d√©part -->
  <section id="formSection" class="card">
    <h2>1) Montant de l‚Äôachat</h2>
    <form id="amountForm" class="kv">
      <label for="amount">Montant (‚Ç¨)</label>
      <input id="amount" type="number" step="0.01" min="0.01" required />
      <div class="row">
        <button id="startBtn" class="btn" type="submit">D√©marrer le scan</button>
        
        <button id="clientsBtn" class="btn outline" type="button">Liste des clients</button>
      </div>
      <p class="tip">Entrez le montant puis scannez le QR du client. Le passage caisse sera enregistr√© automatiquement.</p>
      <p id="uiMsg" class="muted"></p>
    </form>

    <hr class="muted" />

    <h3>Code manuel (si cam√©ra indisponible)</h3>
    <div class="row">
      <input id="codeInput" type="text" placeholder="Code public (ex: RKDZDR)" />
      <button id="manualBtn" class="btn" type="button">Valider avec ce code</button>
    </div>
    <p class="tip">
      <small>
        Astuce : le QR contient le code public (6 caract√®res). Vous pouvez le saisir ici si la cam√©ra ne fonctionne pas.
      </small>
    </p>
  </section>

  <!-- SECTION 2 ‚Äî cach√©e, remplace la section 1 pendant le scan -->
  <section id="scanSection" class="card hidden">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0">2) Scanner le QR</h2>
    
      <div class="row" style="gap:10px">
        <!-- Basculer cam√©ra (2 fl√®ches) -->
        <button id="switchBtn" class="icon-btn" type="button" title="Basculer cam√©ra">
          <img
            src="./assets/icon_switch_camera.png"
            alt="Basculer cam√©ra"
            class="icon-img"
          />
        </button>
    
        <!-- Retour (fl√®che demi-cercle) -->
        <button id="backBtn" class="icon-btn" type="button" title="Retour">
          <img
            src="./assets/icon_retour_arriere.png"
            alt="Retour"
            class="icon-img"
          />
        </button>
      </div>
    </div>

    <div id="scanBox">
      <video id="preview" playsinline muted></video>
      <div id="overlayName" class="overlay-name"></div>
      <p id="scanStatus" class="muted">Visez le QR‚Ä¶</p>
    </div>

    <div id="clientCard" class="card" style="display:none">
      <h3 id="clientName">Client</h3>
      <button id="adminBtn" class="btn outline" type="button" style="float:right; margin-top:-6px;">
        ‚öôÔ∏è Admin
      </button>
      <p class="muted kv">Code : <b id="clientCode"></b></p>

      
      <p class="muted kv">
        Cumul achats : <b id="clientTotal">0,00 ‚Ç¨</b>
        ‚Äî Bonus dispo : <b id="clientBonus">0,00 ‚Ç¨</b>
      </p>
      
      <label class="checkbox" style="margin-top:10px">
        <input id="useBonus" type="checkbox" />
        Utiliser mon bonus maintenant
      </label>
      
      <div class="row" style="margin-top:10px">
        <button id="payBtn" class="btn" type="button">Encaisser</button>
      </div>
      
            
      <p id="formMsg" class="muted"></p>
    </div>
  </section>

  <!-- Admin panel (hidden) -->
  <section id="adminPanel" class="card hidden">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0">Compte client (Admin)</h2>
      <div class="row">
        <button id="adminClose" class="btn outline" type="button">Fermer</button>
      </div>
    </div>
  
    <div id="adminInfo" class="kv">
      <p><b id="adminName">‚Äî</b></p>
      <p class="muted">Code : <b id="adminCode">‚Äî</b></p>
    </div>
  
    <hr class="muted"/>
  
    <h3>Ajuster cumul / cadeaux</h3>
    <form id="adminForm" class="grid">
      <div>
        <label for="adminBalance">Cumul (en ‚Ç¨)</label>
        <input id="adminBalance" type="number" step="0.01" min="0" />
      </div>
      <div>
        <label for="adminGifts">Cadeaux (compteur)</label>
        <input id="adminGifts" type="number" min="0" />
      </div>
      <div style="grid-column:1/-1" class="row">
        <input id="adminReason" type="text" placeholder="Motif de l'ajustement (ex: cadeau remis / correction saisie)" style="flex:1"/>
        <button id="adminSave" class="btn" type="submit">Enregistrer l‚Äôajustement</button>
      </div>
      <p id="adminMsg" class="muted"></p>
    </form>
  
    <hr class="muted"/>
  
    <h3>Derni√®res op√©rations</h3>
    <div id="adminTxList" class="kv"></div>
  </section>

</main>

<!-- Librairie scanner -->
<script src="https://unpkg.com/@zxing/browser@latest"></script>
<script>
/* ====== PARAMS ====== */
const API = 'https://tontonmoh-api.azizekarma.workers.dev';
const USE_BY_CODE_ROUTE = true;
const CASHIER_ID = 'cash_001';
const LS_CAM_ID = 'tm_camera_id';
const LS_LAST_AMOUNT = 'tm_last_amount';
const COOLDOWN_MS = 15000;

/* ====== EL√âMENTS ====== */
const formSection = document.getElementById('formSection');
const scanSection = document.getElementById('scanSection');

const amountForm  = document.getElementById('amountForm');
const amountInput = document.getElementById('amount');
const startBtn    = document.getElementById('startBtn');
const switchBtn   = document.getElementById('switchBtn');
const uiMsg       = document.getElementById('uiMsg');

const codeInput   = document.getElementById('codeInput');
const manualBtn   = document.getElementById('manualBtn');

const backBtn     = document.getElementById('backBtn');
const video       = document.getElementById('preview');
const scanStatus  = document.getElementById('scanStatus');
const overlayName = document.getElementById('overlayName');

const clientCard    = document.getElementById('clientCard');
const clientName    = document.getElementById('clientName');
const clientCode    = document.getElementById('clientCode');

const formMsg       = document.getElementById('formMsg');
const clientsBtn   = document.getElementById('clientsBtn');

const clientTotal  = document.getElementById('clientTotal');
const clientBonus  = document.getElementById('clientBonus');
const useBonus     = document.getElementById('useBonus');
const payBtn       = document.getElementById('payBtn');
let pendingClient  = null;



/* ====== √âTAT ====== */
const reader = new ZXingBrowser.BrowserQRCodeReader();
let devicesCache = [];
let currentDeviceId = localStorage.getItem(LS_CAM_ID) || null;
let busy = false;
let queuedNext = null;
const lastScan = new Map();

const ADMIN_KEY_LS = 'aziz';        // on m√©morise la cl√© admin localement
let currentClient = null;           // client courant

const adminBtn     = document.getElementById('adminBtn');
const adminPanel   = document.getElementById('adminPanel');
const adminClose   = document.getElementById('adminClose');
const adminForm    = document.getElementById('adminForm');
const adminName    = document.getElementById('adminName');
const adminCode    = document.getElementById('adminCode');
const adminBalance = document.getElementById('adminBalance');
const adminGifts   = document.getElementById('adminGifts');
const adminReason  = document.getElementById('adminReason');
const adminMsg     = document.getElementById('adminMsg');
const adminTxList  = document.getElementById('adminTxList');

let isSwitching = false;
let cameraWarmed = false;
const LS_FACING = 'tm_facing';
let preferredFacing = localStorage.getItem(LS_FACING) || 'environment'; // back par d√©faut

function pickByFacing(devices, facing){
  const reFront = /(front|user|avant)/i;
  const reBack  = /(back|rear|arri√®re|environment)/i;

  const re = (facing === 'user') ? reFront : reBack;
  const cand = devices.find(d => re.test(d.label || ''));
  return cand?.deviceId || null;
}

function pickDifferentDevice(devices, currentId){
  if (devices.length <= 1) return currentId || devices[0]?.deviceId || null;
  const other = devices.find(d => d.deviceId !== currentId);
  return other?.deviceId || devices[0]?.deviceId || null;
}


/* ====== UTILS ====== */
function euros(c){
  return (Number(c||0)/100)
    .toFixed(2)          // 12.50
    .replace('.', ',')   // 12,50
    + ' ‚Ç¨';
}

function validAmount(){
  const v = parseFloat(String(amountInput.value).replace(',','.'));
  return (v && v>0) ? Math.round(v*100) : 0;
}
function showOverlay(text){
  overlayName.textContent = text;
  overlayName.classList.add('show');
  clearTimeout(showOverlay._t);
  showOverlay._t = setTimeout(()=>overlayName.classList.remove('show'), 3000);
}
async function listCameras(){
  const list = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
  devicesCache = list;
  return list;
}
function pickRearCamera(devices){
  const re = /(back|arri√®re|rear|environment)/i;
  const cand = devices.find(d => re.test(d.label || ''));
  return cand?.deviceId || devices[devices.length - 1]?.deviceId || devices[0]?.deviceId || null;
}
async function warmUpCameraPermission(){
  try { const s = await navigator.mediaDevices.getUserMedia({ video:true, audio:false }); s.getTracks().forEach(t=>t.stop()); } catch(_) {}
}
function beep(){
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type='square';
    o.frequency.value = 880;
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.18);
    o.connect(g); g.connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime + 0.2);
  }catch(_){}
}

/* ====== API ====== */
async function fetchClientByCode(code){
  const url = USE_BY_CODE_ROUTE
    ? `${API}/api/clients/by-code/${encodeURIComponent(code)}`
    : `${API}/api/clients?code_public=${encodeURIComponent(code)}`;
  const r = await fetch(url);
  if (!r.ok) throw new Error('Code inconnu');
  return await r.json();
}
async function postTransaction(cli, amount_cents, use_bonus){
  const txId = 'tx_' + Date.now();
  const r = await fetch(`${API}/api/transactions`, {
    method: 'POST',
    headers: { 'Content-Type':'application/json', 'X-Idempotency-Key': txId },
    body: JSON.stringify({
      id: txId,
      client_id: cli.id,
      cashier_id: CASHIER_ID,
      amount_cents,
      status: 'OK',
      note: 'Achat en caisse',
      use_bonus: !!use_bonus
    }),
  });
  const txt = await r.text(); let j={}; try{ j=JSON.parse(txt) }catch{}
  if (!r.ok) throw new Error(j.error||txt||'Erreur API');
  return j;
}

async function fetchClientFull(clientId){
  const r = await fetch(`${API}/api/clients/${encodeURIComponent(clientId)}/full`);
  if(!r.ok) throw new Error('Impossible de charger le compte client');
  return await r.json();
}
async function adminAdjustBalance(clientId, newBalanceCents, newGiftsCount, reason, cashierId){
  const adminKey = localStorage.getItem(ADMIN_KEY_LS) || '';
  if (!adminKey) throw new Error('Cl√© admin manquante');

  const r = await fetch(`${API}/api/admin/balances/adjust`, {
    method: 'POST',
    headers: {
      'Content-Type':'application/json',
      'X-Admin-Key': adminKey
    },
    body: JSON.stringify({
      client_id: clientId,
      set_balance_cents: newBalanceCents,
      set_gifts_count: newGiftsCount,
      reason: reason || '',
      cashier_id: cashierId || CASHIER_ID
    })
  });
  const j = await r.json().catch(()=>({}));
  if(!r.ok || !j.ok){
    throw new Error(j.error ? `Erreur admin: ${j.error}` : 'Ajustement refus√©');
  }
  return j;
}

/* ====== UI CLIENT ====== */
function showClient(cli){
  currentClient = cli;
  pendingClient = cli;

  clientName.textContent = `${cli.first_name||''} ${cli.last_name||''}`.trim() || 'Client';
  clientCode.textContent = cli.code_public || '';

  clientTotal.textContent = euros(cli.total_spent_cents || 0);
  clientBonus.textContent = euros(cli.bonus_cents || 0);

  useBonus.checked = false;
  clientCard.style.display = 'block';
  adminBtn.style.display = 'inline-block';
}


/* ====== SCAN QR (cam√©ra) ====== */

const readerInstance = reader; // juste pour √™tre clair

async function startScanner(opts = {}) {
  const { forceDevice = false, keepUI = false } = opts;

  const amountCents = validAmount();
  if (!amountCents){ uiMsg.textContent='Entrez le montant avant de scanner.'; uiMsg.className='error'; return; }

  if (!keepUI) {
    formSection.classList.add('hidden');
    scanSection.classList.remove('hidden');
  }

  try{
    if (!cameraWarmed) {
      await warmUpCameraPermission();
      cameraWarmed = true;
    }

    let devices = await listCameras();
    if (!devices.length){ await new Promise(r=>setTimeout(r,150)); devices = await listCameras(); }
    if (!devices.length){ scanStatus.textContent='Aucune cam√©ra d√©tect√©e (permission ?)'; return; }

    // si on n'impose pas un device, on suit preferredFacing
    if (!forceDevice) {
      const byFacing = pickByFacing(devices, preferredFacing);
      if (byFacing) {
        currentDeviceId = byFacing;
      } else if (!currentDeviceId || !devices.some(d => d.deviceId === currentDeviceId)) {
        currentDeviceId = devices[0]?.deviceId || null;
      }
      if (currentDeviceId) localStorage.setItem(LS_CAM_ID, currentDeviceId);
    } else {
      // forceDevice=true : on garde currentDeviceId si possible
      if (!currentDeviceId || !devices.some(d => d.deviceId === currentDeviceId)) {
        const byFacing = pickByFacing(devices, preferredFacing);
        currentDeviceId = byFacing || devices[0]?.deviceId || null;
        if (currentDeviceId) localStorage.setItem(LS_CAM_ID, currentDeviceId);
      }
    }

    switchBtn.style.display = devices.length > 1 ? 'inline-flex' : 'none';

    const constraints = {
      video: currentDeviceId ? { deviceId: { exact: currentDeviceId } } : { facingMode:{ ideal:'environment' } },
      audio: false
    };

    scanStatus.textContent = 'Scanner pr√™t. Visez le QR‚Ä¶';

    await reader.decodeFromConstraints(constraints, video, async (result, err) => {
      if (err && !(err instanceof ZXingBrowser.NotFoundException)) return;
      if (!result) return;
    
      const code = result.getText().trim().toUpperCase();
      const now  = Date.now();
    
      const last = lastScan.get(code) || 0;
      if (now - last < COOLDOWN_MS) return;
    
      if (busy) return;
    
      busy = true;
      lastScan.set(code, now);
    
      try {
        // on m√©morise le dernier montant
        localStorage.setItem(LS_LAST_AMOUNT, String(amountInput.value));
    
        // on charge le client
        const cli = await fetchClientByCode(code);
        showClient(cli);
    
        const fullName = `${cli.first_name || ''} ${cli.last_name || ''}`.trim() || 'Client';
        showOverlay(fullName);
    
        // on attend que la caisse clique sur "Encaisser"
        formMsg.textContent  = 'Choisissez bonus ou non, puis cliquez ‚ÄúEncaisser‚Äù.';
        formMsg.className    = 'muted';
        scanStatus.textContent = 'En attente encaissement‚Ä¶';
        beep();
      } catch (e) {
        console.error(e);
        formMsg.textContent = 'Erreur: ' + e.message;
        formMsg.className   = 'error';
      } finally {
        busy = false;
      }
    });


    // Lampe
    try{
      const track = video.srcObject ? video.srcObject.getVideoTracks()[0] : null;
      const caps = track?.getCapabilities?.();
      if (caps && 'torch' in caps && !document.getElementById('torchBtn')){
        const torchBtn = document.createElement('button');
        torchBtn.id='torchBtn'; torchBtn.type='button';
        torchBtn.className='btn outline'; torchBtn.textContent='Lampe';
        torchBtn.addEventListener('click', async ()=>{
          const s = track.getSettings();
          await track.applyConstraints({ advanced:[{ torch: !s.torch }] });
        });
        document.getElementById('scanBox').appendChild(torchBtn);
      }
    }catch(_){}
  }catch(e){
    console.error(e);
    scanStatus.textContent = 'Impossible d‚Äôacc√©der √† la cam√©ra. V√©rifiez les permissions.';
  }
}

function stopScanner(fully=true){
  try{ if (fully) reader.reset(); }catch(_){}
  scanSection.classList.add('hidden');
  formSection.classList.remove('hidden');
  clientCard.style.display='none';
  formMsg.textContent='';
  scanStatus.textContent='Visez le QR‚Ä¶';
}

/* ====== √âV√âNEMENTS EXISTANTS ====== */
amountForm.addEventListener('submit', (e)=>{ e.preventDefault(); startScanner(); });

switchBtn.addEventListener('click', async () => {
  if (isSwitching) return;
  isSwitching = true;
  switchBtn.disabled = true;

  try {
    // üî• toggle facing (back <-> front)
    preferredFacing = (preferredFacing === 'environment') ? 'user' : 'environment';
    localStorage.setItem(LS_FACING, preferredFacing);

    // stop propre
    try { reader.reset(); } catch(_) {}
    try {
      const s = video.srcObject;
      if (s) s.getTracks().forEach(t => t.stop());
      video.srcObject = null;
    } catch(_) {}

    scanStatus.textContent = "Changement de cam√©ra‚Ä¶";

    // refresh devices apr√®s stop (important)
    const devs = await listCameras();
    if (!devs.length) { scanStatus.textContent = "Aucune cam√©ra."; return; }

    // ‚úÖ choisir directement la bonne cam√©ra (front/back)
    const wanted = pickByFacing(devs, preferredFacing);
    currentDeviceId = wanted || pickDifferentDevice(devs, currentDeviceId);
    if (currentDeviceId) localStorage.setItem(LS_CAM_ID, currentDeviceId);

    // petit d√©lai
    await new Promise(r => setTimeout(r, 10));
    
    // relance
    await startScanner({ forceDevice: true, keepUI: true });
    
    // fallback si Safari est lent
    if (!(video.srcObject && video.readyState >= 2)) {
    await new Promise(r => setTimeout(r, 120));
    try { reader.reset(); } catch(_) {}
    await startScanner({ forceDevice: true, keepUI: true });
  }

  } catch (e) {
    console.error(e);
    scanStatus.textContent = "Impossible de basculer la cam√©ra.";
  } finally {
    switchBtn.disabled = false;
    isSwitching = false;
  }
});

backBtn.addEventListener('click', ()=> stopScanner(true));

clientsBtn.addEventListener('click', () => {
  window.location.href = './liste_clients.html';
});

manualBtn.addEventListener('click', async () => {
  const code = (codeInput.value || '').trim().toUpperCase();
  if (!code) {
    uiMsg.textContent = 'Entrez un code.';
    uiMsg.className   = 'error';
    return;
  }
  const amount_cents = validAmount();
  if (!amount_cents) {
    uiMsg.textContent = 'Entrez le montant avant de valider.';
    uiMsg.className   = 'error';
    return;
  }

  try {
    const now  = Date.now();
    const last = lastScan.get(code) || 0;
    if (now - last < COOLDOWN_MS) {
      uiMsg.textContent = 'M√™me client scann√© r√©cemment ‚Äî patientez quelques secondes.';
      uiMsg.className   = 'error';
      return;
    }
    lastScan.set(code, now);

    localStorage.setItem(LS_LAST_AMOUNT, String(amountInput.value));

    formSection.classList.add('hidden');
    scanSection.classList.remove('hidden');

    const cli = await fetchClientByCode(code);
    showClient(cli);

    const fullName = `${cli.first_name || ''} ${cli.last_name || ''}`.trim() || 'Client';
    showOverlay(fullName);

    formMsg.textContent  = 'Choisissez bonus ou non, puis cliquez ‚ÄúEncaisser‚Äù.';
    formMsg.className    = 'muted';
    scanStatus.textContent = 'Vous pouvez maintenant cliquer sur ‚ÄúEncaisser‚Äù.';
    beep();
  } catch (err) {
    console.error(err);
    formMsg.textContent = 'Erreur: ' + err.message;
    formMsg.className   = 'error';
  }
});


/* ====== ADMIN UI (inchang√©) ====== */
adminBtn.addEventListener('click', async ()=>{
  try{
    if(!currentClient) return;
    let key = localStorage.getItem(ADMIN_KEY_LS);
    if(!key){
      key = prompt('Cl√© Admin ?');
      if(!key) return;
      localStorage.setItem(ADMIN_KEY_LS, key);
    }
    adminMsg.textContent = 'Chargement‚Ä¶';
    const full = await fetchClientFull(currentClient.id);

    const name = `${full.client.first_name||''} ${full.client.last_name||''}`.trim();
    adminName.textContent = name || 'Client';
    adminCode.textContent = full.client.code_public || '';

    const balCents = Number(full.balance?.euro_cents_accumulated || 0);
    const gifts    = Number(full.balance?.gifts_count || 0);
    adminBalance.value = (balCents/100).toFixed(2);
    adminGifts.value   = gifts;

    adminTxList.innerHTML = (full.transactions||[]).map(t=>{
      const dt = (t.created_at||'').replace('T',' ').replace('Z','');
      const amt = (Number(t.amount_cents||0)/100).toFixed(2)+' ‚Ç¨';
      return `<p class="muted"><b>${dt}</b> ‚Äî ${t.status} ‚Äî ${amt} ‚Äî <i>${t.note||''}</i></p>`;
    }).join('') || '<p class="muted">Aucune op√©ration r√©cente.</p>';

    adminMsg.textContent = '';
    scanSection.classList.add('hidden');
    formSection.classList.add('hidden');
    adminPanel.classList.remove('hidden');
  }catch(e){
    console.error(e);
    alert(e.message || String(e));
  }
});

adminClose.addEventListener('click', ()=>{
  adminPanel.classList.add('hidden');
  scanSection.classList.remove('hidden');
});

adminForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  try{
    if(!currentClient) return;
    adminMsg.textContent = 'Enregistrement‚Ä¶';

    const eurosStr = String(adminBalance.value || '0').replace(',','.');
    const cents = Math.max(0, Math.round(parseFloat(eurosStr||'0')*100));
    const gifts = Math.max(0, parseInt(adminGifts.value||'0', 10));
    const reason = adminReason.value || '';

    const res = await adminAdjustBalance(currentClient.id, cents, gifts, reason, CASHIER_ID);

    adminMsg.textContent = 'Ajustement enregistr√© ‚úîÔ∏è';
    clientBalance.textContent = euros(res.balance_cents);
    clientGifts.textContent   = res.gifts_count;
    adminBalance.value = (res.balance_cents/100).toFixed(2);
    adminGifts.value   = res.gifts_count;
  }catch(err){
    console.error(err);
    adminMsg.textContent = 'Erreur: ' + err.message;
  }
});

payBtn.addEventListener('click', async () => {
  try {
    if (!pendingClient) return;

    const amount_cents = validAmount();
    if (!amount_cents) {
      formMsg.textContent = 'Montant invalide.';
      formMsg.className   = 'error';
      return;
    }

    const use = useBonus.checked;

    // on garde l'ancien bonus pour calculer le "bonus gagn√©"
    const oldBonus = Number(pendingClient.bonus_cents || 0);

    const res = await postTransaction(pendingClient, amount_cents, use);

    const newBonus   = Number(res.bonus_cents || 0);
    const usedBonus  = Number(res.bonus_used_cents || 0);
    const paid       = Number(res.paid_cents != null ? res.paid_cents : amount_cents);
    const earned     = Math.max(0, newBonus - (oldBonus - usedBonus));

    // mettre √† jour le mod√®le local
    pendingClient.bonus_cents       = newBonus;
    pendingClient.total_spent_cents = Number(res.total_spent_cents || 0);

    // MAJ UI
    clientTotal.textContent = euros(pendingClient.total_spent_cents);
    clientBonus.textContent = euros(pendingClient.bonus_cents);

    const fullName = `${pendingClient.first_name || ''} ${pendingClient.last_name || ''}`.trim() || 'ce client';

    showOverlay(
      `‚úÖ Pay√© : ${euros(paid)}\n` +
      (usedBonus ? `üé´ Bonus utilis√© : ${euros(usedBonus)}\n` : '') +
      `üéÅ Bonus gagn√© : ${euros(earned)}\n` +
      `Pour ${fullName}`
    );

    formMsg.textContent   = 'Achat enregistr√© ‚úîÔ∏è';
    formMsg.className     = 'success';
    scanStatus.textContent = 'Pr√™t pour un autre client‚Ä¶';
    beep();

    // reset
    pendingClient   = null;
    clientCard.style.display = 'none';
    useBonus.checked = false;

  } catch (e) {
    formMsg.textContent = 'Erreur: ' + e.message;
    formMsg.className   = 'error';
  }
});



// Pr√©-remplir dernier montant
const last = localStorage.getItem(LS_LAST_AMOUNT);
if (last) amountInput.value = last;
</script>
</body>
</html>
