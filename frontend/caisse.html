<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Caisse — Scanner un QR</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
<header class="container center">
  <img src="./assets/logo.png" alt="Chez Tonton Moh" class="logo" />
  <h1>Caisse — Montant puis Scan QR</h1>
</header>

<main class="container">
  <!-- SECTION 1 — visible au départ -->
  <section id="formSection" class="card">
    <h2>1) Montant de l’achat</h2>
    <form id="amountForm" class="kv">
      <label for="amount">Montant (€)</label>
      <input id="amount" type="number" step="0.01" min="0.01" required />
      <div class="row">
        <button id="startBtn" class="btn" type="submit">Démarrer le scan</button>
        <button id="switchBtn" class="btn outline" type="button" title="Caméra avant/arrière">Basculer caméra</button>
      </div>
      <p class="tip">Entrez le montant puis scannez le QR du client. Le passage caisse sera enregistré automatiquement.</p>
      <p id="uiMsg" class="muted"></p>
    </form>

    <hr class="muted" />

    <h3>Code manuel (si caméra indisponible)</h3>
    <div class="row">
      <input id="codeInput" type="text" placeholder="Code public (ex: RKDZDR)" />
      <button id="manualBtn" class="btn" type="button">Valider avec ce code</button>
    </div>
    <p class="tip"><small>Astuce : le QR contient le code public (6 caractères). Vous pouvez le saisir ici.</small></p>
  </section>

  <!-- SECTION 2 — cachée, remplace la section 1 pendant le scan -->
  <section id="scanSection" class="card hidden">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0">2) Scanner le QR</h2>
      <button id="backBtn" class="btn outline" type="button">⟵ Retour</button>
    </div>

    <div id="scanBox">
      <video id="preview" playsinline muted></video>
      <div id="overlayName" class="overlay-name"></div>
      <p id="scanStatus" class="muted">Visez le QR…</p>
    </div>

    <div id="clientCard" class="card" style="display:none">
      <h3 id="clientName">Client</h3>
      <p class="muted kv">Code : <b id="clientCode"></b></p>
      <p class="muted kv">Solde cumulé : <b id="clientBalance">0,00 €</b> — Cadeaux : <b id="clientGifts">0</b></p>
      <p id="formMsg" class="muted"></p>
    </div>
  </section>
</main>

<!-- Librairie scanner -->
<script src="https://unpkg.com/@zxing/browser@latest"></script>
<script>
/* ====== PARAMS ====== */
const API = 'https://tontonmoh-api.azizekarma.workers.dev';
const USE_BY_CODE_ROUTE = true;
const CASHIER_ID = 'cash_001';
const LS_CAM_ID = 'tm_camera_id';
const LS_LAST_AMOUNT = 'tm_last_amount';
const COOLDOWN_MS = 15000;

/* ====== ELÉMENTS ====== */
const formSection = document.getElementById('formSection');
const scanSection = document.getElementById('scanSection');

const amountForm  = document.getElementById('amountForm');
const amountInput = document.getElementById('amount');
const startBtn    = document.getElementById('startBtn');
const switchBtn   = document.getElementById('switchBtn');
const uiMsg       = document.getElementById('uiMsg');

const codeInput   = document.getElementById('codeInput');
const manualBtn   = document.getElementById('manualBtn');

const backBtn     = document.getElementById('backBtn');
const video       = document.getElementById('preview');
const scanStatus  = document.getElementById('scanStatus');
const overlayName = document.getElementById('overlayName');

const clientCard    = document.getElementById('clientCard');
const clientName    = document.getElementById('clientName');
const clientCode    = document.getElementById('clientCode');
const clientBalance = document.getElementById('clientBalance');
const clientGifts   = document.getElementById('clientGifts');
const formMsg       = document.getElementById('formMsg');

/* ====== ÉTAT ====== */
const reader = new ZXingBrowser.BrowserQRCodeReader();
let devicesCache = [];
let currentDeviceId = localStorage.getItem(LS_CAM_ID) || null;
let busy = false;
let queuedNext = null;
const lastScan = new Map();

/* ====== UTILS ====== */
function euros(c){ return (Number(c||0)/100).toFixed(2) + ' €'; }
function validAmount(){
  const v = parseFloat(String(amountInput.value).replace(',','.'));
  return (v && v>0) ? Math.round(v*100) : 0;
}
function showOverlay(text){
  overlayName.textContent = text;
  overlayName.classList.add('show');
  clearTimeout(showOverlay._t);
  showOverlay._t = setTimeout(()=>overlayName.classList.remove('show'), 1800);
}
async function listCameras(){
  const list = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
  devicesCache = list;
  return list;
}
function pickRearCamera(devices){
  if (currentDeviceId && devices.some(d=>d.deviceId===currentDeviceId)) return currentDeviceId;
  const re = /(back|arrière|rear|environment)/i;
  const cand = devices.find(d=>re.test(d.label));
  return (cand?.deviceId) || (devices[devices.length-1]||devices[0])?.deviceId || null;
}
async function warmUpCameraPermission(){
  try { const s = await navigator.mediaDevices.getUserMedia({ video:true, audio:false }); s.getTracks().forEach(t=>t.stop()); } catch(_) {}
}
// petit bip à chaque scan validé
function beep(){
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type='square';
    o.frequency.value = 880;
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.18);
    o.connect(g); g.connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime + 0.2);
  }catch(_){ /* pas grave si audio bloqué */ }
}

/* ====== API ====== */
async function fetchClientByCode(code){
  const url = USE_BY_CODE_ROUTE
    ? `${API}/api/clients/by-code/${encodeURIComponent(code)}`
    : `${API}/api/clients?code_public=${encodeURIComponent(code)}`;
  const r = await fetch(url);
  if (!r.ok) throw new Error('Code inconnu');
  return await r.json();
}
async function postTransaction(cli, amount_cents){
  const txId = 'tx_' + Date.now();
  const r = await fetch(`${API}/api/transactions`, {
    method: 'POST',
    headers: { 'Content-Type':'application/json', 'X-Idempotency-Key': txId },
    body: JSON.stringify({
      id: txId,
      client_id: cli.id,
      cashier_id: CASHIER_ID,
      amount_cents,
      status: 'OK',
      note: 'Achat en caisse'
    }),
  });
  const txt = await r.text(); let j={}; try{ j=JSON.parse(txt) }catch{}
  if (!r.ok) throw new Error(j.error||txt||'Erreur API');
  // j = { ok:true, balance_cents: number, gifts_count: number }
  return j;
}


/* ====== UI CLIENT ====== */
function showClient(cli){
  clientName.textContent = `${cli.first_name||''} ${cli.last_name||''}`.trim() || 'Client';
  clientCode.textContent = cli.code_public || '';
  clientBalance.textContent = euros(cli.balance);
  clientGifts.textContent = cli.gifts_count || 0;
  clientCard.style.display = 'block';
}

/* ====== SCAN ====== */
async function startScanner(){
  const amountCents = validAmount();
  if (!amountCents){ uiMsg.textContent='Entrez le montant avant de scanner.'; uiMsg.className='error'; return; }
  uiMsg.textContent=''; uiMsg.className='muted';

  // Remplace section 1 par section 2
  formSection.classList.add('hidden');
  scanSection.classList.remove('hidden');

  try{
    await warmUpCameraPermission();

    let devices = await listCameras();
    if (!devices.length){ await new Promise(r=>setTimeout(r,150)); devices = await listCameras(); }
    if (!devices.length){ scanStatus.textContent='Aucune caméra détectée (permission ?)'; return; }

    currentDeviceId = pickRearCamera(devices);
    if (currentDeviceId) localStorage.setItem(LS_CAM_ID, currentDeviceId);

    const constraints = {
      video: currentDeviceId ? {
        deviceId: { exact: currentDeviceId },
        width:{ ideal:1280 }, height:{ ideal:720 },
        advanced:[{ focusMode:'continuous' },{ focusMode:'auto' }]
      } : {
        facingMode:{ ideal:'environment' },
        width:{ ideal:1280 }, height:{ ideal:720 },
        advanced:[{ focusMode:'continuous' },{ focusMode:'auto' }]
      },
      audio:false
    };

    scanStatus.textContent = 'Scanner prêt. Visez le QR…';

    await reader.decodeFromConstraints(constraints, video, async (result, err)=>{
      if (err && !(err instanceof ZXingBrowser.NotFoundException)) return;
      if (!result) return;

      const code = result.getText().trim().toUpperCase();
      const now  = Date.now();

      const last = lastScan.get(code)||0;
      if (now - last < COOLDOWN_MS) return;

      if (busy){
        if (queuedNext !== code){ queuedNext = code; showOverlay('Patienter…'); }
        return;
      }

      busy = true;
      lastScan.set(code, now);
      showOverlay(code);

      try{
        localStorage.setItem(LS_LAST_AMOUNT, String(amountInput.value));

        const cli = await fetchClientByCode(code);
        showClient(cli);
        showOverlay(`${cli.first_name||''} ${cli.last_name||''}`.trim() || 'Client');

        const amount_cents = validAmount();
        const res = await postTransaction(cli, amount_cents);
        // Utiliser ce que calcule le serveur (cumul déjà décrémenté par paliers de 80€)
        clientBalance.textContent = euros(res.balance_cents);
        clientGifts.textContent   = res.gifts_count;
        formMsg.textContent = 'Achat enregistré ✔️';
        formMsg.className = 'success';
        scanStatus.textContent = 'Prêt pour un autre QR…';
        beep();
                        
      }catch(e){
        console.error(e);
        formMsg.textContent = 'Erreur: ' + e.message;
        formMsg.className = 'error';
      }finally{
        busy = false;

        if (queuedNext){
          const nextCode = queuedNext; queuedNext = null;
          const now2 = Date.now();
          if ((now2 - (lastScan.get(nextCode)||0)) >= COOLDOWN_MS){
            lastScan.set(nextCode, now2);
            try{
              const cli2 = await fetchClientByCode(nextCode);
              showClient(cli2);
              showOverlay(`${cli2.first_name||''} ${cli2.last_name||''}`.trim() || 'Client');
              const amount_cents2 = validAmount();
              await postTransaction(cli2, amount_cents2);
              cli2.balance += amount_cents2;
              clientBalance.textContent = euros(cli2.balance);
              formMsg.textContent = 'Achat enregistré ✔️';
              formMsg.className = 'success';
              scanStatus.textContent = 'Prêt pour un autre QR…';
              beep();
            }catch(e2){
              console.error(e2);
              formMsg.textContent = 'Erreur: ' + e2.message;
              formMsg.className = 'error';
            }
          }
        }
      }
    });

    // Ajout lampe si dispo
    try{
      const track = video.srcObject ? video.srcObject.getVideoTracks()[0] : null;
      const caps = track?.getCapabilities?.();
      if (caps && 'torch' in caps && !document.getElementById('torchBtn')){
        const torchBtn = document.createElement('button');
        torchBtn.id='torchBtn'; torchBtn.type='button';
        torchBtn.className='btn outline'; torchBtn.textContent='Lampe';
        torchBtn.addEventListener('click', async ()=>{
          const s = track.getSettings();
          await track.applyConstraints({ advanced:[{ torch: !s.torch }] });
        });
        document.getElementById('scanBox').appendChild(torchBtn);
      }
    }catch(_){}
  }catch(e){
    console.error(e);
    scanStatus.textContent = 'Impossible d’accéder à la caméra. Vérifiez les permissions.';
  }
}

function stopScanner(fully=true){
  try{ if (fully) reader.reset(); }catch(_){}
  // ré-affiche la section 1
  scanSection.classList.add('hidden');
  formSection.classList.remove('hidden');
  clientCard.style.display='none';
  formMsg.textContent='';
  scanStatus.textContent='Visez le QR…';
}

/* ====== ÉVÉNEMENTS ====== */
amountForm.addEventListener('submit', (e)=>{ e.preventDefault(); startScanner(); });

switchBtn.addEventListener('click', async ()=>{
  let devs = devicesCache.length ? devicesCache : await listCameras();
  if (!devs.length){ uiMsg.textContent='Aucune caméra.'; uiMsg.className='error'; return; }
  const idx = devs.findIndex(d=>d.deviceId===currentDeviceId);
  const next = devs[(idx+1) % devs.length];
  currentDeviceId = next.deviceId;
  localStorage.setItem(LS_CAM_ID, currentDeviceId);
  uiMsg.textContent = 'Caméra sélectionnée. Cliquez sur “Démarrer le scan”.';
  uiMsg.className = 'muted';
  if (!scanSection.classList.contains('hidden')){ reader.reset(); startScanner(); }
});

backBtn.addEventListener('click', ()=> stopScanner(true));

manualBtn.addEventListener('click', async ()=>{
  const code = (codeInput.value||'').trim().toUpperCase();
  if (!code){ uiMsg.textContent='Entrez un code.'; uiMsg.className='error'; return; }
  const amount_cents = validAmount();
  if (!amount_cents){ uiMsg.textContent='Entrez le montant avant de valider.'; uiMsg.className='error'; return; }

  try{
    const now = Date.now();
    const last = lastScan.get(code)||0;
    if (now - last < COOLDOWN_MS){
      uiMsg.textContent = 'Même client scanné récemment — patientez quelques secondes.';
      uiMsg.className = 'error';
      return;
    }
    lastScan.set(code, now);

    localStorage.setItem(LS_LAST_AMOUNT, String(amountInput.value));

    // on passe à la section 2 pour afficher la fiche
    formSection.classList.add('hidden');
    scanSection.classList.remove('hidden');

    const cli = await fetchClientByCode(code);
    showClient(cli);
    showOverlay(`${cli.first_name||''} ${cli.last_name||''}`.trim() || 'Client');

    await postTransaction(cli, amount_cents);
    cli.balance += amount_cents;
    clientBalance.textContent = euros(cli.balance);
    formMsg.textContent = 'Achat enregistré ✔️';
    formMsg.className = 'success';
    scanStatus.textContent = 'Vous pouvez scanner un autre QR…';
    beep();
  }catch(err){
    console.error(err);
    formMsg.textContent = 'Erreur: ' + err.message;
    formMsg.className = 'error';
  }
});

// Pré-remplir dernier montant
const last = localStorage.getItem(LS_LAST_AMOUNT);
if (last) amountInput.value = last;
</script>
</body>
</html>
